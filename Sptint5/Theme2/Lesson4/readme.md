## Урок 4. Настроить маршрутизацию

Лан пати - это, конечно, круто. Но что делать, если хочется большего? (это шутка, можно вырезать). В этом уроке расскажем про маршрутизацию и маршрутизаторы, а если точнее про 
сетевую IP маршрутизацию и аппаратные маршрутизаторы.

Маршрутизация - это процесс передачи данных от отправителя к получателю в компьютерных сетях. 

Устройства, которое осуществляют маршрутизацию называют маршрутизаторами. Маршрутизаторы бывают аппаратными и программными.

Программные маршрутизаторы - это решения, где функции маршрутизатора виртуализированы и выполняются на обычном аппарате или виртуальной машине. Они обычно работают на стандартном
оборудовании, таком как серверы, и используют программное обеспечение для управления сетевым трафиком. 

Аппаратные маршрутизаторы - это физические устройства, специально разработанные для маршрутизации пакетов данных в компьютерных сетях. Они имеют специализированные процессоры, 
специфическое программное обеспечение и порты для подключения сетевых устройств. Аппаратные маршрутизаторы обычно обладают высокой производительностью, надежностью и обеспечивают
высокую пропускную способность в сети.

##### Как маршрутизатор передает данные между сетями

1. Получение пакета данных: 
   - Когда пакет данных приходит на маршрутизатор, он анализирует адрес назначения, чтобы определить, в какую сеть его нужно отправить.
   - Маршрутизатор проверяет свою таблицу маршрутизации, где записаны пути к различным сетям, для определения наилучшего пути для передачи данных.

2. Принятие решения о маршруте:
   - Основываясь на таблице маршрутизации, маршрутизатор выбирает оптимальный маршрут для доставки пакета данных к адресу назначения.
   - Если необходимо, маршрутизатор может применять различные алгоритмы маршрутизации (например, OSPF, RIP, BGP) для выбора наилучшего пути.

3. Передача пакета данных:
   - Маршрутизатор упаковывает пакет данных в новую оболочку (заголовок), содержащую информацию о пути следования.
   - Он передает пакет через подходящий интерфейс в сеть, где находится адрес назначения.

4. Пересылка через сети:
   - При перемещении через сеть маршрутизаторов (в том числе, если необходимо пересечь несколько маршрутизаторов), каждый следующий маршрутизатор принимает и передает пакет в соответствии с алгоритмом маршрутизации, пока пакет не достигнет своего адреса назначения.

5. Доставка к адресу назначения:
   - Последний маршрутизатор в цепочке маршрутизации доставляет пакет данных к адресу назначения в другой сети, после чего получатель может принять данные и отправить ответные пакеты.

#### Значение маршрутизатора для сетей
- Улучшение эффективности: Маршрутизаторы позволяют эффективно передавать данные между различными сегментами сети, выбирая оптимальные маршруты.
- Сегментация сетей: Маршрутизаторы помогают разделить сеть на отдельные сегменты, обеспечивая безопасность и контроль между ними.
- Подключение к внешним сетям: Маршрутизаторы обеспечивают возможность подключения к интернету и другим внешним сетям, обеспечивая связь с внешним миром.


  #### Маршрутизатор vs Коммутатор

  Чтобы внести ясность и не путаться в дальнейшем, давайте сравним маршрутизаторы и коммутаторы, чтобы понимать кто за что отвечает, и в чём различия:

<p align="center">
<img src="https://github.com/lexche/Testyp/assets/95694325/b51f6134-a053-4461-8aed-1b7cb3afc6da">
</p>

1. Функции:
   - Маршрутизатор: Работает на уровне сети (уровень 3 OSI модели) и выполняет функцию передачи данных между различными сетями, принимая решения о маршруте на основе IP-адресов.
   - Коммутатор: Работает на уровне канала (уровень 2 OSI модели) и обеспечивает коммутацию кадров данных внутри одной сети, управляя трафиком между устройствами внутри одной локальной сети (LAN).

2. Применение:
   - Маршрутизатор: Используется для соединения различных сегментов сети и передачи данных между ними. Хорошо подходит для организации сетей с несколькими подсетями или для подключения к внешним сетям (например, Интернет).
   - Коммутатор: Применяется в локальных сетях для пересылки данных между устройствами в пределах одной сети, обеспечивая более эффективную и безопасную передачу данных в локальной сети.

3. Уровень действия:
   - Маршрутизатор: Определяет маршруты на уровне IP-адресов и работает с пакетами данных.
   - Коммутатор: Работает на уровне MAC-адресов и коммутирует кадры данных внутри локальной сети.

4. Обработка трафика:
   - Маршрутизатор: Принимает решения на основе IP-адресов, проводит маршрутизацию пакетов между различными сетями.
   - Коммутатор: Осуществляет коммутацию данных на основе MAC-адресов, пересылает кадры только адресату.


### Квиз

Вопрос: Какая функция устройства относится к маршрутизатору?
   - A) Коммутация кадров на основе MAC-адресов.
   - B) Маршрутизация пакетов между различными сетями.
   - C) Фильтрация трафика внутри локальной сети.
   - D) Определение MAC-адресов устройств в сети.

   Ответ: Вариант B) - Маршрутизация пакетов между различными сетями. 


Вопрос: Какую функцию выполняет коммутатор?
   - A) Назначение IP-адресов устройствам в сети.
   - B) Пересылка данных между устройствами в локальной сети.
   - C) Распределение интернет-трафика.
   - D) Автоматическое обнаружение соседних устройств.

   Ответ: Вариант B) - Пересылка данных между устройствами в локальной сети. 


Вопрос: Какой протокол используется для развязывания циклов (петель) в сетях Ethernet на коммутаторах?
   - A) HTTP
   - B) STP
   - C) DNS
   - D) SNMP

   Ответ: Вариант B) - STP (Spanning Tree Protocol). STP помогает избежать циклов данных в сети Ethernet, обеспечивая безопасность и надежность передачи данных.


Вопрос: Какие устройства обеспечивают локальное соединение устройств внутри одной сети и работают на уровне канала OSI модели?
   - A) Маршрутизаторы.
   - B) Коммутаторы.
   - C) Маршрутизаторы и коммутаторы.
   - D) Сетевые кабели.

   Ответ: Вариант B) Коммутаторы обеспечивают локальное соединение устройств внутри одной сети и работают на уровне канала OSI модели.

Вопрос: Какие из устройств работают на уровне сети OSI модели?
   - A) Маршрутизаторы.
   - B) Коммутатор.
   - C) Оба устройства.
   - D) Ни одно из указанных устройств.

   Ответ: Вариант A) Маршрутизаторы работают на уровне сети OSI модели (третий уровень), в то время как коммутаторы работают на уровне канала (второй уровень).

---

Роутер роутеру рознь. В понимании обывателя роутер - это Wi-fi роутер в сетевом магазине электроники за несколько тысяч рублей, но подобные роутеры пригодны только для личного использования, для предприятий они, мягко говоря, не подойдут, это всё равно, что поручить чихуахуа охранять дом. Собака, конечно, будет стараться, но на результат это не повлияет. Для предприятий и тем более для провайдеров или ЦОДов используются более серьёзные устройства с ценниками на 2-3 порядка выше, но которые даже wi-fi не раздают.

Собаки             |  Роутеры
:-------------------------:|:-------------------------:
<img src="https://github.com/lexche/Testyp/assets/95694325/b2c641ff-9e90-4eaf-af86-822c6ea72aee" width="500" height="500"> | <img src="https://github.com/lexche/Testyp/assets/95694325/eca85fb2-671b-4a58-b6ca-cbfa52911775" width="500" height="500">

Перечислим основные группы маршрутизаторов:

1. Домашние маршрутизаторы:
   - Эти маршрутизаторы предназначены для использования в домашних сетях.
   - Обычно они имеют ограниченный функционал, но для большинства домашних пользователей это вполне достаточно.
  
2. Бизнес-маршрутизаторы:
   - Эти устройства предназначены для использования в офисах и предприятиях.
   - Они, как правило, обладают более широким функционалом и более высокой производительностью.
  
3. Виртуальные маршрутизаторы:
   - Эти маршрутизаторы работают в виртуальной среде и могут быть запущены на обычных серверах.
   - Они позволяют создавать гибридные или облачные сети и обеспечивать виртуализацию сетевых ресурсов.

4. Маршрутизаторы для провайдеров:
   - Эти маршрутизаторы применяются провайдерами интернет-услуг для маршрутизации трафика между различными сетями.
   - Они обычно имеют продвинутые функции маршрутизации, управления потоками и обеспечивают безопасность сети на высоком уровне.

5. Маршрутизаторы для центров обработки данных (Data Center Routers):
   - Эти маршрутизаторы оптимизированы для работы в дата-центрах, где требуется высокая производительность и надежность.
   - Они специализированы на обработке межсерверного трафика и обеспечивают высокую пропускную способность.

Настроим маршрутизацию между двумя подсетями в нашем тренажёре. В Cisco Packet Tracer соберём тестовый стэнд:

Возьмём Router 2811 и 2 конечных устройства, например компьютер и сервер, у выбранного роутера 2 сетевых интерфейса, подключим устройства к интерфейсам роутера.

<p align="center">
<img src="https://github.com/lexche/Testyp/assets/95694325/abf181c8-094f-4458-9028-7e193dc8a12d">
</p>

Зайдём в настройки компьютера и сервера и назначим им ip-адреса из разных подсетей: 192.168.0.0/24 и 192.168.1.0/24, зайдём в свойства устройств и пропишем ip-адреса вручную, 192.168.0.10 для компьютера в первой сети и 192.168.1.20 для сервера во второй сети:

<img src="https://github.com/lexche/Testyp/assets/95694325/0d9341ab-3c68-4b4e-8fec-0ece278cf576" width="500" height="500">  <img src="https://github.com/lexche/Testyp/assets/95694325/da3c50da-cafe-4201-a274-c5c25ef77d42" width="500" height="500">

Проверим доступен ли сервер из подсети компьютера с помощью команды ping:

<img src="https://github.com/lexche/Testyp/assets/95694325/497c9a40-6d03-4afc-b422-5786374c7fbb" width="500" height="500">  <img src="https://github.com/lexche/Testyp/assets/95694325/c4ba1a93-679e-4382-973c-ae8b5e7c3519" width="500" height="500">


Недоступен.

Чтобы доступ появился необходимо настроить роутер. В подсеть 0.0/24 подключен интерфейс FastEthernet 0/0, в подсеть 1.0/24 - FastEthernet 0/1.

Подключимся к роутера и в терминале введём следующие команды:

```

Router>enable 
Router#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
Router(config)#interface fastEthernet 0/0
Router(config-if)#ip address 192.168.0.1 255.255.255.0
Router(config-if)#no shutdown 
Router(config-if)#
%LINK-5-CHANGED: Interface FastEthernet0/0, changed state to up

%LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/0, changed state to up

Router(config-if)#exit
Router(config)#interface fastEthernet 0/1
Router(config-if)#ip address 192.168.1.1 255.255.255.0
Router(config-if)#no shutdown 

Router(config-if)#
%LINK-5-CHANGED: Interface FastEthernet0/1, changed state to up

%LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to up

Router(config-if)#end
Router#wr

```
Объясним написанное:

1. Router>enable - Переключение в режим привилегий, который позволяет получить расширенный доступ к командам для настройки.

2. Router#conf t - Команда для входа в режим глобальной конфигурации, где можно настраивать параметры устройства.

3. Router(config)#interface fastEthernet 0/0 - Переход к настройке интерфейса FastEthernet0/0.

4. Router(config-if)#ip address 192.168.0.1 255.255.255.0 - Назначение IP-адреса 192.168.0.1 с маской подсети 255.255.255.0 на интерфейс FastEthernet0/0.

5. Router(config-if)#no shutdown - Включение (активация) интерфейса FastEthernet0/0.

6. %LINK-5-CHANGED: Interface FastEthernet0/0, changed state to up - Сообщение о том, что состояние интерфейса FastEthernet0/0 изменилось на "вверх" (up), т.е. интерфейс активирован.

7. %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/0, changed state to up - Сообщение о том, что протокол линии на интерфейсе FastEthernet0/0 изменил состояние на "вверх" (up).

8. Router(config-if)#exit - Покидает режим настройки интерфейса и возвращается в режим глобальной конфигурации.

9. Router(config)#interface fastEthernet 0/1 - Переход к настройке интерфейса FastEthernet0/1.

10. Router(config-if)#ip address 192.168.1.1 255.255.255.0 - Назначение IP-адреса 192.168.1.1 с маской подсети 255.255.255.0 на интерфейс FastEthernet0/1.

11. Router(config-if)#no shutdown - Включение (активация) интерфейса FastEthernet0/1.

12. %LINK-5-CHANGED: Interface FastEthernet0/1, changed state to up - Сообщение о том, что состояние интерфейса FastEthernet0/1 изменилось на "вверх" (up), т.е. интерфейс активирован.

13. %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/1, changed state to up - Сообщение о том, что протокол линии на интерфейсе FastEthernet0/1 изменил состояние на "вверх" (up).

14. Router(config-if)#end - Завершение настройки интерфейсов и возврат в режим привилегий.

15. Router#wr - Сохранение настроек в конфигурационный файл.

После этого, если посмотрим на таблицу маршрутов, то увидим:

```

Router#show ip route
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
       * - candidate default, U - per-user static route, o - ODR
       P - periodic downloaded static route

Gateway of last resort is not set

     192.168.0.0/24 is variably subnetted, 2 subnets, 2 masks
C       192.168.0.0/24 is directly connected, FastEthernet0/0
L       192.168.0.1/32 is directly connected, FastEthernet0/0
     192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks
C       192.168.1.0/24 is directly connected, FastEthernet0/1
L       192.168.1.1/32 is directly connected, FastEthernet0/1

```
Из этого вывода мы видим что 

1. 192.168.0.0/24 is variably subnetted, 2 subnets, 2 masks:
   - 192.168.0.0/24 - Имеются две подсети с маской /24 в сети 192.168.0.0.
   - C 192.168.0.0/24 is directly connected, FastEthernet0/0 - Сеть 192.168.0.0/24 подключена напрямую к интерфейсу FastEthernet0/0.
   - L 192.168.0.1/32 is directly connected, FastEthernet0/0 - Локальный IP-адрес 192.168.0.1/32 назначен интерфейсу FastEthernet0/0.

2. 192.168.1.0/24 is variably subnetted, 2 subnets, 2 masks:
   - 192.168.1.0/24 - Имеются две подсети с маской /24 в сети 192.168.1.0.
   - C 192.168.1.0/24 is directly connected, FastEthernet0/1 - Сеть 192.168.1.0/24 подключена напрямую к интерфейсу FastEthernet0/1.
   - L 192.168.1.1/32 is directly connected, FastEthernet0/1 - Локальный IP-адрес 192.168.1.1/32 назначен интерфейсу FastEthernet0/1.

Этот вывод показывает таблицу маршрутизации, где указаны подсети, подключенные напрямую к маршрутизатору (C - connected), а также локальные IP-адреса интерфейсов (L - local). 

Теперь если мы попробуем проверить доступность устройств между собой, то увидим, что они доступны:

<p align="center">
<img src="https://github.com/lexche/Testyp/assets/95694325/cf78a318-9e89-4eae-8824-837e11167edc">
</p>

### Практическое задание.

Повторите представленный выше пример самостоятельно на своих компьютерах с помощью Cisco Packet Tracer.

---

В приведённом выше примере мы использовали команду ping для проверки доступности узла в другой подсети. Это не единственный инструмент, их множество, рассмотрим некоторые из них:

Для диагностики и анализа сетевых проблем существует несколько инструментов, включая traceroute, ping, и другие. Вот краткое описание этих инструментов:

1.  Ping (Packet Internet Groper) используется для проверки доступности узла в сети по IP-адресу. Он отправляет ICMP (Internet Control Message Protocol) эхо-запросы и ждет ответов.
   - Пример использования в командной строке: ping 192.168.1.1.

2. Traceroute(также известный как tracert на Windows) используется для определения пути, по которому проходят пакеты от отправителя к целевому узлу. Он показывает все промежуточные узлы (роутеры) на пути к целевому узлу и время задержки на каждом узле.

3. ARP (Address Resolution Protocol) - это протокол, который используется для сопоставления IP-адресов с физическими MAC-адресами в сетях Ethernet. Например, если два устройства в сети имеют один и тот же IP-адрес, ARP может помочь обнаружить подобные конфликты.

4. Netcat (nc) - универсальная сетевая утилита для чтения и записи данных через TCP или UDP соединения. Он может использоваться для тестирования сети, создания или прослушивания портов.
  

5. Wireshark - это программа, которая позволяет анализировать сетевой трафик в реальном времени. При помощи Wireshark можно просматривать и анализировать пакеты данных в сети для выявления проблем.


6. Nmap - это сканер безопасности для анализа сети, поиск устройств, открытых портов и других служб. Он помогает в определении структуры сети и обнаружении уязвимостей.


методы устранения распространенных проблем маршрутизации:

#### 1. Проверка физического подключения:
   - Проблема: Некорректное подключение кабелей, повреждения кабелей.
   - Устранение: Провести визуальную проверку подключений, заменить поврежденные кабели, переподключить кабели.

#### 2. Неправильные настройки IP-адресов:
   - Проблема: Не правильно назначен IP-адрес на интерфейсах маршрутизатора.
   - Устранение: Перепроверить и исправить настройки IP-адресов на интерфейсах маршрутизатора.

#### 3. Неправильная конфигурация маршрутов:
   - Проблема: Отсутствие или некорректно настроенные маршруты.
   - Устранение: Настроить или исправить маршруты для правильной маршрутизации данных.
   - Пример:
     ```
     ip route 192.168.2.0 255.255.255.0 192.168.1.2
     ```

#### 4. Низкая пропускная способность маршрутизатора:
   - Проблема: Маршрутизатор не способен обрабатывать весь трафик.
   - Устранение: Провести апгрейд оборудования, настроить балансировку нагрузки.

#### 5. Проверка соединений между устройствами:
   - Проблема: Неисправные порты на маршрутизаторах, коммутаторах или компьютерах.
   - Устранение: Проверить состояние интерфейсов, заменить неисправные устройства.

#### 6. ARP кэш и конфликты IP-адресов:
   - Проблема: Конфликты IP-адресов или неверные записи в ARP кэше.
   - Устранение: Очистить ARP кэш, разрешить конфликты IP-адресов.
   - Пример: 
     ```
     clear arp-cache
     ```

#### 7. Проверка доступности соседних устройств:
   - Проблема: Отсутствие связи с соседними устройствами.
   - Устранение: Пинговать соседние устройства, проверить возможные физические или программные проблемы.

### Квиз

Вопрос: Какой метод устранения проблемы связности между двумя устройствами в сети, если одно устройство не видит другое?
   - A) ACL фильтрация
   - B) Очистка ARP-кеша
   - C) Проверка физического подключения
   - D) Изменение IP-адреса устройства
   - Ответ: C) Проверка физического подключения

Объяснение: Правильный ответ - Проверка физического подключения. Первым шагом при проблемах с видимостью устройств в сети будет проверка правильности физического подключения и состояния сетевых кабелей.

Вопрос: Какой инструмент позволяет отследить путь, по которому проходят пакеты от отправителя к целевому устройству?
   - A) SSH
   - B) Netcat
   - C) Traceroute
   - D) FTP
   - Ответ: C) Traceroute

Объяснение: Правильный ответ - Traceroute. Инструмент Traceroute позволяет отслеживать путь пакетов в сети, показывая все промежуточные узлы на маршруте и время задержки на каждом узле.

Вопрос: Какой метод устранения проблемы маршрутизации используется при обнаружении конфликтов IP-адресов в сети?
   - A) Очистка VLAN
   - B) Удаление статических маршрутов
   - C) Применение ACL
   - D) Очистка ARP-кеша
   - Ответ: D) Очистка ARP-кеша

Объяснение: Правильный ответ - Очистка ARP-кеша. При возникновении конфликтов IP-адресов в сети можно очистить ARP-кеш на устройствах для правильного разрешения IP-адресов в MAC-адреса и устранения проблем с коммуникацией.

Вопрос: Какой метод устранения проблемы связности между двумя устройствами в сети, если одно устройство не видит другое?
   - A) ACL фильтрация
   - B) Очистка ARP-кеша
   - C) Проверка физического подключения
   - D) Анализ содержимого ARP-кеша
   - Ответ: C) Проверка физического подключения

Объяснение: Правильный ответ - Проверка физического подключения. Первым шагом при проблемах с видимостью устройств в сети будет проверка правильности физического подключения и состояния сетевых кабелей.




