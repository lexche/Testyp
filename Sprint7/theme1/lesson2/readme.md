## Урок 3. Задачи управления дисками в Linux.

В предыдущем уроке мы познакомились с LVM и частью его функций. В этом уроке мы продолжим углубляться в функционал LVM через стандартные ситуации в ОС Linux.


#### Добавление нового диска.

1. Подключите новый физический диск к вашей системе.

2. Используйте команду fdisk для создания раздела на новом диске. fdisk - утилита для работы с дисками и их разделами:

Например:
```
   sudo fdisk /dev/sdb
```

fdisk /dev/sdb: открывает утилиту для работы с диском /dev/sdb. Здесь можно создавать, изменять и удалять разделы на диске.

Ключи:

     - n: создать новый раздел.

     - t: изменить тип раздела.

     - w: сохранить изменения и выйти.

3. Используйте команду pvcreate для создания нового физического тома на новом разделе. Например:

```
   sudo pvcreate /dev/sdb1
```
 pvcreate - создание нового физического тома на разделе:
   - pvcreate /dev/sdb1: создает физический том на разделе /dev/sdb1.

Ключи:

     - -v, --verbose: выводит подробную информацию о процессе создания физического тома.

     - -y, --yes: подтверждает все запросы без подтверждения пользователя.

     - --dataalignment: задает выравнивание данных при создании физического тома.

     - -ff - принудительно перезаписывать существующую метку LVM.

#### Расширение хранилища

##### Увеличение размера хранилища при добавлении нового физического диска:

   - Добавление нового физического тома в группу томов vg_data:
     ```
     sudo vgextend vg_data /dev/sdb
     ```
    vgextend - команда для добавления нового физического тома в существующую группу томов:
   - vgextend <имя группы томов> /dev/sdb1: добавляет новый физический том /dev/sdb1 в группу томов <имя группы томов>.

   - Ключи:

     - -v, --verbose: выводит подробную информацию о процессе добавления физического тома в группу томов.

     - --alloc: задает метод распределения места для логических томов на новом физическом томе.


   - Увеличение размера логического тома lv_data на всю доступную свободную емкость нового физического тома:
     ```
     sudo lvextend -l +100%FREE /dev/vg_data/lv_data
     ```
    lvextend - команда для увеличения размера существующего логического тома или создания нового:
   - lvextend -l +100%FREE /dev/vgdata/lvdata: увеличивает размер логического тома lvdata в группе томов vgdata на всю доступную свободную емкость.
   - Ключи:

     - -L, --size: задает новый размер логического тома.

     - -n, --name: задает имя для нового логического тома.


   - Изменение размера файловой системы для учета увеличенного логического тома:
     ```
     sudo resize2fs /dev/vg_data/lv_data
     ```

     resize2fs - команда для изменения размера файловой системы ext4:
     - resize2fs /dev/vgdata/lvdata: изменяет размер файловой системы на логическом томе lvdata в группе томов vgdata.
     - Ключи:

       - -f, --force: производит изменение размера даже если файловая система не была размечена перед изменением.

       - -M, --all-stripe: работает с файловыми системами, размещенными на нескольких томах.

##### Увеличение размера существующего физического тома:

   Если у вас есть группа томов vg_data с одним физическим томом /dev/sda1 и логическим томом lv_data, и хотите увеличить размер физического тома /dev/sda1, выполните следующие шаги:

   - Увеличение размера существующего физического тома /dev/sda1 на новый объем (например, на 10 ГБ):
     ```bash
     sudo pvresize --setphysicalvolumesize +10G /dev/sda1
     ```

   - Увеличение размера логического тома lv_data на всю доступную емкость физического тома:
     ```bash
     sudo lvextend -l +100%FREE /dev/vg_data/lv_data
     ```

   - Изменение размера файловой системы для учета увеличенного логического тома:
     ```bash
     sudo resize2fs /dev/vg_data/lv_data
     ```

#### Перенос данных с одного диска на другой

Для переноса данных с одного диска на другой при помощи LVM нам понадобятся несколько шагов. Давайте разберем это на примере.

Шаг 1: Добавление нового диска к группе LVM
Прежде всего, нужно добавить новый диск к вашей группе LVM. Допустим, у вас есть группа под названием vg01 и вы хотите добавить новый диск /dev/sdb к этой группе. 
```
sudo pvcreate /dev/sdb
sudo vgextend vg01 /dev/sdb
```

Шаг 2: Создание нового logical volume
Затем создайте новый logical volume на основе расширенной группы с новым диском. Например, создадим новый logical volume под названием lv_new с размером 10GB.
```
sudo lvcreate -n lv_new -L 10G vg01
```

lvcreate - команда для создания нового logical volume в указанной группе томов LVM.
   - Ключи:

     - -n - задать имя для нового logical volume.

     - -L - указать размер нового logical volume.

Шаг 3: Перенос данных
Теперь можно скопировать данные с вашего текущего logical volume на новый.
```
sudo dd if=/dev/vg01/lv_old of=/dev/vg01/lv_new bs=4M
```
 dd - утилита для копирования и преобразования файлов.
   - Ключи:

     - if= - исходное устройство/файл.

     - of= - целевое устройство/файл.

     - bs= - размер блока данных для чтения и записи.

Шаг 4: Перенос метаданных
Перенесите метаданные на новый logical volume.

```
sudo pvmove /dev/sda1 /dev/sdb
```
pvmove - команда используется для перемещения данных с одного физического тома на другой в группе томов LVM.
   - Ключи:
     - -b - использовать процесс отката при возникновении ошибок.
     - -i - интерактивный режим для подтверждения операций перемещения.

После завершения этих шагов, данные будут успешно перенесены с одного диска на другой при помощи LVM. Обязательно сделайте резервную копию ваших данных перед проведением этих операций, чтобы избежать потери информации.

### Квиз

#### Вопрос 1:
Какая команда используется для создания физического тома в LVM?

a) lvcreate  
b) pvcreate  
c) vgcreate  
d) fdisk  

Правильный ответ: b) pvcreate  
Объяснение: Команда pvcreate используется для создания физического тома на указанном устройстве, что является первым шагом при работе с LVM.

#### Вопрос 2:
Какой ключ можно использовать с командой pvmove для использования процесса отката при возникновении ошибок?

a) -b  
b) -f  
c) -r  
d) -i  

Правильный ответ: a) -b  
Объяснение: Ключ -b устанавливает использование процесса отката при возникновении ошибок в процессе перемещения данных между физическими томами в LVM.

#### Вопрос 3:
Что делает команда lvextend в LVM?

a) Удаляет logical volume  
b) Создает новый logical volume  
c) Увеличивает размер logical volume  
d) Уменьшает размер logical volume  

Правильный ответ: c) Увеличивает размер logical volume  
Объяснение: Команда lvextend используется для увеличения размера существующего logical volume в LVM.

#### Вопрос 4:
Каким образом можно переместить данные с одного физического тома на другой в LVM?

a) С помощью команды lvmove  
b) С помощью команды vgmove  
c) С помощью команды pvmove  
d) С помощью команды tmmove  

Правильный ответ: c) С помощью команды pvmove  
Объяснение: Команда pvmove используется для перемещения данных с одного физического тома на другой в группе томов LVM, обеспечивая безопасный перенос информации.

#### Траблшутинг

При возникновении проблем с LVM, таких как повреждение метаданных, потеря физических томов или другие сбои, существуют определенные команды, которые могут помочь в восстановлении данных и исправлении проблем. Вот несколько основных команд для траблшутинга и восстановления данных в LVM:


1. **`pvscan`**: Эта команда сканирует все доступные устройства на наличие физических томов LVM и обновляет информацию о них в системе.
  - Полезные ключи:
     - `-d` - выводит дополнительную информацию о найденных физических томах.

2. **`vgscan`**: Данная команда сканирует систему на наличие групп томов LVM и обновляет информацию о них.

3. **`lvscan`**: Эта команда сканирует систему на наличие logical volume и обновляет информацию о них.

4. **`vgcfgrestore`**: Если метаданные группы томов LVM были повреждены или удалены, можно попытаться восстановить предыдущие метаданные из резервной копии с помощью этой команды.
   - Полезные ключи:
     - `-f <file>` - указание файла с резервной копией метаданных.
     - `<vg_name>` - имя группы томов для восстановления.

5. **`pvcreate --uuid <UUID> --restorefile <file>`**: Используется для восстановления метаданных физического тома LVM из резервной копии, указанной в параметре `--restorefile`.
  - Полезные ключи:
     - `--uuid <UUID>` - указание резервного UUID для восстановления.
     - `--restorefile <file>` - указание резервного файла для восстановления.

6. **`vgcfgrestore --file <file> <vg_name>`**: Позволяет восстановить метаданные группы томов LVM из файла резервной копии.
   - Полезные ключи:
     - `--file <file>` - указание файла с резервной копией метаданных.
     - `<vg_name>` - имя группы томов для восстановления.

7. **`lvchange -ay`**: Если logical volume не отмечен как активный (`active`), этот ключ поможет восстановить его активность.

8. **`lvremove --force <lv_path>`**: Используется для удаления logical volume, который не удается восстановить другими способами. Ключ `--force` позволяет удалить даже поврежденные logical volume.

9. **`pvmove --abort`**: Если операция перемещения данных между физическими томами LVM была прервана или столкнулась с проблемами, этот ключ поможет отменить операцию.

Давайте разберём конкретную ситуацию.

Допустим, у нас есть система с LVM, состоящая из двух физических томов /dev/sda1 и /dev/sdb1, объединенных в группу томов vg01, а также двумя logical volume lv_data и lv_backup.

#### Ситуация:
По какой-то причине жесткий диск /dev/sda1, содержащий важные данные, выходит из строя, и система перестает видеть этот физический том.

#### Шаги для исправления ситуации:

1. Обнаружение проблемы:
   - Запускаем команду pvdisplay, чтобы посмотреть список физических томов. Обнаруживаем, что /dev/sda1 отсутствует.
   - Проверяем системные журналы на наличие сообщений об ошибках или потере доступа к диску.
   
2. Исправление проблемы:
   - Подключаем новый заменяемый жесткий диск /dev/sdc1 к системе.

   - Запускаем команду pvcreate /dev/sdc1 для создания нового физического тома на новом диске.

   - Далее выполняем команду vgextend vg01 /dev/sdc1 для добавления нового физического тома в группу томов vg01.

   - Теперь создаем новую temporary logical volume lv_temp для перемещения данных со сломанного диска. lvcreate -n lv_temp -L 10G vg01

   - Копируем данные с ломающегося physical volume на новый pvmove /dev/sda1 /dev/sdc1

   - Удаляем поврежденный физический том pvremove /dev/sda1

   - Удаляем временный logical volume lvremove /dev/vg01/lv_temp

После выполнения этих шагов, данные успешно перемещены с вышедшего из строя жесткого диска на новый, и работа системы с LVM восстановлена. Даже в случае выхода из строя жесткого диска, методика LVM позволяет рационально управлять данными, обеспечивая безопасность и эффективность восстановления.

### Практическое задание

Повторите на виртуальной машине пример, представленный выше.

В этом уроке мы продолжили изучение LVM, узнали с помощью каких команд и утилит можно добавить новый диск, перенести данные с одного диска на другой, расширить хранилище. Рассмотрели основные команды и утилиты для траблшутинга, рассмотрели пример использования.

В следующем уроке расскажем про протоколы доступа к данным.
