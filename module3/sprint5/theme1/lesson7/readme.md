# Урок 7. Сетевые устройства

В предыдущих уроках вы познакомились со всеми уровнями модели TCP/IP — данные в ней обрастают заголовками, как снежный ком. Теперь рассмотрим коммутационное оборудование и разберёмся в его функциях.

[Кнопка] Исследовать коммутатор

## Коммутатор

Для начала вспомним, что из себя представляет это устройство:

>[На подложке: a2c0c5] Коммутатор предназначен для соединения оборудования в локальной сети — у него есть специализированное железо, которое позволяет быстро и эффективно пересылать пакеты данных между устройствами. 
>
> Один из ключевых элементов в его работе — **CAM-таблица** (от англ. Content Addressable Memory — «память с адресацией по содержимому»), которая хранит соответствия между MAC-адресами устройств и портами коммутатора. 

Получив пакет, коммутатор анализирует MAC-адрес источника в этом пакете и затем использует его для обновления CAM-таблицы. Она помогает коммутатору оптимизировать пересылку данных, избежать ненужного широковещательного трафика.

Вот как происходит заполнение CAM-таблицы: 

>[На подложке] При получении кадра коммутатор проверяет MAC-адрес источника → Если MAC-адреса нет в CAM-таблице, он добавляет его и ассоциирует с портом, через который пришёл кадр → Когда нужно отправить данные на MAC-адрес, коммутатор использует CAM-таблицу, выявляя через неё нужный порт для доставки.

Допустим, у нас есть коммутатор с тремя подключёнными узлами:

1. Узел `A` с MAC-адресом `AA:AA:AA:AA:AA:AA` подключён к порту `1` коммутатора.

2. Узел `B` с MAC-адресом `BB:BB:BB:BB:BB:BB` подключён к порту `2` коммутатора.

3. Узел `C` с MAC-адресом `CC:CC:CC:CC:CC:CC` подключён к порту `3` коммутатора.

![]()

Когда узел `A` отправляет пакет через коммутатор, в CAM-таблицу попадает запись вида `узел с MAC-адресом AA:AA:AA:AA:AA:AA подключен к 1 порту`. Если узел `B` отправит пакет устройству `A`, коммутатор обновит свою таблицу и запишет, что `узел B с MAC-адресом BB:BB:BB:BB:BB:BB подключён к порту 2`. 

Затем он сверится с таблицей вновь и увидит, что узел `A` находится на первом порту, и сразу отправит пакет туда. Если записи в CAM-таблице не будет (к примеру, узел `A` отправит пакет узлу `C`), коммутатор отправит пакет на все порты.

Подытожим: CAM-таблица минимизирует ненужный трафик и обеспечивает быструю доставку пакетов между устройствами, тем самым позволяя коммутатору эффективно пересылать данные в сети.

[Кнопка] Узнать про петли

## Петли

>[На подложке: a2c0c5] При коммутации отправляемые пакеты могут зациклиться и пересылаться бесконечно долго. Такие случаи называют **сетевой петлей** (англ. loop) — эта проблема осложняет функционирование сети и может вовсе остановить её работу. 

Вспомните структуру заголовка IP из [третьего урока](https://practicum.yandex.ru/learn/sys-admin/courses/422bcc9f-26c0-4cff-ba43-ca6dd8626b47/sprints/null/topics/017e3a39-b526-42b5-8e7c-49a344ef3b45/lessons/18a85191-cd27-4527-b84c-ebe14c01d742/) — там мы описывали поле TTL, которое служит для уничтожения пакетов с истёкшим сроком жизни. Особенность в том, что протокол IP реализуется на межсетевом уровне, а в канальном понятие TTL отсутствует.


![]()


>[Реплика студента] И что же, зациклившийся пакет будет петлять бесконечно?

 

>[На подложке: a2c0c5] Чтобы это предотвратить, на коммутаторах реализуется протокол **STP** (от англ. Spanning Tree Protocol — «протокол связующего дерева»). Через поиск и отключение избыточных путей в сети он обеспечивает единственный активный путь между устройствами.

В общих чертах работа этого алгоритма выглядит так:

- При включении STP коммутаторы в сети начинают обмениваться служебной информацией, чтобы выбрать корневой коммутатор.
- Затем определяется наикратчайший путь до корневого коммутатора.

- Дальше отключаются избыточные маршруты. К примеру, на картинке ниже коммутатор `С` — корневой. Активными портами коммутаторов `А` и `В` в таком случае останутся те, что соединены по линии `А-С` и `С-В`. Порты на соединении `А-В` перейдут в состояние блокировки, трафик по ним передаваться не будет.

- Если активный маршрут выйдет из строя, заблокированные пути вновь начнут передавать трафик.

[Кнопка] Узнать про маршрутизатор


## Маршрутизатор

![]()

>[На подложке: a2c0c5] Ещё одно устройство, знакомое по прошлым урокам. Напомним, что маршрутизатор отличается от коммутатора тем, что работает на межсетевом уровне и служит для пересылки IP пакетов между разными сетями.

Для выполнения своих задач он использует **таблицу маршрутизации**, которая содержит соответствие IP-адресов и интерфейсов, через которые нужно отправить пакет. 

Представим, что у нас есть сеть:


![]()


И в ней — две разные подсети: `192.168.1.0/24` и `192.168.2.0/24`. В таком случае таблица на маршрутизаторе будет выглядеть следующим образом:

```c
Назначение        Шлюз             Маска            Интерфейс
192.168.1.0/24     -                255.255.255.0    eth0
192.168.2.0/24     -                255.255.255.0    eth1
```

Когда пакет из первой подсети попадёт на маршрутизатор, запустится алгоритм:

1. Из заголовка пакета извлечётся IP-адрес назначения.

2. Затем маршрутизатор применит к нему маску (вспомните [урок про IP-протокол](https://practicum.yandex.ru/learn/sys-admin/courses/422bcc9f-26c0-4cff-ba43-ca6dd8626b47/sprints/null/topics/017e3a39-b526-42b5-8e7c-49a344ef3b45/lessons/18a85191-cd27-4527-b84c-ebe14c01d742/)).

3. И сравнит полученный результат с адресом из записи в таблице маршрутизации.

4. Если адреса совпадут, маршрутизатор выберет интерфейс, через который нужно отправить пакет.

>[На подложке] Пакет, отправленный с ПК 1 с адресом `192.168.1.7`, придёт на маршрутизатор через интерфейс `eth 0`. Адрес его назначения — `192.168.2.4` с маской `24`, то есть ПК 2. 
>
> После наложения маски получится нужная подсеть `192.168.2.0/24`, маршрутизатор сверится с таблицей и отправит пакет на интерфейс `eth1`.

Есть ещё один важный компонент:

>[На подложке: a2c0c5] Для операций по маршрутизации предназначен специальный аппаратный модуль — **ASIC** (от англ. Application-Specific Integrated Circuit — «интегральная схема для конкретного применения»). Это микросхема, которая берёт на себя часть задач и снимает нагрузку с процессора сетевого оборудования. 

ASIC оптимизирован для обработки сетевых пакетов, что значительно ускоряет его работу по сравнению с общим процессором маршрутизатора.

[Кнопка] Узнать про файрвол

## Файрвол

>[На подложке: a2c0c5] Ещё одно важное устройство в сетевой архитектуре — **межсетевые экраны** (англ. firewalls, также используется название «брандмауэр»), предназначенные для контроля и фильтрации сетевого трафика. 
>
> Они работают на аппаратном уровне и обычно используются для защиты корпоративных сетей от угроз — хакерских атак, вирусов, вредоносного ПО и других. 

>[Реплика героя курса] Конечно, есть и программные решения, но они уступают аппаратным в производительности.

![]()

Проходящий через сетевой экран трафик обрабатывается по специальным правилам — они определяют, пропускать его или нет. Обычно правило выглядит как условие и действие, которое необходимо совершить: например, при обращении к `22` порту запрещать трафик.

Есть также усовершенствованные версии файрволов с более широким спектром функций и возможностей для обеспечения безопасности сети — **NGFW** (от англ. Next-Generation Firewall — «файрвол следующего поколения»). 

Основной упор в них — не только на фильтрации пакетов и контроле доступа на уровне портов и протоколов, как у традиционных межсетевых экранов, но и на глубоком анализе сетевого трафика.

Пройдёмся по возможностям NGFW:

1. **Продвинутый контроль приложений:** способность распознавать их в сетевом трафике и применять правила безопасности на уровне приложений, а не только портов.

1. **Глубокий анализ трафика**, включая декодирование SSL-трафика, обнаружение вредоносного ПО и предотвращение передачи угрожающих файлов.

2. **Обнаружение и предотвращение атак в реальном времени**, таких как DDoS атаки, фишинг, SQL-инъекции и прочих.

### Подведём итоги

С аппаратной точки зрения сетевое оборудование задействовано на всех уровнях модели TCP/IP. Такие устройства оснащаются специальными микросхемами — у коммутаторов и маршрутизаторов это ASIC. 

Как в коммутаторах, так и в маршрутизаторах есть таблицы — CAM и маршрутизации, а ещё протоколы для борьбы с широковещательными штормами, или сетевыми петлями. Безопасность в сети обеспечивает отдельное многофункциональное устройство — межсетевой экран, или файрвол.
