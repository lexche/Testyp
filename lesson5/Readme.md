## Урок 5. Виртуальная память.

Представьте, что у вас ограниченный объем физической памяти, но ваша задача — запустить программу, требующую больше памяти, чем доступно. Как операционная система решает эту задачу, не допуская сбоев в работе?

Важно не перепутать виртуальную память и механизмы подкачки. Виртуальная память и механизм подкачки — две технологии, которые решают разные задачи. Виртуальная память избавляет разработчика программы от головной боли вычисления адресов 
физической памяти: в его распоряжении есть непрерывный набор адресов, которые он может использовать. А механизм подкачки, который пользуется благами механизма виртуальных адресов, позволяет расширить границы оперативной памяти за счёт дискового пространства.

Виртуальная память представляет собой механизм, который позволяет программам использовать больше памяти, чем есть на самом устройстве. При этом операционная система периодически перемещает данные между физической памятью и дисковым пространством, чтобы обеспечить удовлетворение требований программ к памяти. Это дает впечатление, что у каждой программы есть своя обширная область памяти.

Рассмотрим основные методы реализации виртуальной памяти:

- Страничное преобразование виртуальной памяти. В этой схеме память разбивается на небольшие фрагменты (страницы), и у каждой страницы есть свое отображение на физическую память. Когда процесс обращается к адресному пространству, операционная система переводит
  виртуальные адреса в физические через таблицу страниц.

- Сегментация виртуальной памяти. Подход сегментации позволяет адресному пространству процесса состоять не только из страниц, но и из логических блоков различных размеров (сегментов). Эти сегменты содержат информацию о коде программы, стеке, куче и других
  атрибутах процесса.

- Сегментно-страничная виртуальная память. Она работает с использованием двойной системы разделения: сначала виртуальное адресное пространство разделяется на сегменты, а затем сами сегменты разбиваются на страницы. В этой системе перемещение данных осуществляется
   на уровне страниц. Таким образом, этот метод управления памятью объединяет в себе определенные характеристики и преимущества обоих предыдущих подходов, обеспечивая более гибкое и эффективное адресное пространство.

  Давайте разберём на примерах случаи использования виртуальной памяти.

- Многозадачные операционные системы. Классический пример использования виртуальной памяти - это многозадачные операционные системы, такие как Linux, Windows или macOS. В этом контексте, виртуальная память позволяет каждому процессу иметь свое собственное виртуальное адресное пространство, что обеспечивает изоляцию процессов друг от друга. Это помогает предотвратить конфликты при доступе к памяти и повышает безопасность системы.

Метод реализации: Виртуальная память в многозадачных операционных системах обычно основана на страничном преобразовании, которое разбивает память на небольшие фрагменты (страницы) и отображает их на физическую память через таблицу страниц.

- Поддержка крупных приложений. Виртуальная память позволяет реализовывать крупные приложения, такие как базы данных или графические редакторы, которые требуют значительных объемов памяти. Благодаря виртуальной памяти, приложения могут эффективно управлять большими объемами данных, не требуя огромное количество физической оперативной памяти.

Метод реализации: Для обработки крупных приложений виртуальная память использует страничное преобразование и сегментацию, позволяя выделять и освобождать память для различных компонентов приложения по мере необходимости.

- Виртуальные машины и контейнеры. Виртуальная память играет важную роль в технологиях виртуализации, таких как виртуальные машины (VM) и контейнеры. При запуске виртуальной машины на одном физическом оборудовании, виртуальная память позволяет изолировать и назначать каждой виртуальной машине свое собственное виртуальное адресное пространство.

Метод реализации: Виртуальная память в этом контексте также использует страничное преобразование, чтобы обеспечить изоляцию и назначение ресурсов каждой виртуальной машине.

---

  В самом начале урока мы сделали акцент на схожести виртуальной памяти с таким механизмом, как файл подкачки. Эти 2 понятия часто путают между собой из-за их тесно взаимосвязанных функций. С определением и методами виртуальной памяти мы познакомились выше, давайте 
познакомимся с механизмом подкачки через сравнение с виртуальной памятью, чтобы лучше понять в чём их различия.

Виртуальная память представляет собой механизм, позволяющий программам использовать больше памяти, чем есть на самом устройстве, и обеспечивает иллюзию каждому процессу обладания отдельной обширной областью памяти для работы. Это достигается за счет отображения 
виртуальных адресов на физическую память, используя методы, такие как страничное преобразование и сегментация.

Файл подкачки (или область подкачки) представляет собой область на постоянном накопителе (чаще всего на жестком диске), которая используется для временного хранения частей данных, которые временно не нужны в оперативной памяти процессора. Когда нехватка физической памяти становится проблемой, операционная система перемещает части неиспользуемых данных из оперативной памяти в файл подкачки, освобождая тем самым место для активных данных.

Отличие между ними:
- Функциональное назначение: Виртуальная память предоставляет каждому процессу изолированное адресное пространство, тогда как файл подкачки представляет собой механизм, с помощью которого операционная система временно сохраняет часть данных процесса на диск, чтобы
   освободить физическую память.
- Использование: Виртуальная память используется для предоставления каждому процессу впечатления наличия большого объема памяти, в то время как файл подкачки работает как механизм резервного хранения данных в случае нехватки оперативной памяти.
- Размещение данных: Виртуальная память хранит данные в адресном пространстве процесса, тогда как файл подкачки хранит данные на постоянном накопителе.

Таким образом, виртуальная память и файл подкачки, хотя и имеют определенное сходство в функционировании, выполняют разные роли в управлении памятью и обеспечении стабильной работы операционной системы при работе с большими объемами данных.

## КВИЗ 

Вопрос 1: Чем отличается виртуальная память от механизма подкачки?

1. Виртуальная память является физическим хранилищем данных, а механизм подкачки представляет собой аппаратное обеспечение для обработки данных.
2. Виртуальная память используется для временного хранения часто используемых данных, в то время как механизм подкачки организует перемещение данных между различными типами памяти.
3. Виртуальная память представляет собой адресное пространство, которое может быть больше, чем объем физической памяти, тогда как механизм подкачки используется для временного хранения неиспользуемых данных на диске.  /Верно
4. Виртуальная память и механизм подкачки являются синонимами и используются взаимозаменяемо.

Объяснение: Виртуальная память представляет собой механизм, позволяющий программам использовать больше памяти, чем есть на самом устройстве. Механизм подкачки, с другой стороны, представляет собой процесс перемещения части данных из оперативной памяти на постоянное хранилище (например, жесткий диск) в случае нехватки оперативной памяти.

---

Вопрос 2: Какие методы реализации чаще всего используются для виртуальной памяти и механизма подкачки?

1. Виртуальная память использует виртуальные шифрованные блоки, а механизм подкачки основан на алгоритмах сжатия данных.
2. Оба метода основаны на механизмах аутентификации и шифрования для обеспечения безопасности данных.
3. Для виртуальной памяти часто используется страничное преобразование и сегментация, в то время как механизм подкачки оперирует с адресным пространством и обменом страниц между оперативной памятью и диском.  /Верно
4. Оба метода используют цифровые сигнатуры для проверки целостности данных при перемещении между различными типами памяти.

Объяснение: Виртуальная память часто реализуется через страничное преобразование и сегментацию для управления адресным пространством процессов. Механизм подкачки работает посредством перемещения страниц между оперативной памятью и областью подкачки на диске при необходимости.

Вопрос 3: Какой из нижеперечисленных примеров лучше описывает использование виртуальной памяти?

1. Отправка кэшированных данных на диск, чтобы освободить место в оперативной памяти для активных данных.
2. Использование адресного пространства, которое может быть больше, чем физическая память, для обеспечения каждому процессу изоляции и безопасного доступа к памяти. /Верно
3. Использование цифровой подписи для проверки целостности данных в операционной памяти.
4. Контроль доступа к памяти при помощи паролей и аутентификации.

Объяснение: Виртуальная память позволяет каждому процессу думать, что у него есть доступ к большему объему памяти, чем есть фактически. Она обеспечивает изоляцию процессов и управление доступом к памяти, что повышает безопасность и стабильность системы.

Вопрос 4: Какой из перечисленных примеров наилучшим образом характеризует использование механизма подкачки?

1. Оптимизация выполнения вычислений при помощи многоканального кэширования данных.
2. Резервное копирование данных на внешний накопитель для обеспечения их сохранности.
3. Автоматическое перемещение неиспользуемых данных из оперативной памяти на диск для освобождения места. /Верно
4. Контроль доступа к данным при помощи шифрования и цифровой подписи.

Объяснение: Механизм подкачки в операционной системе автоматически перемещает неиспользуемые данные из оперативной памяти на диск для освобождения места и обеспечения более эффективного использования физической оперативной памяти.

---

В операционной системе, виртуальная память и физическая память организованы на уровне страниц. Виртуальная память делится на страницы фиксированного размера, которые отображаются на физическую память или на диск. В контексте Linux, размер страниц обычно составляет 4 килобайта, но может изменяться в зависимости от архитектуры.

Страницы в виртуальной памяти отображаются на физическую память с помощью таблицы страниц, которая хранится в оперативной памяти и используется для отслеживания соответствия страниц в виртуальной памяти страницам в физической памяти.

В Linux используются различные алгоритмы замещения страниц для управления виртуальной памятью. Некоторые из них включают:

- LRU (Least Recently Used). Этот алгоритм замещения страниц используется для определения, какие страницы следует выгружать из физической памяти на диск, когда физическая память заполняется. В Linux LRU может быть реализован с помощью списков страниц, отслеживающих порядок их использования.

 - FIFO (First-In, First-Out). Первая страница, которая была загружена в память, будет первой на замену.

Пример: Представим, что мы загружаем три страницы в память (A, B, C) и затем поступает запрос на загрузку страницы D. При использовании FIFO алгоритма, страница A, которая была загружена первой, будет заменена новой страницей D.

- LFU (Least Frequently Used). Этот алгоритм предполагает, что страницы, которые редко используются, скорее всего можно заменить.

Пример: Если у нас имеется физическая память, в которой находятся страницы A, B, C, и страница B была использована только 2 раза, в то время как страница C была использована 5 раз, то LFU алгоритм заместит страницу B, так как она используется реже.

- Optimal. Этот алгоритм замещения страниц выбирает страницу, которая не будет запрашиваться в течение длительного времени в будущем.

Пример: Допустим, у нас есть физическая память, в которой находятся страницы A, B, C, D, E, и F. При выборе страницы для замены, Optimal алгоритм предсказывает, какая страница не будет запрошена в течение длительного времени. Например, если страница B не будет запрошена в ближайшие 5 единиц времени, Optimal выберет именно её для замещения.

- CLOCK (Enhanced Clock Replacement). Другой распространенный алгоритм замещения страниц в Linux, который базируется на идее круговой очереди страниц, поддерживающей информацию о последних обращениях к страницам.

Linux также имеет возможность для ядра операционной системы динамически выбирать наиболее подходящий алгоритм замещения страниц в зависимости от характеристик системы и её нагрузки.

Кратко остановимся на других механизмах, которые Linux эффективно использует для управления виртуальной памятью:

- Swap Space: Это область на диске, используемая для хранения страниц, которые временно не помещаются в физической памяти. Linux использует swap space для обеспечения дополнительного места для хранения страниц.

- Memory Management Unit (MMU): MMU является ключевым компонентом управления виртуальной памятью в Linux и отвечает за преобразование виртуальных адресов в физические.

- Page Cache: Linux использует кэш страниц для хранения копий данных, считанных с диска, чтобы обеспечить более быстрый доступ к ним.

Неужели всё так здорово с этой технологией и недостатки отсутствуют? Конечно же нет. Давайте скажем пару слов и про недостатки:

1. Страничные промахи (Page faults): Когда программа пытается обратиться к странице памяти, которая отсутствует в физической памяти, происходит страничный промах. Это означает, что операционная система должна загрузить эту страницу из виртуальной памяти (на диск) в физическую память (RAM). Время, необходимое для этой операции, вызывает задержку в выполнении программы, что может серьезным образом сказываться на производительности.

2. Влияние на производительность: Количество страничных промахов напрямую влияет на производительность. Если у программы слишком много страничных промахов, это может привести к замедлению её выполнения, поскольку операционная система должна постоянно обращаться к диску для загрузки нужных страниц в физическую память. Это особенно заметно при выполнении больших программ или при одновременном выполнении нескольких приложений.

3. Кэширование и оптимизация: Для уменьшения количества страничных промахов используется кэширование и различные алгоритмы управления виртуальной памятью, которые стараются предвидеть, какие страницы будут нужны в ближайшем будущем и заранее загружать их в физическую память.

Влияние виртуальной памяти на безопасность операционных систем является значительным и имеет несколько аспектов, как положительных, так и негативных. Давай рассмотрим их более подробно:

Положительное влияние:

1. Изоляция процессов: Виртуальная память обеспечивает изоляцию процессов, гарантируя, что каждый процесс имеет своё собственное виртуальное адресное пространство. Это значительно снижает возможность для вредоносных программ влиять на другие процессы или даже на саму операционную систему.

2. Защита от переполнения буфера: Механизм виртуальной памяти способствует предотвращению переполнения буфера и переписывания системной области памяти, что может снизить вероятность успешной эксплуатации злоумышленными программами.

Отрицательное влияние:

1. Side-channel атаки: Некоторые side-channel атаки могут быть проведены с использованием информации о работе виртуальной памяти для извлечения конфиденциальной информации, такой как ключи шифрования. Например, атаки, основанные на анализе времени доступа к памяти или кэш-памяти.

2. Page-fault анализ: Поведение системы в ответ на страничные промахи может, в некоторых случаях, использоваться для извлечения информации о виртуальной памяти и работающих процессах.

3. Тихий переполнение памяти: Виртуальная память может привести к тихому переполнению памяти, когда страницы памяти выбрасываются на диск, чтобы уступить место другим страницам. Это может быть использовано для проникновения в защищенные области памяти.

В целом, виртуальная память способствует обеспечению безопасности операционной системы путём изоляции процессов и ограничения их доступа друг к другу. Однако при использовании в конкретных сценариях этот механизм может содержать уязвимости, которые могут быть использованы для проведения различных видов атак.

Добавим немного практики, рассмотрим утилиту vmstat  (Virtual Memory Statistics)  - мощный инструмент, который помогает администраторам и разработчикам отслеживать активность виртуальной памяти и общую статистику использования памяти в системе. Ниже представлен вывод этой команды

```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0    984 100788  80796 349820    0    2    23    31   44  155  3  1 96  0  0
```

Давай разберем, что означает каждый столбец:

- **procs**: Статистика процессов. Здесь r - количество процессов, выполняющихся на CPU, b - количество процессов, находящихся в режиме блокирования на ввод-вывод.
- **memory**: Статистика по памяти. Включает значения swpd (обмен страницами), free (свободно), buff (память под буферизацию), cache (кэш).
- **swap**: Статистика по обменному разделу. si - количество памяти, подкачанной из обменного раздела в память, so - количество памяти, подкачанной из памяти в обменный раздел.
- **io**: Статистика по вводу-выводу. bi - количество блоков, полученных с блочного устройства (диска), bo - количество блоков, отправленных на блочное устройство.
- **system**: Статистика по системе. Включает количество прерываний CPU, количество контекстов переключения (количество переключений контекста процессора).
- **cpu**: Использование CPU. us - время CPU, затраченное на выполнение пользовательских процессов, sy - время CPU, затраченное на выполнение системных процессов, id - время CPU, когда CPU был в состоянии простоя (idle), wa - время CPU, ожидающее ввода-вывода (I/O), st - время CPU, украденное гипервизором для виртуализации.

Так как мы говорим о виртуальной памяти, нас в первую очередь может заинтересовать значение "swpd" (обмен страницами) и "si" / "so" (количество памяти, подкачанной из/в обменный раздел).

Если "swpd" существенно увеличивается, это может указывать на то, что системе не хватает физической памяти и происходит активный обмен страницами, что может привести к замедлению работы системы. Количество обращений в обменный раздел (si/so) также является важным показателем, и резкое увеличение этих значений может сигнализировать о проблемах с памятью.

Таким образом, используя вывод утилиты vmstat, можно проанализировать активность виртуальной памяти и оценить поведение системы, особенно с точки зрения использования памяти и возможных проблем, связанных с обменом страницами.

## Квиз

Что представляет собой столбец "si" в выводе утилиты vmstat?
   1. Количество свободной памяти
   1. Количество страниц, которые были подкачаны из swap-памяти
   1. Количество записанных блоков дисковой активности
   1. Количество входящих запросов блоков дисковой активности

   Ответ: 2. Количество страниц, которые были подкачаны из swap-памяти

Что означает значение "swpd" в выводе утилиты vmstat?
   1. Количество использованной swap-памяти
   1. Количество записанных блоков дисковой активности
   1. Количество входящих блоков дисковой активности
   1. Количество вновь созданных процессов

   Ответ: 1. Количество использованной swap-памяти

Каковы значения столбцов "us", "sy", "id" и "wa" в выводе утилиты vmstat?
   1. Загрузка CPU по пользователям, системным процессам, в режиме простоя и ввода-вывода
   1. Количество активных пользовательских процессов, системных процессов, системных прерываний и переключений контекста
   1. Среднее время отклика системы на запросы, средняя длина очереди ввода-вывода
   1. Количество входящих и исходящих блоков дисковой активности

   Ответ: 1. Загрузка CPU по пользователям, системным процессам, в режиме простоя и ввода-вывода

Что представляет собой столбец "bi" в выводе утилиты vmstat?
   1. Количество запросов на блоковую активность, генерируемых приложениями
   1. Количество входящих запросов блоков дисковой активности
   1. Количество "грязных" буферов памяти
   1. Количество входящих блоков данных из сети

   Ответ: 2. Количество входящих запросов блоков дисковой активности

Виртуальная память в Linux часто требует оптимизации для обеспечения эффективного использования ресурсов и улучшения производительности. Вот несколько ключевых способов оптимизации виртуальной памяти в Linux:

1. Настройка параметров ядра: В Linux существует множество параметров ядра, которые можно настроить для оптимизации управления виртуальной памятью. Например, параметры, связанные с управлением swap-памятью, стратегиями замещения страниц и т.д.

2. Использование Huge Pages: Huge Pages представляют собой механизм, позволяющий выделять большие страницы памяти для снижения накладных расходов обслуживания страниц и увеличения производительности, особенно при работе с большими массивами данных или базами данных.

3. Управление swap-памятью: Эффективное управление swap-памятью важно для избегания излишне активного использования обменной области. Настройка предельных значений использования swap-памяти, а также следящих параметров, помогает улучшить производительность.

4. Контроль использования кэша страниц: Оптимизация параметров, связанных с кэшированием страниц, помогает улучшить быстродействие, уменьшая количество страничных промахов.

5. Использование профилирования и мониторинга: Профилирование и мониторинг использования памяти позволяют выявить слабые стороны и узкие места в работе с виртуальной памятью, что в свою очередь позволяет принимать дальнейшие меры по оптимизации.

6. Настройка системы управления памятью: Настройка параметров и поведения системы управления памятью, таких как swappiness, ограничение объема памяти, выделяемого под кэширование, позволяет более точно контролировать использование ресурсов.

7. Использование NUMA (Non-Uniform Memory Access): В системах с множеством процессоров и памяти, оптимизация NUMA-конфигурации и использование соответствующих инструментов позволяют обеспечить лучшее распределение и доступ к памяти.

Сегодня мы узнали что такое виртуальная память и методы её реализации, рассмотрели примеры использования виртуальной памяти. Познакомились с таким механизмом как файл подкачки, разобрались в чём его отличие от виртуальной памяти. Рассмотрели алгоритмы управления виртуальной памятью, проблемы и влияние ВП на безопасность ОС. Рассмотрели утилиту vmstat, и способы оптимизации виртуальной памяти.

В следующем уроке поговорим о файловых системах.

