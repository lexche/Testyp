## Урок 2. Настройка файлового сервера

В этом уроке подробнее рассмотрим файловый сервер и разберём, как настроить его самостоятельно.

>[Реплика героя курса] Начнём!

Часто организациям нужен доступ к общим ресурсам — например, установочным дистрибутивам, документации и так далее. Зависит такой общий доступ в основном от протокола передачи данных.

>[Реплика героя курса] Основными протоколами считаются **SMB**, **NFS** и **FTP**. Их объединяет задача: предоставлять доступ к файлам по сети. 

![файловый сервер](https://code.s3.yandex.net/sys-admin-content/Мод.%202,%20спринт%203,%20тема%202,%20урок%202/Файловый%20сервер%20и%20протоколы.png?etag=2421b1559c48d875c2c54ccf15ec66f8)
>[Подпись] Ниже расссмотрим каждый протокол по отдельности

Зафиксируем определения:

>[На подложке] **FTP** (от англ. File Transfer Protocol — «протокол передачи данных») — стандартный протокол передачи файлов в компьютерных сетях, появившийся раньше SMB и NFS.

>[На подложке] **SMB** (от англ. Server Message Block — «блок сообщений сервера») используется для обмена файлами и другими ресурсами между устройствами в сети, управляемыми ОС семейства Windows.

>[На подложке] **NFS** (от англ. Network File System — сетевая файловая система) используется в Unix-подобных операционных системах.

### SMB, NFS и FTP: общее

Все эти протоколы обеспечивают **клиент-серверную модель взаимодействия**: сервер предоставляет доступ к файлам и ресурсам, а клиенты — как правило, другие компьютеры, — могут обращаться к ним и выполнять чтение, запись, изменение и удаление файлов. 

Также все они поддерживают аутентификацию, авторизацию и шифрование данных, обеспечивая безопасность передачи информации.

### SMB, NFS и FTP: чем различаются

>[Реплика героя курса] Главное различие — поддержка операционными системами.

Microsoft использует собственные разработки, поэтому в ОС семейства Windows нет встроенной поддержки протокола NFS по умолчанию. Такая же ситуация с Linux: для использования SMB понадобится дополнительное ПО. С FTP всё проще — бóльшая часть систем сразу умеет работать с ним.

Также у SMB более широкий список устройств и сервисов, которые используют его. К примеру, если в организации есть общий принтер, для обмена информацией он использует, скорее всего, именно этот протокол. NFS же разрабатывался для ОС семейства Unix и позволяет устройствам монтировать удалённые файловые директории так, будто они локальные.

>[На подложке] Из-за своей распространённости SMB — частая цель хакерских атак. Каждый компьютер под управлением Windows открыт для обработки протокола SMB по умолчанию, и это потенциально слабое место в системе безопасности.

#### Задание 

**Вопрос №1.** Может ли компьютер под управлением ОС Windows использовать NFS протокол?

- Да, нужно установить на него дополнительное ПО // _Вы правы! NFS разрабатывался под Unix-системы, поэтому понадобится вспомогательное программное обеспечение._

- Нет, придётся перенастроить NFS-сервер на другой протокол // _Довольно радикальное решение! На самом деле достаточно настроить Windows-клиенты с помощью специальных программ, которые позволят работать по NFS-протоколу._
  
- Windows по умолчанию поддерживает NFS, так что никаких дополнительных действий не потребуется // _В Windows нет встроенной поддержки этого протокола — он разрабатывался для Unix-систем._

**Вопрос №2.** Какая цель — основная для протоколов SMB, NFS и FTP?

- Осуществление доступа к файлам по сети // _Верно! Их главная задача — организовать совместное использование файловых ресурсов в сети._
  
- Организация подключения сетевых принтеров для совместного использования // _Для этой цели действительно используется протокол SMB, но это его второстепенная задача._
  
- Более безопасная авторизация пользователей при доступе к данным // _Это дополнительная функция для повышения безопасности, но не основная. Делать авторизированный доступ для всех файлов совсем не обязательно._

**Вопрос №3.** Какой из протоколов поддерживается большинством ОС по умолчанию?

- NFS // _Этот протокол разработан для Unix-систем, и в случае с Windows потребуется дополнительное ПО._
  
- SMB // _SMB по умолчанию поддерживается ОС семейства Windows, но не Unix-системами._
  
- FTP // _Верно! Если ваш сервер работает по FTP — к нему смогут получить доступ как Windows, так и Unix-клиенты._

## Настройка файлового сервера

>[Реплика героя курса] Настало время для практики! Дальше разберём, как создать собственный файловый сервер. 

>[На подложке] Суть настройки заключается вот в чём: на сервере, который будет выступать в качестве файлового, нужно установить необходимые пакеты, а затем указать пользователей и директории в файле конфигурации. 

В качестве сервера у нас виртуальная машина VM-1 с ОС Ubuntu 22.04. Начнём с установки пакета для реализации SMB-протокола, который называется ```*samba*```:

```c
sudo apt install samba -y
```

Если операция завершится успешно, отобразится следующее:

```c
Done
Setting up samba (2:4.15.13+dfsg-0ubuntu1.5) ...
Adding group `sambashare' (GID 120) ...
Done.
Samba is not being run as an AD Domain Controller: Masking samba-ad-dc.service
Please ignore the following error about deb-systemd-helper not finding those services.
(samba-ad-dc.service masked)
Created symlink /etc/systemd/system/multi-user.target.wants/nmbd.service → /lib/systemd/system/nmbd.service.
Failed to preset unit: Unit file /etc/systemd/system/samba-ad-dc.service is masked.
/usr/bin/deb-systemd-helper: error: systemctl preset failed on samba-ad-dc.service: No such file or directory
Created symlink /etc/systemd/system/multi-user.target.wants/smbd.service → /lib/systemd/system/smbd.service.
samba-ad-dc.service is a disabled or a static unit, not starting it.
Processing triggers for ufw (0.36.1-4ubuntu0.1) ...
Processing triggers for man-db (2.10.2-1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.6) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host
```

После установки конфигурационный файл окажется в директории ```*/etc/samba/smb.conf*```. Прежде чем приступим к его редактированию, сохраним исходный файл настроек — так мы не потеряем начальную конфигурацию в случае ошибки:

```c
sudo cp /etc/samba/smb.conf /etc/samba/smb_backup.conf
```

Так как SMB-протокол предоставляет доступ к файлам в определённой директории, её нужно предварительно создать:

```c
sudo mkdir -p /smb/share
```

Предоставим права доступа к директории для всех пользователей:

```c
sudo chmod 777 /smb/share
```

Теперь отредактируем конфигурационный файл нашего SMB-сервиса:

```c
sudo nano /etc/samba/smb.conf
```

>[На подложке] У файла настроек такая же структура, как и у большинства конфигурационных файлов в Linux: символом ```#``` выделяются комментарии со справочной информацией для пользователей, остальные строки содержат значения по умолчанию. 

Внесём изменения в конец файла:

```c
[share]
    comment = Общая директория
    path = /smb/share
    public = yes
    writable = yes
    read only = no
    guest ok = yes
    force create mode = 0777
    force directory mode = 0777
```

Рассмотрим каждый компонент по отдельности:

- ```[share]``` 一 имя ресурса.                                                                             

- ```comment = Общая директория``` 一 комментарий. 

>[На подложке] Старайтесь оставлять комментарии во всех конфигурационных файлах, в которые вносите изменения. В будущем они пригодятся вам.
                                            
- ```path = /smb/share``` 一 путь к директории, к которой предоставляем доступ.                                                       

- ```public = yes``` 一 доступ на чтение всем авторизованным и неавторизованным пользователям.                                                                       
- ```writable = yes``` 一 предоставление прав на запись.

- ```read only = no``` 一 дословно переводится как «только чтение». При значении ```*no*``` все пользователи получают право на создание директорий и файлов.                                 
- ```guest ok = yes``` 一 предоставление прав на гостевой доступ записи.                      

- Последние два параметра задают права доступа, которые назначаются при создании файлов и каталогов внутри общей папки. В нашем случае это доступ для всех пользователей.

Конфигурационный файл готов! Сервис SMB на нашем сервере Ubuntu обрабатывается службой ```smbd.service```. Чтобы внесённые изменения вступили в силу, нужно перезапустить сервис следующей командой:

```c
sudo systemctl restart smbd.service
```

Теперь проверим подключение к нашей директории с другой виртуальной машины VM-2. Для работы с SMB-протоколом нам понадобится пакет ```cifs```:

```c
sudo apt install cifs-utils -y
```

После успешной установки вы сможете смонтировать общую директорию ```share```, находящуюся на виртуальном сервере VM-1:

```c
mount.cifs [общий ресурс] [путь к директории, в которую монтируем] [-o опции]
```

В нашем случае команда выглядит так:

```c
mount.cifs //192.168.0.107/share  /mnt
```

Где ```192.168.0.107``` – ip-адрес нашего сервера VM-1. Теперь создадим файл для проверки работоспособности общей папки:

```c
sudo touch /mnt/test
```

Вернёмся на виртуальный сервер VM-1 и проверим содержимое папки ```/smb/share``` командой:

```c
ls -l /smb/share
```

Файл, созданный через виртуальную машину VM-2, появился в общей папке, расположенной на виртуальном сервере VM-1:

```c
administrator@vm-1:~$ ls -l /smb/share/
total 0
-rwxrwxr-x 1 nobody nogroup 0 Jan 12 17:37 test
```

>[Реплика героя курса] Урок подошёл к завершению! Впереди вас ждёт практическое задание.

## Практическое задание

Опираясь на инструкции из урока, попробуйте создать собственный файловый сервер и проверить наличие доступа к общей папке.

>[Кнопка-переход] Готово! Продолжить обучение
