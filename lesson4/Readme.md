## Урок 4. Обработка прерываний и взаимодействие с устройствами.

Вы работаете на компьютере, и вдруг подключаете новое устройство, например, USB-накопитель. Как операционная система распознает и интегрирует новое устройство, позволяя вам с ним взаимодействовать?

Диску даются команды на сохранение данных. Какую стратегию выбрать: постоянно активно ждать, когда диск закончит (а он медленный) или пойти заниматься своими делами, пока диск не сообщит об окончании выполнения операции.

Во втором уроке мы познакомились с понятием прерывания аппаратного обеспечения, давайте более детально рассмотрим этот процесс.
Прерывания в операционных системах - это способ, с помощью которого аппаратные устройства или другие программы могут сообщить ОС о событиях, требующих немедленного внимания от завершения операции ввода-вывода до ошибки обращения к памяти. Прерывания играют ключевую роль в управлении аппаратными устройствами и взаимодействии между программным обеспечением и оборудованием. Правильная обработка прерываний - это ключевой компонент для обеспечения правильной работы аппаратных устройств. Неправильная обработка или упущенные прерывания могут привести к ошибкам ввода-вывода, потере данных или даже критическим сбоям оборудования.

Когда речь заходит о механизме обработки прерываний, мы имеем дело с сигналами, возникающими из внешних источников, таких как устройства ввода-вывода. Независимо от того, на какой архитектуре процессора это происходит, существует общая суть в обработке прерываний - изменение последовательности выполнения команд.

Давайте пошагово рассмотрим, как обрабатываются прерывания.

1. Прием и идентификация сигнала прерывания: Процессор обнаруживает поступление прерывания и определяет его источник.

2. Запоминание состояния прерванного процесса: Текущее состояние прерванной программы сохраняется, включая адрес следующей команды, содержимое регистров процессора и информацию о режиме выполнения программы.

3. Передача управления программе обработки прерывания: Процессор передает управление специальной программе обработки прерывания, определенной заранее.

4. Сохранение информации о прерванной программе: Если какая-то информация о прерванной программе не была сохранена на предыдущем этапе, то аппаратные средства предпринимают действия для ее сохранения.

5. Обработка прерывания: Выполняется код, предназначенный для обработки данного типа прерывания. Обычно это вызов соответствующей подпрограммы.

6. Восстановление информации о прерванном процессе: Если какая-то информация была временно изменена для обработки прерывания, она восстанавливается.

7. Возвращение к прерванной программе: После обработки прерывания процессор возвращает управление к прерванной программе, позволяя ей продолжить выполнение.

Эти шаги показывают, что аппаратные средства (процессор и его периферийные устройства) выполняют первые три шага, а программное обеспечение, включая операционную систему, обрабатывает оставшиеся шаги, включая обработку прерывания и восстановление прерванной программы.

Таким образом, механизм обработки прерываний представляет собой сложное взаимодействие между аппаратными и программными компонентами системы, обеспечивающее надлежащее управление внешними сигналами, поступающими в процесс обработки.

Основные типы прерываний:

- Аппаратное прерывание. Когда процессор занят выполнением своих обычных задач, внезапно поступает сигнал от внешнего устройства, это и есть аппаратное прерывание. Такое устройство может быть, например, клавиатурой, которую нажал пользователь, или диском, который завершил чтение данных. Оно важно и требует немедленной реакции. Другим примером является прерывание таймера, которое используется операционной системой для стратегии управления задачами. Каждое аппаратное прерывание имеет свой уникальный номер, по которому процессор определяет, какое именно прерывание произошло, и затем выполняет соответствующую обработку.

- Программное прерывание. возникает в результате выполнения команды прерывания (INT) программой. Это происходит синхронно в контексте выполнения программы. Каждое программное прерывание также имеет свой номер, задаваемый при вызове команды INT. Оно используется для вызова функций операционной системы, известных как системные вызовы. Эти прерывания используются для ограниченного доступа к функциям ядра ОС, например, для запроса работы с файлами или создания новых процессов.

- Исключительные ситуации. Исключительная ситуация (ИС) представляет собой событие, возникающее в результате выполнения недопустимой команды программой. Это тоже происходит синхронно, непосредственно в контексте текущей задачи. Исключительные ситуации могут быть исправимыми или неисправимыми. Исправимая ситуация также может произойти в обычной работе программы, и после устранения причины (например, оперативная подкачка памяти) программа продолжает работу. Неисправимые ситуации, как правило, происходят из-за ошибок в программах, и ОС обычно завершает работу процесса, вызвавшего такую ситуацию.

Итак, чтобы не путать прерывания и системные вызовы, рассмотрим их через аналогии.
- Прерывания: Представьте себе ситуацию, когда вы заняты чем-то очень важным, но внезапно постучали в дверь. В тот момент вам нужно ответить на этот внешний запрос, сделать что-то, чтобы обработать ситуацию (и, возможно, в перспективе запомнить, где вы остановились). После того как вы ответили на запрос, вы возвращаетесь к выполнению своих первоначальных дел. Это похоже на то, как процессор обрабатывает прерывания - он приостанавливает текущую задачу, чтобы обработать внешний запрос, а затем возвращается к выполнению.

- Системные вызовы: Теперь представьте, что у вас есть список дел, которые нужно сделать, и вам нужно попросить кого-то (скажем, помощника) выполнить конкретную задачу из вашего списка. Вы делаете системный вызов, и операционная система (ваш помощник) обращается к ядру (вашему ассистенту), чтобы выполнить необходимую задачу. После завершения задачи системный вызов возвращает вам результат и вы продолжаете выполнять свои первоначальные дела. Этот процесс напоминает реализацию системных вызовов.

Таким образом, прерывания и системные вызовы оба позволяют программам взаимодействовать с аппаратурой и ресурсами операционной системы, хотя способы этого взаимодействия и цели отличаются. Подобно тому, как прерывания позволяют аппаратным устройствам "прерывать" обычный ход программы, системные вызовы позволяют программам обратиться к функциям ядра ОС для выполнения определенных задач.

Представим, что в наш компьютер вставлено новое USB-устройство, давайте разберём как на это отреагирует ОС:

 1. Подключение устройства:
Когда ты вставляешь устройство в компьютер, аппаратные устройства обнаруживают это действие. Например, шина USB обнаруживает подключение нового устройства.

2. Инициация прерывания:
Шина USB генерирует прерывание для операционной системы, чтобы показать, что новое устройство было подключено. Это прерывание оповещает операционную систему о необходимости взаимодействия с подключенным устройством.

3. Обработка прерывания:
Когда операционная система получает прерывание от шины USB, она перехватывает его и запускает соответствующий обработчик прерывания, который начинает процесс идентификации и обработки нового устройства.

4. Загрузка соответствующего драйвера:
Операционная система идентифицирует устройство как устройство и загружает соответствующий драйвер для работы с ним. Драйвер устройства может быть автоматически загружен из системных ресурсов или, если он еще не установлен, операционная система может запросить у пользователя разрешение на поиск и установку драйвера.

5. Установление соединения:
После загрузки драйвера операционная система устанавливает связь с устройством, используя его функциональность для обмена данными.

6. Предоставление доступа к устройству:
Когда устройство успешно прошла процесс инициализации, операционная система предоставляет приложениям возможность обращаться к устройству через соответствующий драйвер. Такие приложения могут читать данные с устройства.
  
## ПЗ

Описать процесс, который происходит в операционной системе, когда пользователь подключает новое USB-устройство.

Подключение устройства, инициация прерывания, обработка прерывания, загрузка соответствующего драйвера, установление соединения, предоставление доступа к устройству.

Архитектура прерываний в Linux представляет из себя сложную систему, которая позволяет обеспечивать отзывчивость системы, обрабатывать асинхронные события, управлять устройствами ввода-вывода и эффективно управлять ресурсами компьютера. Давай разберем некоторые ключевые аспекты архитектуры прерываний в Linux:

В Linux используется несколько уровней прерываний, каждый из которых имеет свой приоритет и предназначен для определенного типа обработки. Это включает уровни обработки прерываний процессора (как аппаратные уровни), а также уровни абстракции в ядре Linux. Для обработки прерываний в Linux используются такие уровни, как "интерактивные прерывания" (IRQ), "первичные прерывания" (primary interrupts) и "векторы прерываний" (interrupt vectors).

Когда происходит прерывание, управление передается со стандартного выполнения программы на специальный обработчик прерывания (interrupt handler). В Linux для каждого типа прерывания может быть определен соответствующий обработчик, который выполняет необходимую логику для обработки прерывания.

В современных компьютерах прерывания обрабатываются программными устройствами, такими как APIC (Advanced Programmable Interrupt Controller). APIC предоставляет улучшенный механизм обработки прерываний в многоядерных системах и обеспечивает распределение прерываний между несколькими процессорами.

Прерывания также используются для управления операциями прямого доступа к памяти (DMA). DMA позволяет устройствам ввода-вывода напрямую обмениваться данными с памятью, минуя центральный процессор. Обработка прерываний в этом контексте позволяет эффективно управлять вводом-выводом и обрабатывать асинхронные операции с устройствами.

Архитектура прерываний в Linux играет ключевую роль в обеспечении отзывчивости системы и управлении ресурсами. Она позволяет системе эффективно переключаться между обработкой прерываний и выполнением задач, что влияет на общую многозадачность системы, способность управлять ресурсами, обеспечивать отзывчивость системы и обрабатывать асинхронные операции.

Давайте рассмотрим на примере нескольких устройств их взаимодействие с ОС:

- Сетевая карта. Когда операционная система загружается, она инициирует взаимодействие с сетевой картой, загружая соответствующий драйвер. Этот драйвер позволяет операционной системе обмениваться данными с картой и управлять ее функциональностью. При отправке или получении данных через сеть, сетевая карта генерирует прерывания, на которые операционная система реагирует, вызывая соответствующий драйвер и обрабатывая данные для обеспечения связи.

- Принтер. При отправке печатных данных на принтер, операционная система взаимодействует с драйвером принтера, чтобы передать данные принтеру и управлять процессом печати. Процесс зависит от типа принтера (например, лазерный, струйный, сетевой), и может включать использование различных протоколов и интерфейсов для эффективной передачи и обработки данных.

- Сенсорный экран. Сенсорные экраны обычно взаимодействуют с операционной системой через специальные драйверы, которые идентифицируют касания и жесты пользователя. Драйверы учитывают данные о касаниях и передают их операционной системе. Операционная система затем обрабатывает эти данные, переводя касания пользователя в соответствующие действия, такие как перемещение курсора, сенсорные жесты и ввод текста.

- Жесткий диск. Когда операционная система загружается, она инициирует взаимодействие с жестким диском, используя соответствующие драйверы для обмена данными и управления файловой системой. При необходимости операционная система обращается к драйверам для чтения и записи данных на жесткий диск, а также для управления его состоянием, таким как фрагментация и доступ к разделам.

В Linux для анализа журнала событий системы и идентификации прерываний можно использовать различные инструменты и журналы. Вот несколько возможных способов нахождения и интерпретации прерываний в Linux:

- Журнал ядра (kernel log). В Linux ядро предоставляет различные журналы, включая dmesg, которые содержат информацию о прерываниях и их обработке. Вы можете использовать команду dmesg для просмотра журнала ядра и поиска записей о прерываниях, ошибках и других системных событиях.

   ```bash
   dmesg | grep -i irq
   ```
Это позволит вам найти записи, связанные с обработкой прерываний в ядре Linux.

- Процессорные файлы виртуальной файловой системы (proc). В Linux можно получить доступ к информации о прерываниях через файловую систему proc. Например, файл /proc/interrupts содержит информацию о количестве прерываний, обработанных каждым процессором. Вы можете использовать команду cat для чтения содержимого этого файла.

   ```bash
   cat /proc/interrupts
   ```
Это поможет вам увидеть статистику по прерываниям и определить, какие устройства или драйверы могут быть источниками прерываний в системе.

- Инструменты профилирования и мониторинга. Для более подробного анализа прерываний вы можете использовать инструменты профилирования и мониторинга, такие как perf, strace, sysstat и другие, которые могут предоставить расширенную информацию о системных событиях, включая прерывания.

- Документация ядра Linux. Также важно обратиться к документации Linux, в которой содержится множество сведений о конфигурации ядра, опциях обработки прерываний, а также о методах и инструментах для их анализа.

Анализ журнала событий системы в Linux для идентификации и интерпретации прерываний может быть осуществлен с использованием журналов ядра, файловой системы proc, специализированных инструментов профилирования и мониторинга, а также справочной информации в документации ядра.

## ПЗ

Вопрос: Как найти информацию о прерываниях в журнале ядра Linux?
Варианты ответов:
1. С использованием команды interrupts
2. Через файл /var/log/irqlog
3. Командой dmesg с фильтром по ключевым словам прерываний
4. Через файл /proc/interrupts /Верно

Вопрос: Какие данные можно получить из файла /proc/interrupts?
Варианты ответов:
1. Количество открытых файловых дескрипторов
2. Список модулей ядра
3. Информация о процессах, использующих CPU
4. Статистика по количеству обработанных прерываний каждым процессором /Верно

Вопрос: Какой инструмент Linux можно использовать для более детального анализа прерываний?
Варианты ответов:
1. apt update
2. top
3. ls
4. perf /Верно

## Пз по всему уроку

1. Что такое прерывание в контексте операционной системы?
   - a) Механизм исполнения параллельных задач
   - b) Механизм, позволяющий устройствам или программам прервать обычный ход выполнения процессора  /Верно
   - c) Механизм переключения процессов в многозадачной системе

2. Какой процесс происходит при возникновении прерывания в системе?
   - a) Процессор переходит в спящий режим
   - b) Процессор переключает контекст исполнения на другую задачу
   - c) Процессор приостанавливает текущую работу и начинает выполнение обработчика прерывания   /Верно
  

3. Какие задачи выполняются во время обработки прерывания?
   - a) Сохранение состояния прерванного процесса, выполнение кода обработчика прерывания, восстановление состояния прерванного процесса   /Верно
   - b) Запуск нового процесса, завершение текущего процесса, сохранение состояния обработчика прерывания
   - c) Отправка уведомлений другим устройствам, переход в защищенный режим ядра
  

4. Какое значение имеет процесс обработки прерывания в управлении устройствами операционной системы?
   - a) Он позволяет операционной системе взаимодействовать с пользователем
   - b) Он обеспечивает асинхронное взаимодействие с устройствами и управление ими  /Верно
   - c) Он определяет приоритеты процессов в системе

Мы изучили обработки прерываний в ОС Linux, а именно: основные механизмы, типы, принцип, архитектуру взаимодействия ОС с аппаратными устройствами через драйверы и прерывания. Рассмотрели как через прерывания взаимодействуют с ОС различные устройства. Выяснили в чём разница междупрерываниями и системными вызовами. Узнали откуда и как брть информацию о прерываниях для анализов.
