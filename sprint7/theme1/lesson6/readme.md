## Урок 6. Протокол iSCSI 

Протокол iSCSI (Internet Small Computer System Interface) представляет собой стандартный протокол передачи данных, который позволяет SCSI командам, используемым для управления устройствами хранения данных, быть передаваемыми через сети TCP/IP. Он позволяет использовать существующую инфраструктуру сетей TCP/IP для доступа к удаленным блочным устройствам, таким как жесткие диски, как если бы они были локально подключены.

iSCSI получил широкое распространение благодаря своей способности обеспечивать гибкое и эффективное сетевое хранилище. Также он нашел применение в больших предприятиях, где его гибкость и расширяемость делают его привлекательным вариантом для создания виртуальных хранилищ и облачных вычислений.

Исторически протокол iSCSI был разработан с целью упростить и сделать более доступным доступ к хранилищам данных через сеть. Этот протокол претерпел несколько иттераций, вот небольшая историческая справка:

iSCSI v0: Это первая версия протокола, которая появилась в конце 1990-х годов. Она представляла собой предварительный вариант и включала базовые функции для передачи SCSI команд через сеть TCP/IP.

iSCSI v1: Это официально утвержденная версия протокола, определенная в RFC 3720 в 2004 году. Она включала ряд улучшений по сравнению с предыдущей версией, таких как добавление поддержки CHAP (Challenge Handshake Authentication Protocol) для аутентификации, а также оптимизацию производительности.

iSCSI v2: Версия v2 была определена в RFC 5048 в 2007 году. Она внесла некоторые уточнения и корректировки в протокол, но в целом не внесла существенных изменений по сравнению с версией 1.

iSCSI v3: Эта версия была определена в RFC 7143 в 2014 году. Она включила ряд значительных улучшений, таких как поддержка обнаружения и восстановления ошибок (Error Recovery Level) для повышения надежности передачи данных, а также добавление поддержки новых возможностей, таких как качество обслуживания (Quality of Service, QoS).

iSCSI v4: На момент моего последнего обновления в январе 2022 года, стандарт iSCSI v4 еще не был окончательно утвержден. Однако предполагается, что он будет включать дальнейшие улучшения производительности, безопасности и функциональности, такие как поддержка более высоких скоростей передачи данных и интеграция с современными технологиями хранения данных, такими как NVMe (Non-Volatile Memory Express).

Разберём как работает пакет iSCSI:

1. Инициация соединения:
   - Процесс начинается с инициирования соединения между инициатором (клиентским устройством) и целью (устройством хранения данных) по сети TCP/IP. Обычно это происходит через указанный порт TCP 3260 на целевом устройстве.
   - Инициатор может определить цель с помощью IP-адреса или DNS-имени, а также указать порт для соединения.

2. Аутентификация (опционально):
   - После установления соединения инициатор и цель могут провести процесс аутентификации для обеспечения безопасности передачи данных. Один из наиболее распространенных методов - CHAP (Challenge Handshake Authentication Protocol).

3. Сеанс и обмен параметрами:
   - Инициатор и цель устанавливают сеанс и обмениваются параметрами протокола. Это включает в себя определение доступных блочных устройств, протокол обмена данными (например, TCP или UDP), максимальный размер передаваемых блоков и другие параметры.

4. Передача SCSI команд:
   - Инициатор отправляет SCSI команды (такие как чтение, запись, запрос состояния) цели через установленное TCP-соединение.
   - Цель получает команды и выполняет соответствующие операции с данными на своих устройствах хранения.

5. Передача данных:
   - Цель может возвращать результаты выполненных команд и данные обратно инициатору через то же TCP-соединение.
   - Обмен данными может включать передачу больших блоков данных в обоих направлениях.

6. Завершение соединения:
   - По завершении передачи данных или при необходимости разрывается TCP-соединение между инициатором и целью.

Протокол iSCSI состоит из нескольких основных компонентов (или сервисов), каждый из которых выполняет определенные функции в процессе передачи данных:

1. Инициатор iSCSI (iSCSI Initiator):
   - Это программное или аппаратное устройство, которое инициирует запросы к удаленному устройству хранения данных по протоколу iSCSI.
   - Инициатор обеспечивает интерфейс для отправки SCSI команд цели и обработки ответов от нее.

Основные службы, которые запускаются при работе iSCSI Initiator в Linux:

a. iSCSI Initiator Daemon (iscsid) - это основной демон, который управляет установлением соединения с удаленным iSCSI-устройством. Демон iscsid обрабатывает запросы и управляет отправкой и приемом iSCSI-команд между инициатором и целью iSCSI.

b. iSCSI Discovery Daemon (iscsidtd) - этот демон отвечает за процесс обнаружения удаленных iSCSI-устройств и добавления их в список известных целей. Он ищет доступные устройства по сети и подключает их к системе через iSCSI Initiator Daemon.

c. iSCSI Multipath - это независимый компонент, который обеспечивает возможность использования нескольких путей для подключения к одной цели iSCSI. Он позволяет балансировать нагрузку и обеспечивать отказоустойчивость при использовании iSCSI-устройств.

d. iSCSI Service - это служба, которая обеспечивает общий контроль и управление передачей данных между инициатором и удаленным iSCSI-устройством. Она работает в тесном взаимодействии с iscsid для обеспечения стабильной и надежной работы соединения.

e. TCP/IP Networking - в Linux TCP/IP является стандартным протоколом передачи данных через IP-сеть. Для работы iSCSI Initiator необходимо, чтобы TCP/IP был установлен и настроен правильно для передачи данных между инициатором и целью iSCSI.

f. Multipathd - этот демон отвечает за мониторинг и управление мультипутевыми соединениями, созданными с помощью iSCSI Multipath. Он обеспечивает автоматическое восстановление соединения в случае отказа одного из путей.

2. Цель iSCSI (iSCSI Target):
   - Это устройство, которое предоставляет доступ к блочным устройствам хранения данных по протоколу iSCSI.
   - Цель обрабатывает SCSI команды, полученные от инициатора, выполняет операции чтения/записи на блочных устройствах и возвращает результаты обратно инициатору.

Работа iSCSI target включает в себя несколько служб, которые обеспечивают функциональность и управление удаленными блочными устройствами. Распишем каждую службу:

a. iSCSI Target Daemon (iscsid):
   - Это основная служба, ответственная за обработку запросов от инициаторов iSCSI и управление удаленными блочными устройствами.
   - Когда инициатор iSCSI подключается к цели iSCSI, служба iscsid обрабатывает этот запрос, аутентифицирует инициатора (если настроено), и предоставляет доступ к запрошенным блочным устройствам.
   - Эта служба обычно запускается автоматически при загрузке системы и управляется менеджером служб (например, systemd в большинстве современных дистрибутивах Linux).

b. iSCSI Target Management Utility (tgtadm):
   - Это утилита командной строки, которая предоставляет интерфейс для управления iSCSI target и его конфигурацией.
   - С помощью tgtadm можно добавлять, удалять и изменять конфигурацию блочных устройств, настраивать параметры аутентификации и авторизации, а также мониторить состояние iSCSI target.
   - Утилита tgtadm обычно не является службой, но может быть использована администратором для управления iSCSI target из командной строки.

c. iSCSI Target Portal Group Daemon (iscsiportald):
   - Эта служба отвечает за управление сетевыми порталами iSCSI.
   - Портал iSCSI - это комбинация IP-адреса и TCP-порта, через которые инициатор iSCSI может подключиться к цели iSCSI.
   - Служба iscsiportald отслеживает доступные порталы и обрабатывает подключения инициаторов к правильным блочным устройствам.
   - Обычно iscsiportald запускается автоматически при загрузке системы и управляется менеджером служб.

d. iSCSI Target Authentication Daemon (iscsi_trgt) (по желанию):
   - Это дополнительная служба, которая обеспечивает аутентификацию и авторизацию инициаторов iSCSI.
   - Если включена аутентификация и авторизация, служба iscsi_trgt отвечает за обработку запросов на аутентификацию и проверку прав доступа инициаторов.
   - Эта служба также запускается автоматически при загрузке системы и управляется менеджером служб, если она используется.

3. Механизм аутентификации:
   - Опциональный компонент, который обеспечивает аутентификацию между инициатором и целью для обеспечения безопасности передачи данных.
   - Различные методы аутентификации могут быть использованы, включая CHAP (Challenge Handshake Authentication Protocol) или другие механизмы аутентификации.

### Квиз


1. Что такое iSCSI?
   - A) Протокол для передачи данных по сети Ethernet.
   - B) Протокол для доступа к блочным устройствам по сети TCP/IP.
   - C) Протокол для передачи данных по Wi-Fi.
   - D) Протокол для передачи голосовой информации по Интернету.

   Правильный ответ: B) Протокол для доступа к блочным устройствам по сети TCP/IP.  
   iSCSI (Internet Small Computer System Interface) - это протокол для доступа к блочным устройствам, таким как диски, по сети TCP/IP.

2. Какой компонент необходим для реализации iSCSI?
   - A) Специальная сетевая карта iSCSI.
   - B) Программное обеспечение iSCSI Initiator.
   - C) Только серверное оборудование.
   - D) Только коммутатор Ethernet.

   Правильный ответ: B) Программное обеспечение iSCSI Initiator.  
   Для реализации iSCSI необходимо установить специальное программное обеспечение на клиентской стороне, называемое iSCSI Initiator.

3.  Какая служба отвечает за обнаружение удаленных iSCSI-устройств в ОС Linux?
   A) iSCSI Initiator Daemon (iscsid)
   B) iSCSI Discovery Daemon (iscsidtd)
   C) iSCSI Multipath
   D) Multipathd

Правильный ответ: B) iSCSI Discovery Daemon (iscsidtd). Этот демон отвечает за процесс обнаружения удаленных iSCSI-устройств и их добавление в список известных целей.

4. Какие протоколы используются в iSCSI для обеспечения надежной доставки данных?
   - A) TCP и UDP.
   - B) HTTP и FTP.
   - C) ICMP и ARP.
   - D) TCP и IP.

   Правильный ответ: D) TCP и IP.  
   iSCSI использует TCP (Transmission Control Protocol) для обеспечения надежной доставки данных и IP (Internet Protocol) для маршрутизации и идентификации устройств в сети.

___





