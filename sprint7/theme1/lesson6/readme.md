## Урок 6. Протокол iSCSI 

Протокол iSCSI (Internet Small Computer System Interface) представляет собой стандартный протокол передачи данных, который позволяет SCSI командам, используемым для управления устройствами хранения данных, быть передаваемыми через сети TCP/IP. Он позволяет использовать существующую инфраструктуру сетей TCP/IP для доступа к удаленным блочным устройствам, таким как жесткие диски, как если бы они были локально подключены.

iSCSI получил широкое распространение благодаря своей способности обеспечивать гибкое и эффективное сетевое хранилище. Также он нашел применение в больших предприятиях, где его гибкость и расширяемость делают его привлекательным вариантом для создания виртуальных хранилищ и облачных вычислений.

Исторически протокол iSCSI был разработан с целью упростить и сделать более доступным доступ к хранилищам данных через сеть. Этот протокол претерпел несколько иттераций, вот небольшая историческая справка:

iSCSI v0: Это первая версия протокола, которая появилась в конце 1990-х годов. Она представляла собой предварительный вариант и включала базовые функции для передачи SCSI команд через сеть TCP/IP.

iSCSI v1: Это официально утвержденная версия протокола, определенная в RFC 3720 в 2004 году. Она включала ряд улучшений по сравнению с предыдущей версией, таких как добавление поддержки CHAP (Challenge Handshake Authentication Protocol) для аутентификации, а также оптимизацию производительности.

iSCSI v2: Версия v2 была определена в RFC 5048 в 2007 году. Она внесла некоторые уточнения и корректировки в протокол, но в целом не внесла существенных изменений по сравнению с версией 1.

iSCSI v3: Эта версия была определена в RFC 7143 в 2014 году. Она включила ряд значительных улучшений, таких как поддержка обнаружения и восстановления ошибок (Error Recovery Level) для повышения надежности передачи данных, а также добавление поддержки новых возможностей, таких как качество обслуживания (Quality of Service, QoS).

iSCSI v4: На момент моего последнего обновления в январе 2022 года, стандарт iSCSI v4 еще не был окончательно утвержден. Однако предполагается, что он будет включать дальнейшие улучшения производительности, безопасности и функциональности, такие как поддержка более высоких скоростей передачи данных и интеграция с современными технологиями хранения данных, такими как NVMe (Non-Volatile Memory Express).

Разберём как работает пакет iSCSI:

1. Инициация соединения:
   - Процесс начинается с инициирования соединения между инициатором (клиентским устройством) и целью (устройством хранения данных) по сети TCP/IP. Обычно это происходит через указанный порт TCP 3260 на целевом устройстве.
   - Инициатор может определить цель с помощью IP-адреса или DNS-имени, а также указать порт для соединения.

2. Аутентификация (опционально):
   - После установления соединения инициатор и цель могут провести процесс аутентификации для обеспечения безопасности передачи данных. Один из наиболее распространенных методов - CHAP (Challenge Handshake Authentication Protocol).

3. Сеанс и обмен параметрами:
   - Инициатор и цель устанавливают сеанс и обмениваются параметрами протокола. Это включает в себя определение доступных блочных устройств, протокол обмена данными (например, TCP или UDP), максимальный размер передаваемых блоков и другие параметры.

4. Передача SCSI команд:
   - Инициатор отправляет SCSI команды (такие как чтение, запись, запрос состояния) цели через установленное TCP-соединение.
   - Цель получает команды и выполняет соответствующие операции с данными на своих устройствах хранения.

5. Передача данных:
   - Цель может возвращать результаты выполненных команд и данные обратно инициатору через то же TCP-соединение.
   - Обмен данными может включать передачу больших блоков данных в обоих направлениях.

6. Завершение соединения:
   - По завершении передачи данных или при необходимости разрывается TCP-соединение между инициатором и целью.

Протокол iSCSI состоит из нескольких основных компонентов (или сервисов), каждый из которых выполняет определенные функции в процессе передачи данных:

1. Инициатор iSCSI (iSCSI Initiator):
   - Это программное или аппаратное устройство, которое инициирует запросы к удаленному устройству хранения данных по протоколу iSCSI.
   - Инициатор обеспечивает интерфейс для отправки SCSI команд цели и обработки ответов от нее.

Основные службы, которые запускаются при работе iSCSI Initiator в Linux:

a. iSCSI Initiator Daemon (iscsid) - это основной демон, который управляет установлением соединения с удаленным iSCSI-устройством. Демон iscsid обрабатывает запросы и управляет отправкой и приемом iSCSI-команд между инициатором и целью iSCSI.

b. iSCSI Discovery Daemon (iscsidtd) - этот демон отвечает за процесс обнаружения удаленных iSCSI-устройств и добавления их в список известных целей. Он ищет доступные устройства по сети и подключает их к системе через iSCSI Initiator Daemon.

c. iSCSI Multipath - это независимый компонент, который обеспечивает возможность использования нескольких путей для подключения к одной цели iSCSI. Он позволяет балансировать нагрузку и обеспечивать отказоустойчивость при использовании iSCSI-устройств.

d. iSCSI Service - это служба, которая обеспечивает общий контроль и управление передачей данных между инициатором и удаленным iSCSI-устройством. Она работает в тесном взаимодействии с iscsid для обеспечения стабильной и надежной работы соединения.

e. TCP/IP Networking - в Linux TCP/IP является стандартным протоколом передачи данных через IP-сеть. Для работы iSCSI Initiator необходимо, чтобы TCP/IP был установлен и настроен правильно для передачи данных между инициатором и целью iSCSI.

f. Multipathd - этот демон отвечает за мониторинг и управление мультипутевыми соединениями, созданными с помощью iSCSI Multipath. Он обеспечивает автоматическое восстановление соединения в случае отказа одного из путей.

2. Цель iSCSI (iSCSI Target):
   - Это устройство, которое предоставляет доступ к блочным устройствам хранения данных по протоколу iSCSI.
   - Цель обрабатывает SCSI команды, полученные от инициатора, выполняет операции чтения/записи на блочных устройствах и возвращает результаты обратно инициатору.

Работа iSCSI target включает в себя несколько служб, которые обеспечивают функциональность и управление удаленными блочными устройствами. Распишем каждую службу:

a. iSCSI Target Daemon (iscsid):
   - Это основная служба, ответственная за обработку запросов от инициаторов iSCSI и управление удаленными блочными устройствами.
   - Когда инициатор iSCSI подключается к цели iSCSI, служба iscsid обрабатывает этот запрос, аутентифицирует инициатора (если настроено), и предоставляет доступ к запрошенным блочным устройствам.
   - Эта служба обычно запускается автоматически при загрузке системы и управляется менеджером служб (например, systemd в большинстве современных дистрибутивах Linux).

b. iSCSI Target Management Utility (tgtadm):
   - Это утилита командной строки, которая предоставляет интерфейс для управления iSCSI target и его конфигурацией.
   - С помощью tgtadm можно добавлять, удалять и изменять конфигурацию блочных устройств, настраивать параметры аутентификации и авторизации, а также мониторить состояние iSCSI target.
   - Утилита tgtadm обычно не является службой, но может быть использована администратором для управления iSCSI target из командной строки.

c. iSCSI Target Portal Group Daemon (iscsiportald):
   - Эта служба отвечает за управление сетевыми порталами iSCSI.
   - Портал iSCSI - это комбинация IP-адреса и TCP-порта, через которые инициатор iSCSI может подключиться к цели iSCSI.
   - Служба iscsiportald отслеживает доступные порталы и обрабатывает подключения инициаторов к правильным блочным устройствам.
   - Обычно iscsiportald запускается автоматически при загрузке системы и управляется менеджером служб.

d. iSCSI Target Authentication Daemon (iscsi_trgt) (по желанию):
   - Это дополнительная служба, которая обеспечивает аутентификацию и авторизацию инициаторов iSCSI.
   - Если включена аутентификация и авторизация, служба iscsi_trgt отвечает за обработку запросов на аутентификацию и проверку прав доступа инициаторов.
   - Эта служба также запускается автоматически при загрузке системы и управляется менеджером служб, если она используется.

3. Механизм аутентификации:
   - Опциональный компонент, который обеспечивает аутентификацию между инициатором и целью для обеспечения безопасности передачи данных.
   - Различные методы аутентификации могут быть использованы, включая CHAP (Challenge Handshake Authentication Protocol) или другие механизмы аутентификации.

### Квиз


1. Что такое iSCSI?
   - A) Протокол для передачи данных по сети Ethernet.
   - B) Протокол для доступа к блочным устройствам по сети TCP/IP.
   - C) Протокол для передачи данных по Wi-Fi.
   - D) Протокол для передачи голосовой информации по Интернету.

   Правильный ответ: B) Протокол для доступа к блочным устройствам по сети TCP/IP.  
   iSCSI (Internet Small Computer System Interface) - это протокол для доступа к блочным устройствам, таким как диски, по сети TCP/IP.

2. Какой компонент необходим для реализации iSCSI?
   - A) Специальная сетевая карта iSCSI.
   - B) Программное обеспечение iSCSI Initiator.
   - C) Только серверное оборудование.
   - D) Только коммутатор Ethernet.

   Правильный ответ: B) Программное обеспечение iSCSI Initiator.  
   Для реализации iSCSI необходимо установить специальное программное обеспечение на клиентской стороне, называемое iSCSI Initiator.

3.  Какая служба отвечает за обнаружение удаленных iSCSI-устройств в ОС Linux?
   A) iSCSI Initiator Daemon (iscsid)
   B) iSCSI Discovery Daemon (iscsidtd)
   C) iSCSI Multipath
   D) Multipathd

Правильный ответ: B) iSCSI Discovery Daemon (iscsidtd). Этот демон отвечает за процесс обнаружения удаленных iSCSI-устройств и их добавление в список известных целей.

4. Какие протоколы используются в iSCSI для обеспечения надежной доставки данных?
   - A) TCP и UDP.
   - B) HTTP и FTP.
   - C) ICMP и ARP.
   - D) TCP и IP.

   Правильный ответ: D) TCP и IP.  
   iSCSI использует TCP (Transmission Control Protocol) для обеспечения надежной доставки данных и IP (Internet Protocol) для маршрутизации и идентификации устройств в сети.

___


Рассмотрим процесс установки и настройки iSCSI target.

По хорошей традиции, выполните команду:

```
sudo apt update
```

Эта команда используется для обновления списка пакетов в вашем пакетном менеджере APT (Advanced Package Tool). Когда вы выполняете apt update, APT обновляет свою базу данных о доступных пакетах из источников (репозиториев). При выполнении этой команды вы убеждаетесь, что информация о доступных пакетах актуальна, прежде чем устанавливать что-либо новое.

Далее установим пакет tgt. tgt относится к пакету, предоставляющему инструменты для создания и управления целями iSCSI на Linux:

```
sudo apt install tgt

```

Создадим диск фиксированного размера 4 ГБ:

```
sudo dd if=/dev/zero of=/storage/lun0.img bs=1M count=4096
```

- dd: Эта команда в Linux используется для копирования данных и может использоваться для создания файлов или дискового образа.
- if=/dev/zero: Опция if указывает dd на источник данных для копирования. /dev/zero - это специальное устройство в Linux, которое генерирует поток нулей при чтении.
- of=/storage/lun0.img: Опция of указывает dd на место, куда будет записан результат копирования. В данном случае создается файл с именем lun0.img в директории /storage.
- bs=1M: Эта опция определяет размер блока данных, который dd будет копировать за один раз. Здесь 1M указывает, что блок будет размером 1 мегабайт.
- count=4096: Эта опция указывает dd сколько блоков данных нужно скопировать. В данном случае 2048 блоков, что при размере блока в 1 мегабайт дает файл размером 4 гигабайта.

Перейдём к созданию LUN (Logical Unit Number). LUN будет запоминающим устройством, к которому инициатор подключится и будет использовать его позже. 

1. Создание файла конфигурации для LUN:
   - Создаем файл конфигурации с именем some_iscsi.conf в каталоге /etc/tgt/conf.d/, который будет содержать настройки для нашего LUN.
   - Для этого используем текстовый редактор, например, nano.


2. Открытие файла в текстовом редакторе:
   - Мы открываем файл some_iscsi.conf в текстовом редакторе командой nano /etc/tgt/conf.d/some_iscsi.conf.

3. Настройка файла конфигурации:
   - В файле some_iscsi.conf мы указываем все необходимые параметры для настройки нашего LUN.

```
nano /etc/tgt/conf.d/some_iscsi.conf
```
Разберём пример такого конфигурационного файла:

```
<target iqn.2024-00.some.domain:lun1>

backing-store /storage/lun0.img

initiator-address 192.168.0.100

incominguser init1ISCSI passsecr

outgoinguser target1iSCSI secrpass

</target>
```

Разберём построчно:

1. `<target iqn.2024-00.some.domain:lun1>`: Эта строка обозначает начало определения новой цели (target) для iSCSI. `iqn.2024-00.some.domain:lun1` - это уникальный идентификатор (IQN) для этой цели. IQN состоит из четырех основных частей: `iqn` - префикс, указывающий на то, что это идентификатор iSCSI Qualified Name, `2024-00` - год и номер версии, `some.domain` - домен, который может быть уникальным именем домена, и `lun1` - идентификатор логического блока (LUN) для этой цели.

2. `backing-store /storage/lun0.img`: Это указывает на путь к файлу, который будет использоваться в качестве хранилища (backing store) для данной цели iSCSI. В данном случае, файл `/storage/lunO.img` будет использоваться в качестве хранилища для логического блока, связанного с данной целью.

3. `initiator-address 192.168.0.100`: Эта строка определяет IP-адрес инициатора (initiator), который имеет разрешение подключаться к этой цели iSCSI. В данном случае, инициатор с IP-адресом `192.168.0.100` будет разрешен подключаться к этой цели.

4. `incominguser init1ISCSI passsecr`: Это указывает имя пользователя и пароль, которые будут использоваться для аутентификации инициатора при подключении к этой цели iSCSI. В данном случае, имя пользователя `init1ISCSI` и пароль `passsecr` будут использоваться для входящей аутентификации.

5. `outgoinguser target1iSCSI secrpass`: Это указывает имя пользователя и пароль, которые будут использоваться для аутентификации цели (target) при подключении инициатора к ней. В данном случае, имя пользователя `target1iSCSI` и пароль `secrpass` будут 
использоваться для исходящей аутентификации.

6. Последний оператор, заключающий строку, предназначен для определения цели, примете наличие закрывающего слеша перед ключевым словом target. 

Далее, сохраняем конфиг, перезапускаем службу:

```
sudo service tgt restart
```

И добавим в автозагрузку:

```
sudo systemctl enable target
```

Перейдём к настройке iSCSI-инициатора:

1.  начнем с установки iSCSI Initiator Utilities на Linux. В большинстве дистрибутивов Linux они уже доступны в стандартных репозиториях. Для этого мы будем использовать команды, соответствующие различным популярным дистрибутивам:

```
sudo apt update
sudo apt install open-iscsi
```
После выполнения этих команд, утилиты iSCSI Initiator будут установлены на вашей системе.

2. Настроим файл конфигурации iSCSI Initiator на Linux. В зависимости от дистрибутива, файл конфигурации может быть назван по-разному и располагаться в разных местах. Но обычно он находится в одном из следующих мест:

1. /etc/iscsi/initiatorname.iscsi
2. /etc/iscsi/initiatorname.conf

Вам нужно отредактировать этот файл с правами суперпользователя (обычно используется sudo), чтобы добавить ваш уникальный идентификатор iSCSI Initiator (IQN):

```
sudo nano /etc/iscsi/initiatorname.iscsi

```

3.  В файле конфигурации добавьте следующую информацию:

   ```
   InitiatorName=iqn.2024-00.some.domain:initiator1
   ```

   Это уникальный идентификатор (IQN) вашего iSCSI инициатора. 

Сохраните конфигурационный файл.

4. Подключитесь к цели (target):
   Используйте утилиту iSCSI Initiator для подключения к цели:

```
sudo iscsiadm --mode node --targetname iqn.2024-00.some.domain:lun1 --portal <IP_адрес_цели> --login
```

- sudo: Это команда, которая позволяет выполнить следующую команду с правами суперпользователя, что может потребоваться для выполнения операций, связанных с iSCSI.

- iscsiadm: Это утилита командной строки для управления iSCSI-соединениями в Linux.

- --mode node: Этот флаг указывает, что мы работаем с узлом (node) iSCSI, то есть с конкретным устройством или целью.

- --targetname iqn.2024-00.some.domain:lun1: С помощью этого флага мы указываем идентификатор цели (IQN), к которой хотим подключиться. В данном примере это iqn.2024-00.some.domain:lun1.

- --portal <IP_адрес_цели>: Этот флаг указывает IP-адрес iSCSI цели, к которой мы хотим подключиться. Вы должны заменить <IP_адрес_цели> на фактический IP-адрес вашей iSCSI цели.

- --login: Этот флаг указывает, что мы хотим выполнить процедуру входа (login) в iSCSI цель. После успешного выполнения этой команды, инициатор будет подключен к цели и сможет начать обмен данными.

5. Проверьте подключение:
   После настройки и подключения к цели, убедитесь, что соединение установлено и вы можете обращаться к логическому блоку, предоставляемому целью. Например:

```
iscsiadm -m session -P3

```

   - iscsiadm: Это сама команда для управления iSCSI устройствами в Linux.

- -m session: Этот флаг указывает режим работы команды, который в данном случае - session, что означает работу с текущими сеансами iSCSI.

- -P3: Этот флаг указывает на уровень подробности вывода (verbosity level). Значение 3 обозначает наибольший уровень подробности. Это означает, что команда будет выводить максимальное количество информации о текущих iSCSI сессиях.

### Практическое задание.

Настройте iSCSI-target и iSCSI-initiator на виртуальных машинах инфраструктуры.

___

В примере мы затронуливопрос безопасности, расскажем об этом подробнее.

### 1. Аутентификация:

**CHAP (Challenge Handshake Authentication Protocol)**:
CHAP - это протокол аутентификации, используемый в iSCSI для проверки подлинности инициатора и цели. Он основан на принципе вызов-ответ, где сервер (цель) отправляет вызов аутентификации инициатору, который должен ответить с использованием предварительно согласованных учетных данных. Это помогает предотвратить атаки типа "подслушивание" и защищает учетные данные от несанкционированного доступа.

**Mutual CHAP**:
Mutual CHAP - это расширение CHAP, которое обеспечивает двустороннюю аутентификацию, где как инициатор, так и цель аутентифицируют друг друга. Это повышает уровень безопасности, предотвращая атаки с подменой и подслушиванием.

### 2. Шифрование:

**IPsec (Internet Protocol Security)**:
IPsec может быть использован для шифрования iSCSI трафика, обеспечивая конфиденциальность и целостность данных между инициатором и целью. Он работает на уровне IP и обеспечивает защиту данных, пропуская трафик через зашифрованный туннель между устройствами. IPsec предоставляет механизмы для шифрования (как симметричного, так и асимметричного) и аутентификации (через различные методы, такие как HMAC).

**IKE (Internet Key Exchange)**:
IKE - это протокол установки ключей, используемый в IPsec для управления процессом аутентификации и обмена ключами. Он помогает инициатору и цели согласовать общие параметры безопасности и установить безопасный канал для передачи данных.

### Примеры настройки безопасности в iSCSI:

1. Настройка аутентификации с использованием CHAP:
iscsiadm --mode node --targetname <IQN_цели> --portal <IP_цели> --op=update --name node.session.auth.authmethod --value=CHAP
iscsiadm --mode node --targetname <IQN_цели> --portal <IP_цели> --op=update --name node.session.auth.username --value=<имя_пользователя>
iscsiadm --mode node --targetname <IQN_цели> --portal <IP_цели> --op=update --name node.session.auth.password --value=<пароль>


2. Настройка шифрования с использованием IPsec:
ipsec auto --add <connection_name>
ipsec whack --initiate --name <connection_name>


Здесь <IQN_цели> - это идентификатор цели iSCSI, а <IP_цели> - это IP-адрес цели. Подставьте свои значения для <имя_пользователя>, <пароля> и <connection_name>.


