## Урок 2. Работа с дисками в Linux (Менеджеры дисков в Linux.)

В этом уроке мы расскажем вам как взаимодействовать с дисками в ОС Linux на примере Logical Volume Manager(менеджер логических томов, далее LVM).

В конце 1980-х и начале 1990-х годов компания Hewlett-Packard (HP) активно работала над разработкой новых технологий в области управления хранилищем данных для своей операционной системы HP-UX (Hewlett-Packard UniX). Одной из ключевых инноваций в этой области стало появление LVM (Logical Volume Manager) для HP-UX.

С ростом использования компьютеров и серверов возникла потребность в эффективном управлении хранилищем данных. Традиционные методы управления дисками и разделами стали ограничивать возможности администраторов по масштабированию и управлению данными.

В результате исследований и разработки HP начала работу над LVM, который представлял собой новый метод управления логическими томами данных. Он предоставлял абстракцию над физическими дисками и позволял объединять несколько дисков в группы, а затем создавать логические тома с динамическим изменением размеров и другими расширенными функциями.

В 1998 году компания Hewlett-Packard (HP) представила новую версию своей операционной системы HP-UX - HP-UX 11.0. 

HP-UX 11.0 был первой версией HP-UX, которая включала в себя LVM как стандартную функцию для управления томами данных и группами томов. 

 LVM в HP-UX 11.0 заложил основы для дальнейшего развития и использования LVM в других операционных системах, включая Linux.

В 2000 году LVM начинает интегрироваться в операционную систему Linux. Red Hat Linux 7.0 становится одним из первых дистрибутивов, в котором LVM был представлен как экспериментальная функция.

2001 год: После успешной адаптации LVM в Linux, он становится стандартной частью многих дистрибутивов, включая Debian, Ubuntu и другие.

2002 год: В ядро Linux включают улучшенную поддержку LVM (LVM2). Она включает новые возможности и повышает стабильность LVM.
  
В настоящее время LVM продолжает развиваться и улучшаться. Он активно используется в корпоративных окружениях для управления большими массивами данных и обеспечения высокой доступности. LVM стал ключевой частью архитектуры хранения данных в Linux.

Так что же это такое - LVM?

LVM  - это технология управления хранилищем данных в операционных системах, таких как Linux. Она предоставляет абстракцию над физическими устройствами хранения, позволяя создавать логические тома данных, которые могут охватывать несколько физических дисков или разделов.

Перечислим основные достоинства этого инструмента:

1. Гибкость в управлении дисками: LVM позволяет создавать логические тома, которые могут охватывать несколько физических устройств хранения. Можно динамически изменять размеры логических томов без необходимости перезагрузки системы.

2. Управление пространством хранения: LVM дает возможность объединять несколько физических дисков в группы томов, позволяя легко управлять пространством хранения и увеличивать его емкость.

3. Snapshot и резервное копирование: С помощью LVM можно создавать снимки (snapshots) логических томов для создания резервных копий данных в определенный момент времени.

4. Удобное перемещение данных: LVM позволяет перемещать данные между физическими дисками и разделами без необходимости перекопирования данных.

5. Удобное объединение и разделение томов: Логические тома могут быть объединены в один большой том (виртуальный), что облегчает организацию данных. Также возможен и обратный процесс.

6. Высокая доступность данных: LVM обеспечивает надежное управление данными, позволяя восстановить информацию в случае отказа физического диска.

7. Горячее добавление и удаление дисков: LVM позволяет добавлять и удалять диски в группах томов без простоя или перезагрузки системы.


### Квиз.

1. Что представляет собой LVM в операционных системах?

   A) Логическая виртуальная машина

   B) Локальная виртуальная сеть

   C) Логический менеджер томов

   D) Локальный векторный модуль

   Правильный ответ: C) Логический менеджер томов Объяснение: LVM (Logical Volume Manager) - это технология управления хранилищем данных, предоставляющая гибкость и расширенные возможности по работе с томами данных.

2. В какой операционной системе был впервые включен LVM?

   A) Windows 10

   B) MacOS

   C) HP-UX

   D) Ubuntu

   Правильный ответ: C) HP-UX Объяснение: LVM был впервые включен в операционную систему HP-UX компании Hewlett-Packard.

3. Для чего предназначен LVM в Linux?

   A) Управление графическим интерфейсом

   B) Управление процессами системы

   C) Управление хранилищем данных и томами

   D) Управление сетевыми настройками

   Правильный ответ: C) Управление хранилищем данных и томами. Объяснение: LVM в Linux обеспечивает удобное и гибкое управление хранилищем данных, логическими томами и группами томов.

4. Какой принципиальный принцип лежит в основе работы LVM?

   A) Объединение логических и физических дисков

   B) Работа с облаком

   C) Использование бесплатного программного обеспечения

   D) Увеличение размера файла подкачки

   Правильный ответ: A) Объединение логических и физических дисков. Объяснение: Основной принцип работы LVM заключается в абстрагировании логических томов данных от физических устройств хранения.


LVM управляет тремя сущностями:

Физический том — Physical Volume (PV): раздел на физическом диске или весь диск целиком.

Группа физических томов — Volume Group (VG): объединение нескольких физических томов под одним логическим именем.

Логический том — Logical Volume (LV): логический раздел, который можно отформатировать и примонтировать как обычный раздел физического диска.

Сначала под управление LVM нужно отдать физический диск или его раздел. Для этого инициализируйте его как PV (Physical Volume). Затем из PV создаётся VG (Volume Group). В VG создаются LV (Logical Volume), которые уже можно отформатировать с использованием определенной файловой системы и использовать для хранения данных:

<img width="1400" alt="7 2 1 1" src="https://github.com/lexche/Testyp/assets/95694325/2ee9f9bb-4752-4cf3-802b-bd4b260e505d">

Создадим PV для обоих разделов на новом диске с помощью утилиты pvcreate:

```
$ sudo pvcreate /dev/vdb1 /dev/vdb2
  Physical volume "/dev/vdb1" successfully created.
  Physical volume "/dev/vdb2" successfully created.

$ sudo pvs
  PV         VG Fmt  Attr PSize PFree
  /dev/vdb1     lvm2 ---  1.00g 1.00g
  /dev/vdb2     lvm2 ---  1.00g 1.00g
```

Утилита pvs дала нам краткую информацию о доступных физических дисках lvm. Утилита pvdisplay выведет подробную информацию об этих дисках:

```
$ sudo pvdisplay
  "/dev/vdb1" is a new physical volume of "1.00 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/vdb1
  VG Name               
  PV Size               1.00 GiB
  Allocatable           NO
  PE Size               0   
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               w68zDA-hwuX-1bqD-sMir-cAvx-Q1ji-hMwfVz

  "/dev/vdb2" is a new physical volume of "1.00 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/vdb2
  VG Name               
  PV Size               1.00 GiB
  Allocatable           NO
  PE Size               0   
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               Es91ky-P1bv-PbfW-2CnW-AAga-eu0i-Hz2mGe
```

Создадим группу томов lvm (VG) с помощью утилиты vgcreate:

```
$ sudo vgcreate store /dev/vdb1 /dev/vdb2
  Volume group "store" successfully created

$ sudo vgs
  VG            #PV #LV #SN Attr   VSize VFree
  store           2   0   0 wz--n- 1.99g 1.99g

$ sudo vgdisplay
  --- Volume group ---
  VG Name               store
  System ID
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               1.99 GiB
  PE Size               4.00 MiB
  Total PE              510
  Alloc PE / Size       0 / 0
  Free  PE / Size       510 / 1.99 GiB
  VG UUID               f0kxgg-09Qe-zR76-FADC-EbQs-aC82-JBUaV1
```

Аналогично vgs вывела нам краткую информацию о доступных группах томов. Обратите внимание, что размер группы — 2 ГБ. Утилита vgdisplay вывела подробную информацию о группах:

VG Name — имя группы.
VG Size — размер группы.
PE Size — это размер чанка. Чанк — это минимальная единица выделения места на диске для LVM. Это блок, если проводить аналогию с файловой системой, или кластер, если проводить аналогию с файловыми системами Windows.
Total PE — количество чанков в группе.
Alloc PE / Size — занятое место.
Free PE / Size — свободное место.

Создадим логический том используя группу store:

```
$ sudo lvcreate -l +100%FREE -n logs store
  Logical volume "logs" created.

$ sudo lvs
  LV   VG            Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  logs store -wi-a----- 1.99g

$ sudo lvdisplay
  --- Logical volume ---
  LV Path                /dev/store/logs
  LV Name                logs
  VG Name                store
  LV UUID                GMmeOh-Nu7r-2Hc6-q2NQ-GOm9-DerY-tvMNjU
  LV Write Access        read/write
  LV Creation host, time fhmj7hdgflkkhg3iu22v, 2023-05-28 10:34:11 +0000
  LV Status              available
  # open                 0
  LV Size                1.99 GiB
  Current LE             510
  Segments               2
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:0
```

LVM довольно гибкий инструмент для сопровождения дисковой подсистемы в инфраструктуре. Помимо увеличения и уменьшения размера логических томов, он позволяет делать снимки, перемещать разделы между физическими дисками, создавать зеркала и так далее.

Расскажем более подробно. Снэпшоты (snapshot) в LVM представляют собой временные копии томов данных, которые могут быть использованы для восстановления данных после их модификации. Снепшоты позволяют создавать точки восстановления перед важными операциями или просто делать резервные копии данных.

Пример создания снэпшота в LVM из консоли:

 Создание снепшота для тома данных:

 ```
lvcreate -L 1G -s -n snapshot /dev/vg1/lv1
```

После этого можно работать с снэпшотом, например, для восстановления данных, например:

Смонтировать снепшот в отдельную точку монтирования:

```
mkdir /mnt/snapshot
mount /dev/vg1/snapshot /mnt/snapshot
```

 Восстановить данные из снепшота:

```
cp -a /mnt/snapshot/* /path/to/restore
```

После восстановления данных, отмонтировать и удалить снепшот:

```
umount /mnt/snapshot
lvremove /dev/vg1/snapshot
```

RAID в LVM позволяют объединять несколько дисков в массив для повышения отказоустойчивости и производительности. В LVM можно использовать рейды различных уровней (например, RAID 0, RAID 1, RAID 5) для различных целей.

Пример создания рейда в LVM из консоли:

1. Создание физических томов:

```
pvcreate /dev/sdb /dev/sdc
```

2. Создание группы томов:
```
vgcreate vg2 /dev/sdb /dev/sdc
```

3. Создание логического тома с рейдом (например, RAID 1):

```
lvcreate -L 1G -m1 -n lv2 vg2
```

Для работы с кластерным LVM (CLVM) необходимо настроить кластеризацию на вашей системе и на всех узлах кластера. После этого можно работать с общими томами данных, которые будут синхронизироваться между узлами кластера.

Пример работы с кластерным LVM из консоли:

1. Установка и настройка кластеризации на всех узлах кластера.

2. Подготовка физических томов и создание группы томов на каждом узле:
```
pvcreate /dev/sdb
vgcreate vg_cluster /dev/sdb
```

3. Создание логического тома на группе томов с параметром --clustered:

```
lvcreate --type clustered -n lv_cluster -l 100%FREE vg_cluster
```

4. Работа с общим логическим томом на разных узлах кластера:

```
# Информация о доступных группах томов на всех узлах
lvmconf --cluster
# Активация группы томов на текущем узле
vgchange -ay
# Монтирование общего логического тома
mount /dev/vg_cluster/lv_cluster /mnt/cluster_data
```

5. После необходимых операций с данными и завершения работы, необходимо деактивировать группу томов и размонтировать логический том:
```
umount /mnt/cluster_data
vgchange -an
```

#### Практическое задание.

Ниже представлены команды для сборки и форматирования томов. Отработайте их на виртуальных машинах.

1. Создание физического тома:
```
pvcreate /dev/sdb
```

2. Создание группы томов:
```
vgcreate vg_data /dev/sdb
```

3. Создание логического тома:
```
lvcreate -n lv_data -l 100%FREE vg_data
```

4. Форматирование логического тома (например, в ext4):
```
mkfs.ext4 /dev/vg_data/lv_data
```

5. Создание точки монтирования и монтирование логического тома:
```
mkdir /mnt/data
mount /dev/vg_data/lv_data /mnt/data
```

Теперь у вас есть отформатированный логический том, готовый к использованию. После завершения работы с логическим томом, не забудьте размонтировать его:

```
umount /mnt/data
```

Несколько команд по удалению логических томов:

1. Размонтируйте логический том:
```
umount /mnt/data
```

2. Удалите логический том:
```
lvremove /dev/vg_data/lv_data
```

3. Удалите группу томов:

```
vgremove vg_data
```

4. Удалите физический том:

```
pvremove /dev/sdb
```

Помните, что операции с LVM могут привести к потере данных, поэтому убедитесь, что у вас есть резервные копии перед выполнением этих команд.

В этом уроке мы рассказали LVM: что это за технология, откуда она появилась, для чего используется, какие у неё преимущества. Узнали что LVM управляет 3 сущностями: физический том, группа физических томов, логический том. Узнали как с помощью LVM работать со снепшотами, рейдами и кластерами. Рассмотрели основные команды.

В следующем уроке расскажем про задачи управления дисками в Linux.
