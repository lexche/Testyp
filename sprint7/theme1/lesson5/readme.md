## Урок 5. Протокол NFS

NFS (Network File System) - это протокол сетевой файловой системы, который позволяет удаленным компьютерам монтировать удаленные файловые системы через сеть и работать с ними так, как если бы они были локальными. Это означает, что клиентский компьютер может получить доступ к файлам и каталогам на удаленном сервере таким же образом, как если бы они находились на его собственном диске.

NFS позволяет обмениваться файлами и ресурсами между компьютерами в сети, что делает его полезным инструментом для совместной работы и обмена данными. Этот протокол широко используется в различных сценариях, включая серверы файлов, резервное копирование данных, виртуализацию и облачные вычисления.

Протокол Network File System (NFS) был разработан компанией Sun Microsystems в конце 1980-х годов и стал одним из первых протоколов сетевой файловой системы для UNIX-подобных операционных систем. Вот краткая историческая справка по версиям протокола NFS:

 Первая версия NFS (NFSv1) была разработана Sun Microsystems и была включена в SunOS 2.0 в 1984. Она предоставляла простую сетевую файловую систему для обмена файлами между компьютерами. Поддерживала базовые операции чтения, записи и исполнения файлов, но не предоставляла надежного кэширования и асинхронной записи. Ограничения по объему данных и числу одновременных запросов.

 Вторая версия NFS (NFSv2) была разработана во второй половине 80х для улучшения производительности и функциональности по сравнению с NFSv1. Она была включена в SunOS 2.0.3.  Улучшенная поддержка символических ссылок и возможность монтирования подкаталогов. Однако, она все еще оставалась простой и ненадежной по современным стандартам. Ограничения по объему данных и числу одновременных запросов.

В 1995 была представлена NFSv3. Третья версия NFS представила значительные улучшения в производительности, функциональности и безопасности. Она стала широко используемым стандартом для сетевого обмена файлами в UNIX-системах. Поддержка более широкого набора операций, улучшенное кэширование и асинхронная запись, повышенные ограничения по объему данных и числу одновременных запросов. Добавлены механизмы аутентификации и авторизации.

 Первая версия NFSv4 (2003 год) была значительным обновлением протокола NFS. Она была разработана с учетом новых требований безопасности, функциональности и эффективности.

- Особенности:
  - Усиление механизмов безопасности с внедрением системы аутентификации и авторизации Kerberos.
  - Поддержка блокировок для обеспечения целостности файлов в разделяемых средах.
  - Возможность разделения файловой системы (File System Namespace) для более гибкой монтировки и управления ресурсами.

2010 год - версия NFSv4.1 внесла некоторые важные изменения и дополнения в протокол, направленные на улучшение и расширение функциональности сетевой файловой системы.

- Особенности:
  - Введение механизма разделенных операций (COMPOUND) для уменьшения накладных расходов и увеличения производительности.
  - Поддержка миграции файловых систем и репликации данных между серверами.
  - Добавление поддержки выборочной кэширования (pNFS) для распределенной работы с данными.
- Производительность:
  - Дальнейшее улучшение производительности и расширенные возможности работы с данными.

В 2016 году вышла NFSv4.2 - Последняя на данный момент версия NFSv4. 

- Особенности:
  - Дополнения в области безопасности и шифрования данных.
  - Улучшения в работе с блокировками и кешированием данных.
  - Расширение функциональности в области аутентификации и авторизации.

Допустим, мы вас заинтересовали и вы захотели начать пользоваться данным протоколом в своей системе. Разберём как этот протокол работает в ОС Linux.

Network File System (NFS) работает по клиент-серверной модели, где сервер предоставляет файловые ресурсы, а клиенты обращаются к ним для доступа к файлам. 

Рассмотрим общий обзор того, как работает сервер NFS:

1. Инициализация и настройка:
   - Сервер NFS должен быть настроен и запущен на хосте, который предоставляет файловые ресурсы для сети.
   - Необходимые файловые системы должны быть определены и настроены для монтирования и предоставления клиентам через NFS.

2. Процесс экспорта ресурсов:
   - Администратор сервера определяет, какие ресурсы файловой системы будут доступны для монтирования клиентами. Это обычно делается в конфигурационном файле /etc/exports на сервере.
   - В этом файле указываются пути к файловым системам, разрешенные клиентам для монтирования, и параметры доступа, такие как IP-адреса клиентов и разрешения на чтение/запись.

3. Ожидание запросов от клиентов:
   - После настройки сервер ожидает запросов от клиентов NFS.
   - Запросы могут включать в себя запросы на чтение, запись, удаление файлов или каталогов, а также управление блокировками и другими метаданными файловой системы.

4. Обработка запросов:
   - Когда сервер получает запрос от клиента, он проверяет его на допустимость и выполняет запрошенную операцию на файловой системе, если это возможно.
   - Обработка запросов может включать чтение или запись данных, управление блокировками, изменение метаданных и другие операции, связанные с управлением файловой системой.

5. Отправка ответов клиенту:
   - После выполнения операции сервер отправляет ответ клиенту, содержащий результат операции или соответствующий статус.
   - Это может быть данные, запрошенные клиентом (например, содержимое файла), или информация об успешном или неуспешном выполнении операции.

6. Управление ресурсами и состоянием:
   - Во время работы сервер может отслеживать состояние файловой системы, управлять кешированием данных, обновлять метаданные и выполнять другие операции, связанные с управлением ресурсами.

7. Завершение сеанса:
   - По завершении операции сервер завершает соединение с клиентом и освобождает ресурсы, связанные с запросом.

Давайте разберём из каких процессов (демонов) состоит сервер NFS:

- rpc.statd: Демон наблюдения за сетевым состоянием (NSM) отслеживает состояние сети и помогает в восстановлении после сбоев. В современных версиях его роль стала менее значимой, но он все еще используется для определенных функций.

- rpc.lockd: Демон блокировки (NFS Lock Manager) управляет запросами на блокировку файлов, чтобы предотвратить конфликты доступа к файлам между клиентами NFS.

- rpc.nfsd: Основной демон сервера NFS обрабатывает запросы клиентов NFS и предоставляет им доступ к файловым ресурсам. В современных версиях его иногда называют nfsd4.

- rpc.mountd: Демон монтирования NFS обрабатывает запросы клиентов на монтирование каталогов с сервера NFS.

- rpc.idmapd: Демон idmapd преобразует локальные идентификаторы пользователей и групп в формат, используемый в NFSv4, и наоборот. Это важно при работе с распределенными системами, где идентификаторы пользователей могут отличаться.

В старых версиях NFS также использовались дополнительные демоны, такие как nfslogd для журналирования активности файловых систем и rquotad для предоставления информации о квотах пользователей.

В NFSv4 с использованием Kerberos дополнительно запускаются следующие демоны:

- rpc.gssd: Демон обеспечивает аутентификацию через GSS-API, что позволяет использовать Kerberos для обеспечения безопасности.

- rpc.svcgssd: Демон сервера NFSv4, который проверяет подлинность клиента на стороне сервера, также используя Kerberos для аутентификации.

Сам процесс монтирования удаленного каталога через протокол NFS происходит следующее:

1. На сервере и клиенте запускается RPC-сервер, который управляется процессом portmapper и регистрируется на портах tcp/111 и udp/111.
2. Запускаются службы, такие как rpc.nfsd и rpc.statd, которые регистрируются на RPC-сервере и используют произвольные сетевые порты (если не заданы статичные порты в настройках).
3. Когда команда mount на клиентском компьютере отправляет запрос ядру для монтирования сетевого каталога, указывая тип файловой системы, хост и каталог, ядро формирует RPC-запрос к процессу portmap на сервере NFS на порт udp/111 (если не указано использовать tcp).
4. Ядро сервера NFS опрашивает RPC о наличии демона rpc.mountd и возвращает ядру клиента сетевой порт, на котором работает демон.
5. Клиентское приложение mount отправляет RPC-запрос на порт, где работает rpc.mountd. Теперь сервер NFS может проверить подлинность клиента по его IP-адресу и номеру порта, чтобы убедиться, что клиент может смонтировать указанную файловую систему.
6. Демон монтирования возвращает описание запрошенной файловой системы.
7. Команда mount на клиенте выполняет системный вызов mount, чтобы связать описание файла, полученное на предыдущем шаге, с локальной точкой монтирования на клиентском хосте. Описание файла сохраняется в коде NFS-клиента, и с этого момента любые пользовательские процессы, обращающиеся к файлам на сервере, будут использовать описание файла как отправную точку.

### Квиз

1. Какой процесс отслеживает состояние сети и помогает в восстановлении после сбоев в NFS?
   A) rpc.statd

   B) rpc.lockd

   C) rpc.nfsd

   D) rpc.mountd

   Правильный ответ: A) rpc.statd

   Объяснение: Демон rpc.statd отслеживает состояние сети и помогает в восстановлении после сбоев, играя роль наблюдения за сетевым состоянием (NSM) в NFS.

2. Какая компания первоначально разработала и представила протокол Network File System?

   A) Microsoft

   B) IBM

   C) Sun Microsystems

   D) Apple

   Правильный ответ: C) Sun Microsystems

   Объяснение: Протокол Network File System был первоначально разработан и представлен компанией Sun Microsystems.

3. Какой из перечисленных демонов отвечает за монтирование удаленных файловых систем на клиенте NFS?

   A) rpc.nfsd

   B) rpc.statd

   C) rpc.mountd

   D) rpc.lockd

   Правильный ответ: C) rpc.mountd

   Объяснение: Демон rpc.mountd отвечает за монтирование удаленных файловых систем на клиенте NFS.

4.  Какая операционная система предоставляет поддержку для NFS прямо из коробки, без необходимости установки дополнительных программ?

    A) Windows

    B) macOS

    C) Linux

    D) Android

    Правильный ответ: C) Linux

    Объяснение: Операционная система Linux предоставляет поддержку для NFS прямо из коробки.

___

Перейдём от теории к практике. Рассмотрим как настроить NFS-сервер, а затем подключить папку к клиенту.

#### Установка необходимых пакетов

Первым делом убедитесь, что пакеты nfs-kernel-server и nfs-common установлены на вашем сервере. Выполните команду:

```
sudo apt update
```
Эта команда используется для обновления списка пакетов в вашем пакетном менеджере APT (Advanced Package Tool). Когда вы выполняете apt update, APT обновляет свою базу данных о доступных пакетах из источников (репозиториев). При выполнении этой команды вы убеждаетесь, что информация о доступных пакетах актуальна, прежде чем устанавливать что-либо новое.

```
sudo apt install nfs-kernel-server nfs-common
```

Эта команда устанавливает пакеты nfs-kernel-server и nfs-common, которые необходимы для работы с NFS (Network File System) в Linux.

- nfs-kernel-server: Этот пакет содержит серверную часть NFS, которая отвечает за предоставление доступа к файлам и директориям через протокол NFS.
  
- nfs-common: Этот пакет содержит общие компоненты NFS, которые необходимы как для серверов, так и для клиентов NFS. Он включает в себя утилиты для работы с NFS, такие как mount.nfs и showmount.


#### Настройка экспортируемых директорий

Редактируйте файл /etc/exports, чтобы указать, какие директории будут доступны для монтирования по NFS. Например:

```
sudo nano /etc/exports
```

Добавьте строки вида:

/home/user/documents 192.168.1.0/24(rw,sync,no_subtree_check)

Это означает, что директория /home/user/documents будет доступна для записи (rw) для всех компьютеров в сети с IP адресами от 192.168.1.0 до 192.168.1.255. Опции sync и no_subtree_check обеспечивают синхронную запись и проверку пути.

Помимо вышеперечисленных в файле exports NFS использует ряд опций для настройки доступа и поведения сервера:

- auth_nlm (no_auth_nlm) или secure_locks (insecure_locks): Определяют, требуется ли аутентификация запросов на блокировку. С помощью auth_nlm или secure_locks сервер требует аутентификацию, тогда как no_auth_nlm или insecure_locks позволяют запросы блокировки без аутентификации.

- nohide (hide): Если сервер экспортирует вложенные иерархии каталогов, nohide позволяет клиентам монтировать дочерние иерархии без явного указания. Опция hide скрывает дочерние иерархии до тех пор, пока они явно не будут смонтированы.

- ro (rw): Определяет, разрешены ли только запросы на чтение или и чтение, и запись в экспортированной директории.

- secure (insecure): Определяет, должны ли запросы NFS поступать с защищенных портов. secure требует это, в то время как insecure позволяет запросам поступать с любых портов.

- subtree_check (no_subtree_check): Определяет, проверяет ли сервер, находится ли запрошенный файл в экспортированном подкаталоге. Отключение этой проверки с помощью no_subtree_check может повысить производительность, но снизить безопасность.

- sync (async): Указывает, должен ли сервер записывать данные на диск сразу после запроса (sync) или ждать до завершения всех записей (async). async увеличивает производительность, но снижает надежность.

- wdelay (no_wdelay): Определяет, должен ли сервер задерживать выполнение команд на запись, чтобы объединить их в большие блоки (wdelay), или нет (no_wdelay). Это может повысить производительность при больших объемах записей.


#### Применение изменений

После внесения изменений в файл /etc/exports, необходимо применить их командой:

```
sudo exportfs -a
```

Это перечитает файл /etc/exports и применит изменения к конфигурации NFS.

#### Запуск службы NFS

Запустите службу NFS, чтобы разрешить доступ к экспортированным директориям:

```
sudo systemctl start nfs-kernel-server
```

Чтобы автоматически запускать NFS при загрузке системы, выполните:

```
sudo systemctl enable nfs-kernel-server
```

#### Проверка доступа к NFS

Чтобы убедиться, что NFS настроен правильно и директории доступны для монтирования, можно выполнить команду showmount:

```
showmount -e localhost
```

Это покажет список экспортированных директорий на вашем сервере NFS.

---

Теперь подключим эту папку "клиенту".

#### Установка nfs-utils.

   nfs-utils - это пакет программного обеспечения, необходимый для работы с NFS. Установим его на клиентской машине. В большинстве дистрибутивов Linux это можно сделать с помощью менеджера пакетов:

   ```
   sudo apt-get update
   sudo apt-get install nfs-common
   ```

#### Создание точки монтирования.

   Создадим каталог, который будет служить точкой монтирования для NFS-шары. Для примера, давайте создадим каталог /mnt/documents:

   ```bash
   sudo mkdir -p /mnt/documents
   ```

#### Монтирование NFS папки.

   Используем команду mount для монтирования удаленной NFS-шары на созданную точку монтирования. Подставьте IP адрес или имя вашего NFS сервера вместо SERVER_IP:

   ```bash
   sudo mount -t nfs SERVER_IP:/home/user/documents /mnt/documents
   ```

   - -t nfs указывает тип файловой системы (NFS).
   - SERVER_IP:/home/user/documents - адрес и путь к экспортированной папке на сервере.
   - /mnt/documents - точка монтирования на клиентской машине.

#### Проверка подключения.

   Убедимся, что папка успешно подключена, проверив содержимое точки монтирования:

   ```bash
   ls /mnt/documents
   ```

#### Автоматическое монтирование при загрузке (опционально).

   Если нужно, чтобы NFS-шара монтировалась автоматически при каждой загрузке, добавьте соответствующую запись в файл /etc/fstab:

   ```bash
   echo "SERVER_IP:/home/user/documents /mnt/documents nfs defaults 0 0" | sudo tee -a /etc/fstab
   ```

   Это гарантирует, что NFS-шара будет монтироваться при каждой загрузке системы.

После выполнения этих шагов папка /home/user/documents с сервера NFS будет доступна на клиентской машине по указанному пути монтирования (/mnt/documents).


### Практическое задание.

Настройте экспортируемую дирректорию на одной виртуальной машине и подключите эту дирректорию на другой виртуальной машине с помощью протокола NFS.

___

В конце урока остановимся на таком аспекте как безопасность в NFS, перечислим основные:

1. Аутентификация и авторизация:
   - Контроль доступа: NFS поддерживает метод аутентификации по умолчанию, который использует идентификацию по IP-адресам. Это может быть небезопасно, так как IP-адреса могут быть подделаны. Лучше использовать методы аутентификации, такие как Kerberos, который обеспечивает более надежный механизм проверки подлинности.
   - Экспорт и монтирование: Контролируйте доступ к NFS-шарам с помощью настроек в файле /etc/exports на сервере. Указывайте только доверенные клиентские системы или сети, которым разрешен доступ к данным.
   - Авторизация: Используйте права доступа на уровне файловой системы, чтобы контролировать, какие пользователи могут читать и записывать файлы в NFS-шаре. Это можно сделать с помощью стандартных средств управления доступом в Linux, таких как права владения и разрешения.

2. Шифрование данных:
   - Важно шифровать данные, передаваемые по сети, чтобы предотвратить их перехват и просмотр третьими лицами. NFSv4 поддерживает шифрование данных с использованием методов шифрования, таких как AES.

3. Firewall:
   - Используйте брандмауэр для ограничения доступа к портам NFS на сервере и клиенте. Это поможет предотвратить несанкционированный доступ к сервису NFS.

4. Мониторинг и журналирование:
   - Ведите журналы аудита для отслеживания попыток доступа к NFS-ресурсам. Мониторинг журналов поможет выявить подозрительную активность и реагировать на нее.

5. Обновления и патчи:
   - Регулярно обновляйте операционную систему и компоненты NFS до последних версий, чтобы исправлять уязвимости безопасности и обеспечивать защиту от известных атак.
  
6. NFSv4 Access Control Lists (ACLs) - это механизм управления доступом, который позволяет более гибко контролировать права доступа к файлам и каталогам на NFSv4-шарах. С ACL вы можете назначить специфичные права доступа для конкретных пользователей или групп пользователей, а также дополнительные права, которых нет в стандартной системе прав доступа в Unix (как права владельца, группы и другие).

Вот основные компоненты NFSv4 ACL и примеры их использования:

1. Режимы доступа:
   - r (read): Позволяет чтение файлов и каталогов.
   - w (write): Позволяет запись в файлы и создание или удаление файлов в каталогах.
   - x (execute): Позволяет выполнение файла (в случае каталога - вход в каталог).
   - a (append): Позволяет добавление данных в конец файла (для файлов).
   - d (delete): Позволяет удаление файлов в каталоге.

2. Типы пользователей:
   - u (user): Определяет права доступа для конкретного пользователя.
   - g (group): Определяет права доступа для конкретной группы пользователей.
   - o (other): Определяет права доступа для всех остальных пользователей.

3. Маски:
   - m (mask): Устанавливает маску, которая ограничивает максимальные права доступа, которые могут быть установлены с помощью ACL. Маска действует как фильтр для прав доступа, установленных для пользователей и групп.

Примеры применения NFSv4 ACL:

a. Назначение прав доступа для конкретного пользователя:
   ```
   setfacl -m u:user1:rwx /mnt/documents/file.txt
   ```
   Это даст пользователю user1 полные права (чтение, запись, выполнение) к файлу file.txt.

b. Назначение прав доступа для конкретной группы:
   ```
   setfacl -m g:group1:rx /mnt/documents/directory
   ```
   Это даст группе group1 права на чтение и выполнение к каталогу directory.

c. Установка маски:
   ```
   setfacl -m m:rwx /mnt/documents/directory
   ```
   Это установит маску на каталог directory, позволяя всем пользователям и группам иметь полные права доступа.

d. Отображение ACL:
   ```
   getfacl /mnt/documents/file.txt
   ```
   Эта команда отобразит текущие права доступа, установленные для файла file.txt.

e. Удаление прав доступа:
   ```
   setfacl -x u:user1 /mnt/documents/file.txt
   ```
   Это удалит все права доступа для пользователя user1 к файлу file.txt.

Важно помнить, что для использования NFSv4 ACL сервер и клиент должны поддерживать NFSv4. Также, необходимо убедиться, что файловая система, на которой размещены NFS-шары, поддерживает ACL.


В этом уроке мы повторили, что такое протокол NFS, рассказали какие версии были у этого протокола, какие процессы задействованы при работе этого протокола, как взаимодействуют NFS-сервер и клиент. Разобрали практический пример использования этого протокола. Рассказали о том, как реализована безопасность в протоколе NFS.

Следующий урок будет посвящён протоколу iSCSI.
