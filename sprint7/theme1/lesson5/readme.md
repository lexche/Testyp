## Урок 5. Протокол NFS

NFS (Network File System) - это протокол сетевой файловой системы, который позволяет удаленным компьютерам монтировать удаленные файловые системы через сеть и работать с ними так, как если бы они были локальными. Это означает, что клиентский компьютер может получить доступ к файлам и каталогам на удаленном сервере таким же образом, как если бы они находились на его собственном диске.

NFS позволяет обмениваться файлами и ресурсами между компьютерами в сети, что делает его полезным инструментом для совместной работы и обмена данными. Этот протокол широко используется в различных сценариях, включая серверы файлов, резервное копирование данных, виртуализацию и облачные вычисления.

Протокол Network File System (NFS) был разработан компанией Sun Microsystems в конце 1980-х годов и стал одним из первых протоколов сетевой файловой системы для UNIX-подобных операционных систем. Вот краткая историческая справка по версиям протокола NFS:

 Первая версия NFS (NFSv1) была разработана Sun Microsystems и была включена в SunOS 2.0 в 1984. Она предоставляла простую сетевую файловую систему для обмена файлами между компьютерами. Поддерживала базовые операции чтения, записи и исполнения файлов, но не предоставляла надежного кэширования и асинхронной записи. Ограничения по объему данных и числу одновременных запросов.

 Вторая версия NFS (NFSv2) была разработана во второй половине 80х для улучшения производительности и функциональности по сравнению с NFSv1. Она была включена в SunOS 2.0.3.  Улучшенная поддержка символических ссылок и возможность монтирования подкаталогов. Однако, она все еще оставалась простой и ненадежной по современным стандартам. Ограничения по объему данных и числу одновременных запросов.

В 1995 была представлена NFSv3. Третья версия NFS представила значительные улучшения в производительности, функциональности и безопасности. Она стала широко используемым стандартом для сетевого обмена файлами в UNIX-системах. Поддержка более широкого набора операций, улучшенное кэширование и асинхронная запись, повышенные ограничения по объему данных и числу одновременных запросов. Добавлены механизмы аутентификации и авторизации.

 Первая версия NFSv4 (2003 год) была значительным обновлением протокола NFS. Она была разработана с учетом новых требований безопасности, функциональности и эффективности.

- Особенности:
  - Усиление механизмов безопасности с внедрением системы аутентификации и авторизации Kerberos.
  - Поддержка блокировок для обеспечения целостности файлов в разделяемых средах.
  - Возможность разделения файловой системы (File System Namespace) для более гибкой монтировки и управления ресурсами.

2010 год - версия NFSv4.1 внесла некоторые важные изменения и дополнения в протокол, направленные на улучшение и расширение функциональности сетевой файловой системы.

- Особенности:
  - Введение механизма разделенных операций (COMPOUND) для уменьшения накладных расходов и увеличения производительности.
  - Поддержка миграции файловых систем и репликации данных между серверами.
  - Добавление поддержки выборочной кэширования (pNFS) для распределенной работы с данными.
- Производительность:
  - Дальнейшее улучшение производительности и расширенные возможности работы с данными.

В 2016 году вышла NFSv4.2 - Последняя на данный момент версия NFSv4. 

- Особенности:
  - Дополнения в области безопасности и шифрования данных.
  - Улучшения в работе с блокировками и кешированием данных.
  - Расширение функциональности в области аутентификации и авторизации.

Допустим, мы вас заинтересовали и вы захотели начать пользоваться данным протоколом в своей системе. Разберём как этот протокол работает в ОС Linux.

Network File System (NFS) работает по клиент-серверной модели, где сервер предоставляет файловые ресурсы, а клиенты обращаются к ним для доступа к файлам. 

Рассмотрим общий обзор того, как работает сервер NFS:

1. Инициализация и настройка:
   - Сервер NFS должен быть настроен и запущен на хосте, который предоставляет файловые ресурсы для сети.
   - Необходимые файловые системы должны быть определены и настроены для монтирования и предоставления клиентам через NFS.

2. Процесс экспорта ресурсов:
   - Администратор сервера определяет, какие ресурсы файловой системы будут доступны для монтирования клиентами. Это обычно делается в конфигурационном файле /etc/exports на сервере.
   - В этом файле указываются пути к файловым системам, разрешенные клиентам для монтирования, и параметры доступа, такие как IP-адреса клиентов и разрешения на чтение/запись.

3. Ожидание запросов от клиентов:
   - После настройки сервер ожидает запросов от клиентов NFS.
   - Запросы могут включать в себя запросы на чтение, запись, удаление файлов или каталогов, а также управление блокировками и другими метаданными файловой системы.

4. Обработка запросов:
   - Когда сервер получает запрос от клиента, он проверяет его на допустимость и выполняет запрошенную операцию на файловой системе, если это возможно.
   - Обработка запросов может включать чтение или запись данных, управление блокировками, изменение метаданных и другие операции, связанные с управлением файловой системой.

5. Отправка ответов клиенту:
   - После выполнения операции сервер отправляет ответ клиенту, содержащий результат операции или соответствующий статус.
   - Это может быть данные, запрошенные клиентом (например, содержимое файла), или информация об успешном или неуспешном выполнении операции.

6. Управление ресурсами и состоянием:
   - Во время работы сервер может отслеживать состояние файловой системы, управлять кешированием данных, обновлять метаданные и выполнять другие операции, связанные с управлением ресурсами.

7. Завершение сеанса:
   - По завершении операции сервер завершает соединение с клиентом и освобождает ресурсы, связанные с запросом.

Давайте разберём из каких процессов (демонов) состоит сервер NFS:

- rpc.statd: Демон наблюдения за сетевым состоянием (NSM) отслеживает состояние сети и помогает в восстановлении после сбоев. В современных версиях его роль стала менее значимой, но он все еще используется для определенных функций.

- rpc.lockd: Демон блокировки (NFS Lock Manager) управляет запросами на блокировку файлов, чтобы предотвратить конфликты доступа к файлам между клиентами NFS.

- rpc.nfsd: Основной демон сервера NFS обрабатывает запросы клиентов NFS и предоставляет им доступ к файловым ресурсам. В современных версиях его иногда называют nfsd4.

- rpc.mountd: Демон монтирования NFS обрабатывает запросы клиентов на монтирование каталогов с сервера NFS.

- rpc.idmapd: Демон idmapd преобразует локальные идентификаторы пользователей и групп в формат, используемый в NFSv4, и наоборот. Это важно при работе с распределенными системами, где идентификаторы пользователей могут отличаться.

В старых версиях NFS также использовались дополнительные демоны, такие как nfslogd для журналирования активности файловых систем и rquotad для предоставления информации о квотах пользователей.

В NFSv4 с использованием Kerberos дополнительно запускаются следующие демоны:

- rpc.gssd: Демон обеспечивает аутентификацию через GSS-API, что позволяет использовать Kerberos для обеспечения безопасности.

- rpc.svcgssd: Демон сервера NFSv4, который проверяет подлинность клиента на стороне сервера, также используя Kerberos для аутентификации.

Сам процесс монтирования удаленного каталога через протокол NFS происходит следующее:

1. На сервере и клиенте запускается RPC-сервер, который управляется процессом portmapper и регистрируется на портах tcp/111 и udp/111.
2. Запускаются службы, такие как rpc.nfsd и rpc.statd, которые регистрируются на RPC-сервере и используют произвольные сетевые порты (если не заданы статичные порты в настройках).
3. Когда команда mount на клиентском компьютере отправляет запрос ядру для монтирования сетевого каталога, указывая тип файловой системы, хост и каталог, ядро формирует RPC-запрос к процессу portmap на сервере NFS на порт udp/111 (если не указано использовать tcp).
4. Ядро сервера NFS опрашивает RPC о наличии демона rpc.mountd и возвращает ядру клиента сетевой порт, на котором работает демон.
5. Клиентское приложение mount отправляет RPC-запрос на порт, где работает rpc.mountd. Теперь сервер NFS может проверить подлинность клиента по его IP-адресу и номеру порта, чтобы убедиться, что клиент может смонтировать указанную файловую систему.
6. Демон монтирования возвращает описание запрошенной файловой системы.
7. Команда mount на клиенте выполняет системный вызов mount, чтобы связать описание файла, полученное на предыдущем шаге, с локальной точкой монтирования на клиентском хосте. Описание файла сохраняется в коде NFS-клиента, и с этого момента любые пользовательские процессы, обращающиеся к файлам на сервере, будут использовать описание файла как отправную точку.

### Квиз

