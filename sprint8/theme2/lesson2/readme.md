## Урок 2. Запуск и настройка MongoDB

В этом уроке мы расскажем как устанавливать и совершать первичную настройку MongoDB. Перед этим рассмотрим преимущества использования именно этого вида БД, чтобы стало понятнее, почему был выбран именно он:

- Документоориентированные данные. Хранение и управление данными в документоориентированном формате (JSON-like), где каждый документ может содержать различные типы данных.

- Высокая масштабируемость. Распределение данных на несколько серверов (шардинг) и репликация для обеспечения высокой доступности и масштабируемости.

- Динамические схемы. Возможность изменения схемы документов без ущерба для производительности или доступности.

- Сложные запросы. Поддержка богатых возможностей запросов, включая агрегацию данных, фильтрацию и индексирование.

- Хранение и обработка больших данных. Возможность обработки и анализа огромных объемов неструктурированных и полуструктурированных данных.

- Интернет вещей (IoT). Хранение и управление данными от датчиков и устройств в режиме реального времени.

- Мобильные и веб-приложения. Обеспечение гибкого и масштабируемого хранения и поиска данных для мобильных и веб-приложений.

И ещё раз перечислим преимущества перед реляционными БД:

- Документоориентированность: Хранение данных в документоориентированном формате обеспечивает большую гибкость и соответствие реальным данным.

- Горизонтальное масштабирование: Архитектура шардинга позволяет легко добавлять и удалять серверы для удовлетворения растущих потребностей в масштабировании.

- Динамические схемы: MongoDB позволяет динамически изменять схемы без длительных отключений или миграций, обеспечивая быстрое развитие продукта.

- Богатые возможности запросов: MongoDB предоставляет мощные возможности запросов, упрощающие работу с данными и извлечение ценной информации.

- Высокая производительность: MongoDB оптимизирован для обработки больших объемов данных и обеспечивает быстрые операции чтения и записи.

- Распределенная система: Архитектура реплик обеспечивает высокую доступность и отказоустойчивость, предотвращая потерю данных.

- Интеграция с современной технологией: MongoDB хорошо интегрируется с популярными платформами и инструментами, такими как Node.js, Python и облачная платформа.


Перейдём непосредственно к установке MongoDB. На официальном сайте доступно несколько различных продуктов. Скажем пару слов о каждом, чтобы стало понятнее.

#### MongoDB Community Server (бесплатная версия):

• Бесплатная версия с открытым исходным кодом.
• Подходит для разработки, тестирования и небольших производственных сред.
• Обладает всеми основными функциями MongoDB, включая шардинг, репликацию и индексирование.
• Имеет ограниченную техническую поддержку.

#### MongoDB Enterprise Server (коммерческая версия):

• Коммерческая версия с расширенными функциями и поддержкой.
• Подходит для предприятий с критическими для бизнеса приложениями.
• Включает в себя все функции MongoDB Community Server, а также:
    * Расширенный контроль доступа и аудит.
    * Резервное копирование и восстановление с точностью до момента времени.
    * Мониторинг и оповещения в режиме реального времени.
    * Приоритетная техническая поддержка.

#### MongoDB Atlas (управляемая база данных как услуга):

• Полностью управляемая версия MongoDB в облаке.
• Обеспечивает удобство, масштабируемость и безопасность.
• Подходит для предприятий, которые хотят сосредоточиться на своих приложениях, а не на управлении базами данных.

#### MongoDB Ops Manager:

• Инструмент управления, который упрощает развертывание, мониторинг и управление кластерами MongoDB.
• Поддерживает как MongoDB Community Server, так и MongoDB Enterprise Server.

#### Другие версии:

• MongoDB Express: Легковесное издание для разработчиков и студентов.
• MongoDB Stitch: Бессерверная платформа для создания полнофункциональных приложений MongoDB.

Мы будем рассматривать бесплатную версию. На официальном сайте предоставлены дистрибутивы для наиболее используемых ОС:

![8 2 2 1](https://github.com/lexche/Testyp/assets/95694325/c13cf4c2-a2c1-4da1-a0ae-2be8d92e9a69)


Способы установки, как и у другого ПО, есть 2:

1. Скачивание дистрибутива с официального сайта для ОС, которую используете. Затем запускаете скачанный файл и следуете инструкциям установщика.

2. Скачиваете и устанавливаете через терминал (более актуально для Linux подобных ОС).

Более подробно остановимся на втором способе, воспользовавшись инструкцией с оффициального сайта.

### Шаг 1: Добавление репозитория MongoDB

1. Откройте терминал (консоль).
2. Подключитесь к ВМ, на которую хотите установить MongoDB.
3. Добавление ключа репозитория. Добавление ключа репозитория, как в случае с MongoDB, представляет собой один из способов обеспечить безопасность при установке программного обеспечения, особенно с открытым исходным кодом. Ключ репозитория - это цифровая подпись, содержащая информацию о происхождении и подлинности пакетов программного обеспечения.

Когда вы добавляете ключ репозитория, вы фактически проверяете подлинность пакетов, распространяемых через этот репозиторий. При установке пакетов система использует ключ для проверки, что пакеты не были изменены на пути от разработчика к вашему устройству.

Это важный механизм безопасности, который помогает избежать установки поддельного или вирусного программного обеспечения на ваше устройство. Таким образом, добавление ключа репозитория при установке программного обеспечения является важной практикой для обеспечения безопасности вашей системы.

С терминала установите gnupg и curl, если они еще не установлены:

```
sudo apt-get install gnupg curl
```

Чтобы импортировать открытый GPG-ключ MongoDB, выполните следующую команду:

```
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \
   sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg \
   --dearmor
```

4. Добавьте репозиторий MongoDB с помощью команды:

```
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
```

5. Обновите список пакетов с помощью команды:

```
   sudo apt update
```

### Шаг 2: Установка MongoDB

1. Установите MongoDB Community Edition с помощью команды:

```
   sudo apt install -y mongodb-org
```
2. После установки MongoDB будет запущен автоматически в качестве сервиса.

### Шаг 3: Проверка статуса MongoDB

1. Проверьте статус MongoDB, используя команду:

```   
   sudo systemctl status mongod

```
   Вы увидите вывод, показывающий статус сервиса MongoDB, например:

   
![8 2 2 2](https://github.com/lexche/Testyp/assets/95694325/4d54e502-7aa2-4baa-b8d8-e8002c518779)

Однако не всегда установка может пройти без проблем. Например одна из распростанённых ошибок: Mongodb exited with code 14:

![8 2 2 3](https://github.com/lexche/Testyp/assets/95694325/14c2e402-5673-4b14-9327-bec862b5dc8c)

Для решения этой ошибки нужно перенастроить права, например:

```
chown -R mongodb:mongodb /var/lib/mongodb
chown mongodb:mongodb /tmp/mongodb-27017.sock
```

 - chown -R mongodb:mongodb /var/lib/mongodb: Эта команда изменяет владельца и группу для всех файлов и директорий в директории /var/lib/mongodb на mongodb. Здесь:
   - -R означает рекурсивное изменение владельца для всех поддиректорий и файлов в указанной директории.
   - mongodb:mongodb указывает, что владелец изменяется на пользователь mongodb и группу на mongodb.
   - /var/lib/mongodb - это путь к директории, для которой мы изменяем владельца.

- chown mongodb:mongodb /tmp/mongodb-27017.sock: Эта команда изменяет владельца и группу для файла /tmp/mongodb-27017.sock на mongodb. Здесь:
   - mongodb:mongodb указывает, что владелец и группа файла изменяются на пользователь mongodb и группу mongodb.
   - /tmp/mongodb-27017.sock - это путь к файлу, для которого мы изменяем владельца.

### Шаг 4: Начало работы с MongoDB

1. Запустите оболочку MongoDB с помощью команды:

```
   mongosh
```
2. Теперь вы можете начать работу с MongoDB, создавая базы данных, коллекции и выполняя запросы:

![8 2 2 4](https://github.com/lexche/Testyp/assets/95694325/f59e3c51-e46d-40ef-8fb9-79abaa473bbf)

### Практическое задание.

Установите MongoDB Community Server на виртуальную машину.

---

Разберём основные команды в терминале MongoDB (mongosh).

1. Просмотр доступных баз данных:

```
   show dbs
```

2. Создание базы данных:

```
   use mydb
```

3. Создание коллекции:
   Для создания новой коллекции в базе данных используйте метод createCollection, например:
   
   db.createCollection("mycollection")
   

4. Просмотр коллекций:
   Для просмотра списка коллекций в текущей базе данных используйте show collections:
   
   show collections
   

5. Вставка документов в коллекцию:
   Для вставки новых документов в коллекцию используйте insertOne или insertMany, например:
   
   db.mycollection.insertOne({ key: "value" })
   

6. Просмотр содержимого коллекции:
   
   db.users.find()
   
7. Удаление коллекции:

   db.somecollection.drop()
   
8. Удаления базы данных используйте:
   
   db.dropDatabase()

9. Обновление документов:
- Обновление документа в коллекции по определённому критерию:

```
  db.название_коллекции.updateOne({ критерий }, { $set: { поле: новое_значение } })
```

- Обновление нескольких документов в коллекции по определённому критерию:

```
  db.название_коллекции.updateMany({ критерий }, { $set: { поле: новое_значение } })
  ```
 10. Индексирование:

- Создание индекса в коллекции:

  ```
  db.название_коллекции.createIndex({ поле: 1 })
  ```

  - Просмотр всех индексов коллекции:

```
  db.название_коллекции.getIndexes()
```  

- Удаление индекса из коллекции:

  ```
  db.название_коллекции.dropIndex("название_индекса")
  ```

---

#### Настройки сети

настроить параметры сети MongoDB в файле конфигурации /etc/mongod.conf:

• net.bindIp: IP-адрес(а), на которых будет прослушивать MongoDB. По умолчанию: 127.0.0.1 (локальный хост).

• net.port: Порт, на котором будет прослушивать MongoDB. По умолчанию: 27017.

• net.maxIncomingConnections: Максимальное количество одновременных входящих соединений. По умолчанию: 100.

• net.maxConnections: Максимальное количество одновременных соединений, включая входящие и исходящие. По умолчанию: -1 (без ограничений).


#### Настройки безопасности

Давайте настроим аутентификацию, чтобы в базу не мог попасть "кто попало".

1. Заходим в командную оболочку:

```
mongosh
```

2. Подключаемся к базе admin:

```
use admin
```

3. Создаём пользователя, под которым будем заходить:

```
db.createUser({user:"Some_Admin_Account", pwd:passwordPrompt(), roles:[{role:"userAdminAnyDatabase", db:"admin"}, "readWriteAnyDatabase"]})
```
Придумываем и вводим пароль.

4. Включение аутентификации. Для включения аутентификации в MongoDB отредактируйте конфигурационный файл MongoDB (/etc/mongod.conf) и установите параметр security.authorization в значение enabled:

```
security:
   authorization: "enabled"
```

После изменения параметра перезапустите MongoDB:

```
systemctl restart mongod
```

### Практическое задание

Создайте простую базу данных в MongoDB для хранения информации о студентах. База данных должна содержать коллекцию "students" с документами в формате:

{
    "name": "Имя студента",
    "age": Возраст,
    "major": "Специальность",
    "gpa": Средний балл
}

Выведите на экран введённые данные, измените введённые значение, удалите базу данных.

---

В этом уроке вы узнали в каких случаях используется MongoDB, какие продукты предоставляет MongoDB и в чём их отличия. Рассмотрели способы установки. Разобрали как устанавливать MongoDB на ОС Linux(Ubuntu) и производить первичную настройку. Разобрали основные команды, как настраивать сеть, авторизацию и аутентификацию.
