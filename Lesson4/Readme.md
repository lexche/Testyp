## Урок 4. Практическое применение и настройка систем мониторинга.

В прошлом уроке, при разборе систем монитоинга мы уже затрагивали практические применения этих систем. В этом уроке сосредоточимся на практической части.

Начнём с того, что перед этой темой была тема "Контейнеризация" и это неслучайно. Дело в том, что все 3 продукта (Zabbix, Prometheus, Grafana) прекрасно себя "чувствуют" в контейнерах. Иными словами их можно развернуть как привычным путём: скачивание->установка->настройка->запуск, так и с помощью подготовленных контейнеров, которые так же нужно будет адаптировать под свою систему путём настроек.

Давайте разберёмся в чём разница этих двух методов.

#### Установка из пакетов:

1. Производительность. Установка системы мониторинга непосредственно на хост-систему обычно обеспечивает более высокую производительность, поскольку приложение будет запущено нативно на хосте.

2. Легкость управления. Управление системой мониторинга через пакетный менеджер (например, apt или yum) может быть проще для администрирования и масштабирования системы.

3. Доступ к ресурсам. Прямая установка из пакетов позволяет приложению иметь прямой доступ к ресурсам и конфигурациям хост-системы, что может быть полезно в некоторых случаях.

#### Запуск из контейнера:

1. Изоляция. Контейнеры обеспечивают изоляцию приложений и их зависимостей, что позволяет обеспечить надежную работу системы мониторинга без конфликтов с другими компонентами на хост-системе.

2. Портативность. При использовании контейнеров систему мониторинга легче переносить между различными окружениями без необходимости повторной установки и настройки.

3. Интеграция. Обычно контейнерные образы могут быть легче интегрированы с другими инструментами и сервисами благодаря их портативности и универсальности.

#### Какой подход выбрать?

- Контейнеры: Контейнеры часто предпочтительны для развертывания систем мониторинга в распределенной среде, где требуется гибкость и портативность.

- Установка из пакетов: Если вам важна производительность и надежность доступа к ресурсам хоста, установка из пакетов может быть предпочтительным вариантом.

При выборе способа запуска систем мониторинга необходимо учитывать особенности инфраструктуры, требования по производительности, гибкости настройки и управления. Оба подхода имеют свои плюсы и минусы, поэтому важно подходить к выбору с учетом конкретных потребностей вашей системы.

### Квиз. Ответьте правильно на вопросы. Вопросы так же относятся к прошлому уроку:

### Вопрос 1: Какой инструмент используется для визуализации данных в системе мониторинга?

- A) Prometheus
- B) Zabbix
- C) Grafana
- D) Nagios

Правильный ответ: C) Grafana. Grafana представляет собой мощный инструмент визуализации данных, который широко используется для создания красивых и информативных дашбордов на основе данных, собранных системами мониторинга.

### Вопрос 2: Какой компонент системы Zabbix отвечает за сбор и агрегацию метрик?

- A) Zabbix Proxy
- B) Zabbix Agent
- C) Zabbix Server
- D) Zabbix Frontend

Правильный ответ: C) Zabbix Server. Zabbix Server отвечает за сбор, агрегацию и хранение метрик, приходящих от Zabbix Agent и других источников данных.

### Вопрос 3: Какой язык запросов используется для извлечения данных из Prometheus?

- A) SQL
- B) JSON
- C) YAML
- D) PromQL

Правильный ответ: D) PromQL. PromQL (Prometheus Query Language) - это язык запросов, специально разработанный для работы с данными, сохраненными в базе данных Prometheus.

### Вопрос 4: Какой метод использования систем мониторинга обеспечивает большую гибкость и портативность?

- A) Установка из пакетов
- B) Запуск из контейнера
- C) Ручная установка
- D) Сборка из исходного кода

Правильный ответ: B) Запуск из контейнера. Запуск систем мониторинга из контейнера обеспечивает большую гибкость, портативность и изоляцию приложения и его зависимостей.

---

Надеюсь, нам удалось усыпить вашу бдительность теорией, поэтому самое время перейти к практике. 

В прошлом уроке мы разбирали пример, когда Zabbix был уже установлен и мы "поковырялись" в его настройках через web-интерфейс. В этом уроке давайте научимся его устанавливать из пакетов.

В первую очередь стоит посетить официальный сайт Zabbix: https://www.zabbix.com/download и посмотреть, какой релиз у них актуален:

![4 7 1](https://github.com/lexche/Testyp/assets/95694325/72997c44-216e-4f5d-8fed-54ef1544e710)

Как видите, они хоть и не Tefal, но тоже о нас думают. Вы можете выбрать необходимый релиз, дистрибутив ОС, версию ОС, какие компоненты вы хотите установить, какой тип БД и какой Web-сервер вы хотите использовать.
После того, как вы сделаете выбор, внизу появится список команд, выполнив которые, вы запустите на своей ОС сервер мониторинга Zabbix. Давайте посмотрим и дадим объяснения этим командам.

Первое на что стоит обратить внимание - это то, что по мнению разработчиков zabbix на сервере, на который мы планируем устанавливать zabbix, уже установлен пакет с базами данных. Но так как мы рассматриваем установку с нуля, то давайте установим необходимый пакет перед тем как перейти к основной части:

```

sudo apt update

sudo apt install mysql-server

systemctl start mysql

```

Для демонстрации мы оставим дефолтные настройки. (Прим. автора можно написать, что подробно об этом поговорим в следующих уроках, если про БД будет дальше в курсе). После установки запускаем MySQL.

Далее пойдём по предложенному официальным сайтом сценарию, первым делом устанавливаем репозиторий zabbix'а:

```

# wget https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu22.04_all.deb
# dpkg -i zabbix-release_6.4-1+ubuntu22.04_all.deb
# apt update

```

1я строчка использует wget для загрузки пакета zabbix-release, который необходим для установки репозитория Zabbix на Ubuntu 22.04.

2я строка  устанавливает загруженный пакет zabbix-release с версией 6.4 на систему.

3я строка после установки нового репозитория обновляет список пакетов из всех доступных репозиториев для получения актуальной информации о пакетах и их версиях. Это действие помогает синхронизировать локальное хранилище пакетов с обновленным списком пакетов из репозиториев.

Идём далее, устанавливаем необходимые пакеты:

```

# apt install zabbix-server-mysql zabbix-frontend-php zabbix-nginx-conf zabbix-sql-scripts zabbix-agent

```

Далее создаём базу для нашей системы мониторинга с помощью ранее установленного пакета mysql:

```

# mysql -uroot -p
your_password
mysql> create database zabbix character set utf8mb4 collate utf8mb4_bin;
mysql> create user zabbix@localhost identified by 'your_password';
mysql> grant all privileges on zabbix.* to zabbix@localhost;
mysql> set global log_bin_trust_function_creators = 1;
mysql> quit;

```

Дадаим несколько комментариев к написанному. 

2я строка "your_password" это пароль, который вы присвоилипользователю root при установке, если вы оставили всё как есть, то введите в строке поисковика "mysql default password" и выясните какой пароль самостоятельно.

3я строка "create database zabbix" создаём БД с именем zabbix, может быть другое имя, но для простоты идентификации используем это.

4я строка create user zabbix@localhost identified by 'your_password'; zabbix@localhost - имя пользователя, вместо zabbix может быть другое имя пользователя, zabbix используется для простоты идентификации, 'your_password' - пароль для этого пользователя, придумываете самостоятельно и не забываете его через 2 минуты, он нам ещё пригодиться.

Идём далее:

```

# zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p zabbix

```

Эта команда извлекает схему базы данных Zabbix из архива server.sql.gz, распаковывает ее и передает результат в команду mysql, которая импортирует схему в базу данных Zabbix в MySQL с указанной кодировкой и учетными данными пользователя zabbix.

```
# mysql -uroot -p
password
mysql> set global log_bin_trust_function_creators = 0;
mysql> quit;
```

 Эта последовательность команд позволяет подключиться к MySQL, изменить значение переменной конфигурации для ограничения доступа к функциям создания и прекратить сеанс взаимодействия с MySQL. Установка значения log_bin_trust_function_creators на 0 повышает безопасность за счет ограничения возможности создания функций в реплицируемых базах данных.

Далее вносим изменения в файлы конфигурации, сначала в /etc/zabbix/zabbix_server.conf в строку:

DBPassword=password

вставляем пароль, про который выше писали, что забывать его пока рано. Если всё остальное оставляли как в инструкции, то значения по умолчанию подойдут.

Далее в файле конфигурации web-сервера  /etc/zabbix/nginx.conf раскоментируем следующие строки:

```
# listen 8080;

# server_name your_ip_address;
```

Перезапустим службы Zabbix сервера и агента:

```
systemctl restart zabbix-server zabbix-agent nginx php8.1-fpm
```

Добавление в автозапуск служб Zabbix сервера и агента:

```
systemctl enable zabbix-server zabbix-agent php8.1-fpm
```
Когда мы устанавливаем Zabbix, мы копируем файлы для веб-интерфейса в папку /usr/share/zabbix. Но наш веб-сервер Nginx обычно работает с другой папкой, а именно /var/www/html. Чтобы это заработало, мы должны изменить путь в конфигурационном файле Nginx.

Открываем файл настройки по пути /etc/nginx/sites-enabled/default с помощью редактора nano или другого и изменяем строку root /usr/share/zabbix; на root /var/www/html;. 

После этого перезапускаем Nginx командой:

```
systemctl restart nginx.
```

Прежде чем открывать Zabbix в браузере, важно добавить правила для файрвола UFW, чтобы разрешить доступ к портам, с которыми работает Zabbix и Nginx. Мы разрешаем доступ к портам 10050/tcp, 10051/tcp и 80/tcp, а затем перезагружаем наши правила:

```

ufw allow 10050/tcp

ufw allow 10051/tcp

ufw allow 80/tcp

ufw reload

```

Теперь можно открыть браузер и ввести в адресной строке http://your_ip_address, чтобы начать донастройку Zabbix через web-интерфейс:

![4 7 2](https://github.com/lexche/Testyp/assets/95694325/58bf0580-90ac-452d-9f71-7b4d1531d2d2)


### Практическое задание с самопроверкой.

Установите на свои рабочие станции Zabbix, донастройте его через Web-интерфейс самостоятельно, соберите информацию о сервере (в примере, который мы разбирали в этом уроке, помимо сервера мониторинга устанавливался и zabbix агент, пример настройки агента мы рассматривали в прошлом уроке.).

---

Прометеус обходится без применения агентов на мониторируемых хостах. Вместо этого он использует экспортеры (exporters) для сбора метрик и мониторинга различных приложений и систем. 

ринцип работы Prometheus без агентов включает в себя следующие ключевые шаги:

#### 1. Экспортеры (Exporters):
Экспортеры — это программы, которые предоставляют доступ к внутренним метрикам и метаданным приложений или систем. Они работают как "мост" между приложением и Prometheus, экспортируя данные в формате, который Prometheus понимает.

#### 2. HTTP Протокол:
Prometheus собирает метрики от экспортеров по HTTP протоколу. Экспортеры обычно предоставляют метрики в формате текстового формата "Exposition format", который Prometheus умеет читать и обрабатывать.

#### 3. Система Сбора и Хранения Данных:
В Prometheus есть встроенная система сбора и хранения данных. Он периодически делает запросы к экспортерам для получения метрик, сохраняет их в собственном временном рядовом хранилище и обеспечивает возможность визуализации и анализа данных.

Давайте подробнее остановимся на таком понятии как экспортеры. Экспортеры (Exporters) в контексте Prometheus представляют собой программные компоненты, которые предоставляют доступ к метрикам и статистике различных приложений, сервисов, или устройств. Они играют ключевую роль в процессе мониторинга, поскольку позволяют собирать данные из разнообразных источников и предоставлять их Prometheus в формате, который он понимает.

### Как работают экспортеры:

1. Сбор метрик:
   - Экспортеры работают внутри приложений или сетевых устройств и собирают различные метрики, такие как использование ресурсов (CPU, память), количество запросов, задержки и другие показатели, которые важны для мониторинга и анализа работы приложения.

2. Предоставление метрик:
   - Экспортеры предоставляют собранные метрики в формате, который соответствует формату сбора данных Prometheus. Обычно это формат exposition, который представляет собой текстовый формат с показателями и значениями метрик.

3. HTTP Интерфейс:
   - Экспортеры обычно предоставляют HTTP интерфейс, по которому Prometheus может делать запросы для получения метрик. Prometheus регулярно обращается к этому интерфейсу, чтобы собирать актуальные данные.

### Примеры приложений экспортеров:

1. Node Exporter:
   - Node Exporter является одним из наиболее популярных экспортеров для мониторинга системных ресурсов хоста. Он собирает информацию о нагрузке CPU, использовании памяти, дисков и других системных параметрах.

2. MySQL Exporter:
   - MySQL Exporter позволяет собирать метрики о работе MySQL сервера, такие как количество запросов, время выполнения запросов, потребление ресурсов и другие важные статистики.

3. Blackbox Exporter:
   - Blackbox Exporter позволяет проверять доступность и производительность сетевых конечных точек, таких как веб-сервисы, API и другие системы, собирая метрики о времени ответа, статусе HTTP запросов и других данных.

В этом уроке мы узнали о способах установки систем мониторинга. Разобрали как установить систему мониторинга на примере Zabbix. Рассмотрели как Prometheus осуществляет сбор данных и что тако экспортеры в контексте Prometheus.
