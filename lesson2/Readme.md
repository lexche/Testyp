## Урок 2. Траблшутинг производительности в Linux.

Как понять, что "болит" у сервера? Какие ресурсы необходимо добавить? Какой процесс "съедает" те или иные ресурсы? Расскажем в этом уроке.

<p align="center">
<img src="https://github.com/lexche/Testyp/assets/95694325/805d0a76-1365-45c7-8f45-ca1413144492" width="500" height="500">
</p>

В ОС Linux есть встроенный "инструментарий" для сбора статистики о работе системы. Задача системного администратора уметь с этими инструменами работать, чтобы получать нужную информацию и правильно её интерпретировать. В большинстве случаев системного администратора интересуют 4 показателя: процессор, оперативная память, жёсткий диск и сеть.

Рассмотрим встроенные в ОС Linux утилиты, так как эти утилиты являются мощными инструментами для мониторинга системы в реальном времени. Они помогают администраторам систем и пользователям отслеживать ресурсы, процессы и работу системы, что позволяет быстро реагировать на изменения и оптимизировать работу системы.

Рассмотрим основные:


- Vmstat.

Стандартный вывод утилиты vmstat:

  ```bash
   vmstat

procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0 122228 672268 600112 5426320    0    0     2    76    1    0  1  1 98  0  0
```
Использование vmstat с ключом -w для вывода расширенной информации.

Как вы можете заметить это общий набор информации, рассмотрим как мониторить каждый из компонентов: процессор, оперативная память, жёсткий диск, сетевая активность.

#### Процессор

- Top.

Стандартный вывод утилиты top:

  ```bash
   top
   ```

выглядит следующим образом:


![4 6 2](https://github.com/lexche/Testyp/assets/95694325/82048bc3-f884-4520-b759-edf60a475b96)



1. Запуск top и сортировка процессов по использованию CPU. Команда: top, нажатие Shift + P. Этот ключ позволяет сортировать процессы по использованию памяти. После нажатия Shift + m top будет отображать процессы в порядке убывания использования памяти.

2. Просмотр загрузки каждого ядра процессора в top. команда: top, нажатие 1 .Данная опция позволяет просматривать загрузку каждого ядра процессора отдельно, что полезно при мониторинге многоядерных систем.

#### Оперативная память

- Free

Команда free используется для отображения информации об использовании оперативной памяти и подкачки в системе.

1. Простой вывод информации:
   Запустите в терминале команду:

   ```bash
   free
   ```

   Это покажет общее количество, использованную, свободную и занятую оперативную память, а также информацию о подкачке.

2. Человекочитаемый формат:
   Для более удобного отображения в гигабайтах, использовайте ключ -h:

   ```bash
   free -h
   ```

   Это представит результаты в более понятном виде для человека.

3. -s
   Ключ -s позволяет отобразить дополнительные статистические данные о использовании оперативной памяти.

4. -t
   Ключ -t покажет итоговую строку суммарно по всем столбцам:

5. -l
   Ключ -l покажет информацию о буферах и кэше:

#### Жёсткий диск

- Df

Команда df (disk free) позволяет отображать информацию о доступном месте на диске.

1. Простой вывод информации:
   Запустите в терминале команду df:

   ```
    df
   Filesystem                        1K-blocks     Used Available Use% Mounted on
   tmpfs                                805892     1844    804048   1% /run
   /dev/mapper/ubuntu--vg-ubuntu--lv 102626232 36022944  61344024  37% /
   tmpfs                               4029448        0   4029448   0% /dev/shm
   tmpfs                                  5120        0      5120   0% /run/lock
   /dev/sda2                           1992552   257828   1613484  14% /boot
   /dev/sda1                           1098628     6220   1092408   1% /boot/efi
   tmpfs                                805888        0    805888   0% /run/user/1000

   ```

   Это покажет общее использование дискового пространства по каждой файловой системе на вашем компьютере.

2. Человекочитаемый формат:
   Для более удобного чтения, добавьте ключ -h:

   ```bash
   df -h
   ```

   Это представит результаты в удобном формате с использованием гигабайтов.

3. -a
   Ключ -a в команде df используется для отображения информации о всех файловых системах, включая те, которые обычно не отображаются по умолчанию.

   Пример:

   ```bash
   df -a
   ```

4. -T
   Ключ -T отображает тип файловой системы для каждой точки монтирования:

   ```bash
   df -T
   ```

5. -x
   Ключ -x позволяет исключить определенные типы файловых систем из отображения:

   ```bash
   df -x tmpfs
   ```

   Это исключит файловые системы типа tmpfs из вывода.

#### Сетевая активность

Встроенные утилиты могут дать минмальную информацию о сетевой активности ОС, например:

- Ip. Команда ip в ОС Linux предназначена для настройки сетевых интерфейсов, но так же может предоставить информацию, например:

1. ip route show
   С помощью ip route show можно просмотреть текущие маршруты IP-адресов на вашей системе.


2. ip -s link show
   Если вам нужно получить статистику о сетевых интерфейсах, вы можете использовать ключ -s для отображения дополнительной подробной статистики.

3. ip -s address show
   Аналогично, ключ -s можно использовать для отображения статистики по IP-адресам на каждом интерфейсе.

   - Netstat. Утилита, предоставляющая информацию о сетевой активности, сетевых соединениях, маршрутах и т. д., например:
  
1. -a - Отображение всех сетевых соединений:
   ```bash
   netstat -a
   ```
   - Показывает все сетевые соединения, включая прослушивающие порты.
   - Позволяет увидеть все активные соединения на машине.

2. -t - Показ только TCP соединений:
   ```bash
   netstat -t
   ```
   - Отображает только TCP соединения.
   - Полезно для фильтрации и отображения только TCP соединений.

3. -rn - Вывод маршрутов в числовом формате:
   ```bash
   netstat -rn
   ```
   - Показывает сетевые маршруты в числовом формате.
   - Используется для обеспечения лучшей читаемости вывода.
  
- Tcpdump. Утилита командной строки, используемая для захвата и анализа пакетов сети, например:

1. -i - Захват трафика на определенном интерфейсе:
   ```bash
   tcpdump -i eth0
   ```
   - eth0 - имя сетевого интерфейса.
   - Позволяет захватывать и анализировать трафик на указанном сетевом интерфейсе.

2. -n - Вывод IP-адресов числами (не в виде имен):
   ```bash
   tcpdump -n
   ```
   - Показывает IP-адреса в числовом формате.
   - Удобно для быстрого анализа, минуя дополнительные DNS-запросы.

3. -s - Ограничение размера захватываемых пакетов:
   ```bash
   tcpdump -s 128
   ```
   - Ограничивает размер захваченных пакетов до 128 байт.
   - Полезно для уменьшения нагрузки на систему при обработке большого трафика.

### Квиз

1. Вопрос: Какую информацию показывает команда free -m?
   a) Использование дискового пространства.
   b) Загрузку сетевых интерфейсов.
   c) Использование памяти в мегабайтах.
   d) Список текущих процессов.

   Правильный ответ: c) Использование памяти в мегабайтах.

2. Вопрос: Что отображает команда df -h в Linux?
   a) Информацию о текущих активных сетевых соединениях.
   b) Объем свободного места на диске в удобочитаемом формате.
   c) Список всех установленных программ и их версии.
   d) Статистику работы сетевых интерфейсов.

   Правильный ответ: b) Объем свободного места на диске в удобочитаемом формате.

3. Вопрос: Какие данные выведет команда ip route show?
   a) Информацию о текущих маршрутах IP-адресов на системе.
   b) Список всех установленных пакетов и их зависимостей.
   c) Статистику использования оперативной памяти.
   d) Список текущих процессов на компьютере.

   Правильный ответ: a) Информацию о текущих маршрутах IP-адресов на системе.

4. Вопрос: Что показывает команда top в Linux?
   a) Список всех файлов на компьютере.
   b) Загруженность процессора и памяти системы.
   c) Список всех установленных пакетов.
   d) Состояние сетевых интерфейсов.


   Правильный ответ: b) Загруженность процессора и памяти системы.

---

С инструментами понятно, но важно понимать, что они показывают и на что стоит обращать внимание в 1ю очередь. Давайте в этом разберёмся.

Для примера используем вывод команды top, так как в нём содержится много метрик:

![4 6 2](https://github.com/lexche/Testyp/assets/95694325/82048bc3-f884-4520-b759-edf60a475b96)

##### 1. Load Average (средняя загрузка, далее LA, правый верхний угол на скрине)

В Linux LA является показателем, отражающим среднюю нагрузку на систему за определенный период времени. Этот показатель представлен трёмя числами, обычно в формате "Load Average: 0.26, 0.20, 0.18". Каждое число относится к определенному временному интервалу: за последнюю минуту, за последние 5 минут и за последние 15 минут соответственно. LA должно быть сопоставимо с количеством ядер процессора. Значения, превышающие количество ядер, могут сигнализировать о загрузке.

Как Linux считает метрику Load Average:

1. Каждый процесс имеет свой приоритет.
2. При появлении процесса он получает свой приоритет и вес.
3. Система смотрит на количество процессов в очереди.
4. Значение Load Average показывает количество процессов в очереди.
5. Load Average ниже числа ядер процессора обычно считается нормальным.
6. Значения превышающие количество ядер могут сигнализировать о перегрузке.

Почему Load Average не всегда достаточен:

1. Не учитывает контекст процессов:
   - Load Average не отражает важность процессов и их влияние на систему. Он не говорит о том, какие именно процессы создают загрузку на систему.

2. Не учитывает I/O операции:
   - Метрика Load Average не учитывает нагрузку от операций ввода/вывода (I/O), что может быть значимым фактором при определении производительности системы.

3. Может быть неточной в многопроцессорных системах:
   - В многопроцессорных системах Load Average может быть менее точным показателем, так как он не учитывает специфику каждого ядра.

4. Не учитывает асимметричные нагрузки:
   - Load Average считает среднюю загрузку на все ядра, что может быть неточно при асимметричной нагрузке на различные ядра.

### Квиз: Трактовка значения Load Average в ОС Linux

1. Вопрос: Что означает Load Average в Linux?

   a) Свободное место на жестком диске.

   b) Среднюю загрузку системы за определенный период.

   c) Использование оперативной памяти.

   d) Скорость интернет-подключения.

   Правильный ответ: b) Среднюю загрузку системы за определенный период.
   Объяснение: Load Average представляет собой среднюю нагрузку на процессор системы за указанные временные промежутки.

2. Вопрос: Какие временные интервалы обычно представлены в значении Load Average?

   a) 1 минута, 5 минут, 10 минут.

   b) 10 минут, 20 минут, 30 минут.

   c) 1 минута, 5 минут, 15 минут.

   d) 5 минут, 15 минут, 30 минут.

   Правильный ответ: c) 1 минута, 5 минут, 15 минут.
   Объяснение: Обычно Load Average представлен в трех значениях для последних 1, 5 и 15 минут.

3. Вопрос: Какие значения Load Average считаются нормальными для системы с 4 ядрами процессора?

   a) 5.0, 3.0, 2.0
   
   b) 2.0, 1.5, 1.0

   c) 4.0, 4.0, 4.0

   d) 1.0, 0.5, 0.25

   Правильный ответ: b) 2.0, 1.5, 1.0.
   Объяснение: Обычно Load Average ниже количества ядер процессора считается нормальной нагрузкой, поэтому для системы с 4 ядрами значения примерно 2.0, 1.5, 1.0 будут в норме.

5. Вопрос: Почему Load Average не является исчерпывающим показателем состояния системы?

   a) Не показывает загрузку оперативной памяти.

   b) Не учитывает использование жесткого диска.

   c) Не указывает на конкретные причины загрузки системы.

   d) Не показывает активность сети.

   Правильный ответ: c) Не указывает на конкретные причины загрузки системы.
   Объяснение: Load Average не дает детальной информации о причинах загрузки системы, а только показывает общую нагрузку по времени.

   #### 2. Задачи (Tasks):
   - total,  running, sleeping, stopped, zombie:
     - total: Общее количество задач.
     - running: Количество активных задач.
     - sleeping: Количество спящих задач.
     - stopped: Количество остановленных задач.
     - zombie: Количество зомби-процессов.

   #### 3. Использование процессора (%Cpu(s)):
   - %Cpu(s):  us,  sy,  ni,  id,  wa,  hi,  si,  st:
     - us: Использование процессора пользовательскими процессами.
     - sy: Использование процессора системными процессами.
     - id: Простой процессора (не используется).
     - wa: Ожидание ввода/вывода.
     - hi: Обработка аппаратных прерываний.
     - si: Обработка программных прерываний.
     - st: Время, которое процессор тратит на виртуализацию другого процессора.

   #### 4. Использование памяти (MiB Mem):
   - MiB Mem:  total,  free,  used, buff/cache:
     - total: Общее количество оперативной памяти.
     - free: Доступное количество свободной памяти.
     - used: Используемая память.
     - buff/cache: Размер буфера и кэша памяти.

  #### 5. Использование Swap (MiB Swap):
   - MiB Swap:  total,  free,  used, avail Mem:
     - total: Общее количество swap-памяти.
     - free: Свободное место в swap-памяти.
     - used: Используемая swap-память.
     - avail Mem: Количество доступной оперативной памяти для новых процессов.
     - 
Вывод команды df:

  ```
    df
   Filesystem                        1K-blocks     Used Available Use% Mounted on
   ```

1. Filesystem:
   - Это название файловой системы, на которую ссылается запись.

2. 1K-blocks:
   - Показывает общий объем доступного пространства в килобайтах на указанной файловой системе.

3. Used:
   - Обозначает количество использованных килобайтов на файловой системе.

4. Available:
   - Обозначает количество доступных (свободных) килобайтов для записи на файловой системе.

5. Use%:
   - Отражает процент использования доступного пространства на файловой системе.

6. Mounted on:
   - Это место в файловой системе, куда произошло ее монтирование (подключение), например, /, /home, /var.
  
Вывод команды netstat:

```
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 192.168.1.2:22          203.0.113.10:54321      ESTABLISHED
udp        0      0 0.0.0.0:123             0.0.0.0:*
```

1. Proto:
   - Это протокол сетевого соединения, например, TCP, UDP, ICMP.

2. RefCnt:
   - Счетчик ссылок на соединение.

3. Flags:
   - Флаги, связанные с сокетом или соединением.

4. Type:
   - Тип сетевого соединения, например, SOCK_STREAM (для TCP), SOCK_DGRAM (для UDP).

5. State:
   - Состояние сетевого соединения, такое как ESTABLISHED (установленное), LISTEN (слушающее), CLOSED (закрытое).

6. I-Node:
   - Номер индексного узла (inode), используемый для отслеживания открытых файлов и соединений.

7. Path:
   - Путь к сокету или файлу.

### Практическое задание. 

Ниже будет  представленонесколько ситуаций и выводов диагностических команд. Вам нужно определить всё ли хорошо с системой, если нет, то что не так.

1.Ситуация. 

```
top - 10:30:45 up 1 day, 3:15, 2 users, load average: 7.89, 8.20, 8.55
Tasks: 285 total, 2 running, 283 sleeping, 0 stopped, 0 zombie
%Cpu(s): 90.2 us, 8.5 sy, 0.0 ni, 0.0 id, 0.0 wa, 1.2 hi, 0.1 si, 0.0 st
MiB Mem :  16384.0 total,  1108.0 free,  15276.0 used,    0.0 buff/cache
MiB Swap:   2048.0 total,   110.0 free,   1938.0 used.    0.0 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 3245 mysql     20   0 10.5g  5.2g  68844 S 400.0   32.0  800:16.37 mysqld
 1234 www-data  20   0  2.4g  1.2g  48876 S 200.0   7.5  150:24.53 apache2
 5678 root      20   0  1.6g  1.4g  34520 R 110.0   8.7  100:58.22 python
```
