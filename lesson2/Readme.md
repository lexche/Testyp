# Урок 1. Режим ядра
___

  Представьте ситуацию, что одна из программ пытается выполнить операцию, которая может повлечь за собой серьёзные последствия для безопасности всей системы. Как должна реагировать операционная система, чтобы предотвратить это и сохранить стабильность работы? 
В Linux выделяют два режима работы операционной системы: 
-	Пользовательский режим (User Mode). В пользовательском режиме приложения и пользовательские процессы выполняются с ограниченными правами доступа к аппаратному обеспечению. В этом режиме приложения работают в исключительно безопасной среде, они не могут прямо взаимодействовать с аппаратными ресурсами, такими как процессор и память. Если приложение попытается выполнить привилегированную операцию, оно генерирует исключение, которое обрабатывается ядром операционной системы.

Изображение:  Один ключ, много дверей с разными скважинами, визуально ключ подходит только к двери, где сверху написано user, что то типа такого:
![2 1](https://github.com/lexche/Testyp/assets/95694325/3be4f69e-3a50-4850-812c-230fb3ec69d6)



-	Режим ядра (Kernel Mode). Режим ядра, также известный как привилегированный режим, обеспечивает полный доступ к аппаратному обеспечению компьютера. В этом режиме ядро операционной системы имеет прямой доступ ко всем аппаратным ресурсам, таким как процессор, память, устройства ввода/вывода и другие. Кроме того, в режиме ядра можно выполнять инструкции, которые запрещены в пользовательском режиме.
Изображение: тоже что и первое, только замочные скважины все одинаковые, визуально ко всем подходит ключ.
![2 2](https://github.com/lexche/Testyp/assets/95694325/cb9b3b3e-946a-4b26-98a7-d0b39f79944e)


Вот основные задачи, которые решаются в режиме ядра:
1. Управление памятью. Ядро операционной системы отслеживает выделение и освобождение памяти для процессов и управляет виртуальной и физической памятью.
1. Планирование задач. Оно отвечает за распределение процессорного времени между процессами и потоками, устанавливает их приоритеты и выделяет ресурсы.
1. Управление файловыми системами. Ядро обеспечивает взаимодействие с файловыми системами, управляет операциями чтения/записи на дисках и другими действиями, связанными с файловыми системами.
1. Управление устройствами ввода/вывода. Контролирует доступ к устройствам ввода/вывода, управляет драйверами устройств и обеспечивает их корректную и безопасную работу.
1. Обеспечение безопасности и управление привилегиями.  Ядро Linux реализует механизмы безопасности, контроля доступа и управления привилегиями процессов, обеспечивая безопасность системы.
1. Обработка системных вызовов. Ядро обеспечивает выполнение операций в привилегированном режиме и обрабатывает системные вызовы.
1. Инициализация и управление процессами. Ядро управляет созданием, завершением и планированием процессов в системе.
1. Обработка прерываний и исключений. Ядро обрабатывает аппаратные прерывания и исключения, связанные с аппаратным обеспечением компьютера, такие как дисковые операции, сетевая работа, обработка таймеров и т.д.
1. Интерактивные средства отладки. Ядро Linux предоставляет интерактивные средства отладки для локализации и устранения проблем операционной системы.
Режимы ядра и пользовательского пространства обеспечивают изоляцию пользовательских процессов и привилегированных операций от основной части операционной системы. Это улучшает безопасность и стабильность системы, так как предотвращает несанкционированный доступ к аппаратным ресурсам.

## ПЗ
Итак, мы уже понимаем, в чём разница между этими режимами. Давайте определим, что из нижеперечисленного к какому режиму относится: Ядро\Пользователь

| Дейсвие                                                              | Режим       |
|----------------------------------------------------------------------|------------------|
|	Доступ к файловой системе | Ядро |
|	Редактирование текстового документа | Пользователь |
|	Управление оперативной памятью | Ядро |
|	Просмотр веб-страницы | Пользователь |
***

Когда процессор исполняет программу в пользовательском режиме, все инструкции выполняются от имени этого процесса. Однако, в случае необходимости выполнения определенных привилегированных операций, таких как работа с аппаратными ресурсами или изменение системных настроек, процесс должен переключиться в режим ядра.

Изображение: 2 изображения рядом. Режим ядра синим(можно просто надпись) и ядро ос схематично. Взаимодействие обозначить просто стрелками синего цвета в обе стороны. Пользовательский режим зелёный, так же текстом обозначить, от него зелёные стрелки, но ближе к ядру стрелки ОС становятся синими и зеркально в обратную сторону.

Переключение между пользовательским режимом и режимом ядра в Linux возможно в нескольких случаях:

-	Прерывания аппаратного обеспечения.
  
Прерывания аппаратного обеспечения представляют собой механизм, с помощью которого устройства могут сигнализировать процессору о возникновении событий или запросах на обслуживание. Прерывания используются для обработки различных событий ввода-вывода, таких как завершение операции ввода-вывода, обнаружение ошибок ввода-вывода, обработка сетевых пакетов и т. д. 
Когда процессор получает прерывание, он останавливает текущую инструкцию, сохраняет свое состояние выполнения и передает управление обработчику прерывания (interrupt handler). Этот обработчик прерывания выполняет определенные действия по обработке прерывания, такие как чтение данных из устройства, обновление состояния системы и т. д.

-	Использование модулей ядра.
  
Модули ядра — это программные компоненты, которые могут быть динамически загружены и выгружены из ядра операционной системы. Они расширяют функциональность ядра, предоставляя новые возможности, драйверы устройств, файловые системы, сетевые протоколы и так далее.
Использование модулей ядра позволяет операционной системе динамически расширять свои возможности без перезагрузки. Например, при подключении нового устройства памяти операционная система может загрузить соответствующий модуль ядра для обеспечения поддержки этого устройства без необходимости перезагрузки всей системы.

  Зачастую эти 2 случая используются вместе. Когда аппаратное устройство сигнализирует о возникновении события, часто это приводит к генерации прерывания. Обработчик прерывания, в свою очередь, может вызвать соответствующий модуль ядра для дальнейшей обработки события.
Например, если сетевая карта генерирует прерывание о прибытии нового пакета данных, обработчик прерывания может вызвать модуль ядра, ответственный за сетевые операции, чтобы обработать и передать эти данные в ядро или в пользовательское пространство.
То есть прерывания аппаратного обеспечения и модули ядра взаимодействуют для обеспечения обработки событий ввода-вывода и расширения возможностей ядра операционной системы.
  
-	Использование системных вызовов. системный вызов - механизм взаимодействия пользовательской программы с ядром ОС.
Переключение происходит следующим образом:
1.	Процесс выполняет системный вызов.
1.	Процессор делает прерывание и переходит в режим ядра.
1.	Ядро выполняет указанную системную функцию и возвращает управление процессу в пользовательском режиме.
1.	Процесс продолжает свое выполнение в пользовательском режиме.
Такой механизм позволяет ядру контролировать доступ к привилегированным операциям и ресурсам системы. Ядро Linux предоставляет широкий спектр системных вызовов для выполнения различных операций, таких как чтение и запись файлов, создание и управление процессами, управление сетевыми соединениями и т. д.
	
  Помимо вышесказанного стоит отдельно сказать о утилите sudo (superuser do). Это утилита в Unix-подобных операционных системах, которая позволяет пользователям запускать программы с привилегиями суперпользователя (root) или других пользователей с дополнительным подтверждением пароля. Такое подтверждение обычно требуется для операций, которые могут иметь серьезные последствия или потенциально опасны для системы. Это очень полезно для выполнения команд, которые требуют повышенных привилегий без необходимости постоянного входа в систему под другим пользователем. 
Таким образом, если у вас есть обычный пользовательский аккаунт, и вам нужно выполнить какую-то команду, которая требует прав суперпользователя, вы можете использовать sudo для временного получения этих прав.
Например, если вы хотите обновить пакеты на вашем Linux-ПК, который требует привилегий суперпользователя, вы можете использовать sudo перед командой:

```
sudo apt update
```

## ПЗ
Немного усложним сценарии, имея ввиду полученную информацию, перед вами несколько сценариев, как отреагирует на них система (отклонит, разрешит, запросит дополнительное подтверждение)?

Добавление папки на рабочий стол текущего пользователя:
```mkdir /home/user/desktop/somefolder```    Разрешит

Удаление папки не из профиля пользователя с использованием утилиты sudo: ```sudo rm -rf /important/directory``` Запросит дополнительное подтверждение

Обновление пакетов на Вашем ПК: ```apt update```  Запретит

Просмотр списка групп на данном компьютере: ```groups``` Разрешит.

Помимо встроенной защиты ОС есть и дополнительные инструменты защиты ядра ОС. Наиболее популярный из них – SELinux (в настоящее время зачастую предустановлен в ОС), или Security-Enhanced Linux, представляет собой набор расширений безопасности ядра Linux, предоставляющих механизм контроля доступа на основе мандатной модели безопасности. В простых терминах, SELinux позволяет более детально управлять тем, как процессы, пользователи и приложения взаимодействуют с ресурсами в системе.
Вот несколько ключевых концепций по управлению привилегиями и безопасности в операционных системах:
- Мандатная модель безопасности: В мандатной модели каждый объект (файл, процесс и т. д.) и каждый субъект (пользователь, процесс и т. д.) имеют метки безопасности. SELinux использует эту модель для определения того, кто может выполнять какие действия.
   Например, в SELinux файлы и процессы могут иметь метки безопасности, такие как user, role, type, level, которые определяют их права на выполнение определенных операций.
   
- Политики безопасности: SELinux основан на политиках безопасности, определяющих правила доступа для различных типов объектов и субъектов в системе. Эти политики содержат информацию о том, какие действия разрешены для объектов различных типов.
   Например, политика SELinux может содержать правило, разрешающее веб-серверу только чтение файлов, но не их запись или выполнение.
  
- Контекст безопасности: SELinux присваивает контекст безопасности для объектов и субъектов в системе. Контекст безопасности содержит информацию о метках безопасности, которые определяют их разрешения.
   Например, процесс в SELinux может иметь контекст безопасности, который определяет его роль и тип, а файлы могут иметь контекст безопасности, определяющий разрешенные операции.
  
- Аудит безопасности: SELinux обеспечивает расширенный аудит безопасности, регистрирующий действия субъектов и объектов в системе. Это позволяет администраторам системы отслеживать действия и обеспечивать соблюдение политик безопасности.
   Например, при нарушении политики безопасности SELinux регистрирует информацию об этом, что позволяет выявить потенциальные уязвимости или атаки на систему.
   
SELinux предоставляет гибкие возможности управления привилегиями и обеспечивает дополнительные слои безопасности в Linux. Однако, настройка и использваоние SELinux могут быть сложными и требуют понимания его концепций.
При принятии решения о доступе к ядру операционной системы необходимо проводить оценку рисков, поскольку это может иметь существенное влияние на безопасность и исправное функционирование системы в целом.  
Доступ к ядру операционной системы обычно предоставляет высокие привилегии. Это означает, что ошибочный доступ или внесение изменений в ядро может привести к серьезным проблемам безопасности или даже к критическим сбоям в работе системы.
Доступ к ядру может создать возможность для использования уязвимостей или эксплойтов со стороны злоумышленников, что может привести к компрометации системы.
В зависимости от контекста применения, такого как работа с конфиденциальными данными или важными сервисами, решения о доступе к ядру также могут оказывать влияние на соблюдение стандартов безопасности или регулирующих нормативных требований.
Применение принципов минимизации привилегий поможет уменьшить риски, связанные с доступом к ядру и избежать излишней привилегированности, что также относится к оценке рисков в контексте безопасности доступа к ядру.

## ПЗ
1.	Какая утилита даёт возможность запуск программ с наивысшими привилегиями и запросит дополнительное подтверждение? Sudo
2.	Какое ещё есть название у режима ядра? Привилегированный
3.	Возможно ли переключение между пользовательским режимом и режимом ядра? Если да, то даёт ли оно права на запуск программ с наивысшими привилегиями? Возможно, но полных прав не даёт.
4.	SELinux – это встроенный набор безопасности ядра? В настоящее время часто предустановлен, но изначально – нет.

В этом уроке мы узнали, что ОС работает в двух режимах: пользовательском и режиме ядра. В чём их различия и преимущества такого разделения. Узнали как происходит взаимодействия между этими двумя режимами. Познакомились с утилитой sudo.
Изучили инструменты дополнительной защиты ядра ОС на примере SELinux.  

В следующей серии: Процессы и системные вызовы.
